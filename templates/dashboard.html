{% extends "base.html" %}

{% block title %}PRISMA ‚Äì Indikator Harga Pintar Monitoring & Analitik{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-3 mb-4 border-bottom">
    <div>
        <h1 class="h2 text-gradient mb-1">
            <i class="fas fa-tachometer-alt me-2"></i>
            Dashboard
        </h1>
        <p class="text-muted mb-0">Dashboard Peramalan & Analitik IPH</p>
    </div>
</div>

<!-- Main Forecast Chart -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-primary me-2"></i>
                    Peramalan IPH & Data Historis
                </h5>
                <div class="d-flex align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <span class="badge bg-primary me-2" id="currentModelBadge">
                                <i class="fas fa-robot me-1"></i>
                                <span id="currentModelName">Loading...</span>
                            </span>
                            <span class="badge bg-info me-2" id="currentWeeksBadge">
                                <i class="fas fa-calendar-alt me-1"></i>
                                <span id="currentWeeksCount">0</span>
                                minggu
                            </span>
                        </div>
                    </div>
                </div>                
            </div>
            <div class="card-body p-0">
                <div id="forecastChart" data-chart-id="historicalChart" style="height: 500px;">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="text-center text-muted">
                            <div class="loading-spinner mb-3"></div>
                            <p class="mb-0">Memuat grafik peramalan...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Economic Alerts -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-warning shadow-sm">
            <div class="card-header bg-warning text-dark py-3 d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Peringatan & Notifikasi Ekonomi
                </h6>
                <button class="btn btn-sm btn-outline-dark" onclick="refreshAlerts()" id="refreshAlertsBtn">
                    <i class="fas fa-sync-alt me-1"></i>
                    Segarkan
                </button>
            </div>
            <div class="card-body" id="economicAlertsContainer">
                <div class="text-center py-3">
                    <div class="loading-spinner mb-2"></div>
                    <small class="text-muted">Memuat peringatan ekonomi...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistical Alerts Panel -->
<div class="row g-4 mb-4" id="statisticalAlertsPanel" style="display: none;">
    <div class="col-12">
        <div class="card border-info shadow-sm">
            <div class="card-header bg-info text-white py-3">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Peringatan Statistik
                </h6>
            </div>
            <div class="card-body" id="statisticalAlertsContainer">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>

<!-- Model Performance Analysis -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card shadow-sm h-100">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-tachometer-alt text-info me-2"></i>
                    Metrik Kinerja Model
                </h5>
            </div>
            <div class="card-body">
                <div id="modelMetricsContainer" data-metrics-id="modelPerformanceGrid">
                    <div class="text-center py-4">
                        <div class="loading-spinner mb-3"></div>
                        <p class="mb-0">Memuat metrik model...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Action Results Area -->
<div id="uploadResults"></div>
<div id="forecastResults"></div>

<!-- Forecast Data Table -->
<div class="row g-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table text-success me-2"></i>
                    Tabel Data Peramalan
                </h5>
                <div id="forecastTableBadges">
                    {% if data and data.current_forecast %}
                    <span class="badge bg-success">
                        {{ data.current_forecast.model_name.replace('_', ' ') }}
                    </span>
                    <span class="badge bg-info">
                        {{ data.current_forecast.weeks_forecasted }} minggu
                    </span>
                    {% else %}
                    <span class="badge bg-secondary">Tidak Ada Data</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-0">
                <!-- ‚úÖ ADD: Dynamic table container with ID -->
                <div id="forecastTable" class="table-responsive">
                    {% if data and data.current_forecast and data.current_forecast.data %}
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="border-0 py-3"><i class="fas fa-calendar me-2 text-muted"></i>Tanggal</th>
                                <th class="border-0 py-3"><i class="fas fa-chart-line me-2 text-muted"></i>Prediksi IPH</th>
                                <th class="border-0 py-3"><i class="fas fa-arrow-down me-2 text-muted"></i>Batas Bawah IPH</th>
                                <th class="border-0 py-3"><i class="fas fa-arrow-up me-2 text-muted"></i>Batas Atas IPH</th>
                                <th class="border-0 py-3"><i class="fas fa-expand-arrows-alt me-2 text-muted"></i>Rentang</th>
                                <th class="border-0 py-3"><i class="fas fa-info me-2 text-muted"></i>Kepercayaan</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data.current_forecast.data %}
                            <tr>
                                <td class="py-3">
                                    <strong>{{ item.Tanggal[:10] }}</strong>
                                </td>
                                <td class="py-3">
                                    <span class="badge bg-primary fs-6">{{ "%.3f"|format(item.Prediksi) }}</span>
                                </td>
                                <td class="py-3 text-danger">{{ "%.3f"|format(item.Batas_Bawah) }}</td>
                                <td class="py-3 text-success">{{ "%.3f"|format(item.Batas_Atas) }}</td>
                                <td class="py-3">{{ "%.3f"|format(item.Batas_Atas - item.Batas_Bawah) }}</td>
                                <td class="py-3">
                                    {% set confidence = 100 - ((item.Batas_Atas - item.Batas_Bawah) * 10) %}
                                    {% set confidence = confidence if confidence > 20 else 20 %}
                                    <div class="d-flex align-items-center">
                                        <small class="text-muted">{{ confidence|round }}%</small>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-table text-muted fa-3x mb-3"></i>
                        <p class="text-muted">Tidak ada data peramalan. Silakan buat peramalan terlebih dahulu.</p>
                        <button class="btn btn-primary" onclick="showForecastModal()">
                            <i class="fas fa-plus me-2"></i>Buat Peramalan
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Forecast Modal -->
<div class="modal fade" id="forecastModal" tabindex="-1" aria-labelledby="forecastModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="forecastModalLabel">
                    <i class="fas fa-chart-line me-2"></i>
                    Buat Peramalan IPH
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="forecastForm">
                    <div class="row g-3">
                        <!-- Model Selection - SIMPLIFIED -->
                        <div class="col-md-6">
                            <label for="forecastModel" class="form-label fw-bold">
                                <i class="fas fa-robot me-2 text-primary"></i>
                                Pilih Model
                            </label>
                            <select class="form-select" id="forecastModel" required>
                                <option value="Random_Forest">Random Forest</option>
                                <option value="XGBoost_Advanced">XGBoost Advanced</option>
                                <option value="LightGBM">LightGBM</option>
                                <option value="KNN">K-Nearest Neighbors</option>
                            </select>
                            <small class="form-text text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Pilih model machine learning untuk peramalan
                            </small>
                        </div>
                        
                        <!-- Forecast Period - SIMPLIFIED -->
                        <div class="col-md-6">
                            <label for="forecastWeeks" class="form-label fw-bold">
                                <i class="fas fa-calendar-alt me-2 text-info"></i>
                                Jangka Waktu
                            </label>
                            <select class="form-select" id="forecastWeeks" required>
                                <option value="4">4 Minggu (1 Bulan)</option>
                                <option value="8" selected>8 Minggu (2 Bulan)</option>
                                <option value="12">12 Minggu (3 Bulan)</option>
                            </select>
                            <small class="form-text text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Durasi peramalan yang diinginkan
                            </small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Batal
                </button>
                <button type="button" class="btn btn-primary" onclick="generateForecast()">
                    <i class="fas fa-play me-1"></i>
                    Buat Peramalan
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>generateForecast

function refreshForecastChart() {
    console.log('üîÑ Refreshing forecast chart...');
    
    const refreshBtn = document.getElementById('refreshChartBtn');
    if (refreshBtn) {
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Memuat...';
        refreshBtn.disabled = true;
    }
    
    if (window.dashboard) {
        window.dashboard.loadForecastChart().finally(() => {
            setTimeout(() => {
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Segarkan Grafik';
                    refreshBtn.disabled = false;
                }
                if (window.dashboard) {
                    window.dashboard.showAlert('Grafik peramalan berhasil disegarkan!', 'info');
                }
            }, 1000);
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    console.log('üìä Dashboard loaded');
    
    // Load forecast chart first
    loadForecastChart();

    // Load model metrics
    loadModelMetrics();
    
    // Load economic alerts
    loadEconomicAlerts();

    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

async function loadModelMetrics() {
    try {
        const response = await fetch('/api/model-comparison-chart');
        const data = await response.json();
        
        if (data.success && data.metrics) {
            renderModelMetrics(data.metrics);
        } else {
            document.getElementById('modelMetricsContainer').innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Tidak ada data metrik model tersedia
                </div>
            `;
        }
    } catch (error) {
        document.getElementById('modelMetricsContainer').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-times-circle me-2"></i>
                Error memuat metrik: ${error.message}
            </div>
        `;
    }
}

async function loadEconomicAlerts() {
    console.log('üîç Loading economic alerts...');
    
    try {
        const response = await fetch('/api/economic-alerts');
        console.log('üì° Response status:', response.status);
        
        const data = await response.json();
        console.log('üìä Response data:', data);
        
        if (data.success && data.alerts && data.alerts.length > 0) {
            console.log(`‚úÖ Got ${data.alerts.length} alerts`);
            renderEconomicAlerts(data.alerts, data);
        } else if (data.success && (!data.alerts || data.alerts.length === 0)) {
            console.log('‚ÑπÔ∏è No alerts available');
            document.getElementById('economicAlertsContainer').innerHTML = `
                <div class="alert alert-success border-0">
                    <i class="fas fa-check-circle me-2"></i>
                    Tidak ada peringatan aktif. Semua indikator dalam batas normal.
                </div>
            `;
        } else {
            console.warn('‚ö†Ô∏è API returned error:', data);
            document.getElementById('economicAlertsContainer').innerHTML = `
                <div class="alert alert-warning border-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error || 'Gagal memuat peringatan'}
                </div>
            `;
        }
    } catch (error) {
        console.error('‚ùå Fetch error:', error);
        document.getElementById('economicAlertsContainer').innerHTML = `
            <div class="alert alert-danger border-0">
                <i class="fas fa-times-circle me-2"></i>
                Error memuat peringatan: ${error.message}
            </div>
        `;
    }
}

async function loadForecastChart() {
    console.log('üìä Loading forecast chart...');
    
    try {
        const chartContainer = document.getElementById('forecastChart');
        
        // Show loading state
        chartContainer.innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center text-muted">
                    <div class="spinner-border text-primary mb-3"></div>
                    <p class="mb-0">Memuat grafik peramalan...</p>
                </div>
            </div>
        `;
        
        const response = await fetch('/api/forecast-chart-data');
        const data = await response.json();
        
        console.log('üìä Chart data received:', data);
        
        if (data.success && data.historical && data.historical.length > 0) {
            // Update metadata badges
            updateMetadataBadges(data.metadata);
            
            // Create chart traces
            const traces = [];
            
            // Historical data trace
            traces.push({
                x: data.historical.map(item => item.date),
                y: data.historical.map(item => item.value),
                type: 'scatter',
                mode: 'lines',
                name: 'üìä Data Historis',
                line: {
                    color: '#1f77b4',
                    width: 3
                },
                hovertemplate: '<b>%{x}</b><br>IPH: %{y:.3f}%<extra></extra>'
            });
            
            // Forecast data trace (if available)
            if (data.forecast && data.forecast.length > 0) {
                console.log(`‚úÖ Found ${data.forecast.length} forecast points`);
                traces.push({
                    x: data.forecast.map(item => item.date),
                    y: data.forecast.map(item => item.prediction),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'üîÆ Prediksi',
                    line: {
                        color: '#ff6b6b',
                        width: 4,
                        dash: 'dot'
                    },
                    marker: {
                        size: 8,
                        symbol: 'diamond',
                        color: '#ff6b6b',
                        line: {color: 'white', width: 2}
                    },
                    hovertemplate: '<b>%{x}</b><br>Prediksi: %{y:.3f}%<extra></extra>'
                });
                
                // Confidence interval (if bounds available)
                if (data.forecast[0].lower_bound !== undefined) {
                    const forecastDates = data.forecast.map(item => item.date);
                    const upperBounds = data.forecast.map(item => item.upper_bound);
                    const lowerBounds = data.forecast.map(item => item.lower_bound);
                    
                    traces.push({
                        x: [...forecastDates, ...forecastDates.reverse()],
                        y: [...upperBounds, ...lowerBounds.reverse()],
                        type: 'scatter',
                        mode: 'lines',
                        fill: 'toself',
                        fillcolor: 'rgba(255, 107, 107, 0.2)',
                        line: {color: 'rgba(255,255,255,0)'},
                        name: 'üìà Interval Kepercayaan',
                        showlegend: true,
                        hoverinfo: 'skip'
                    });
                }
            } else {
                console.log('No forecast data available');
            }

            
            // Chart layout
            const layout = {
                title: {
                    text: 'IPH Forecast & Historical Data',
                    x: 0.5,
                    font: {size: 16, color: '#2D3748'}
                },
                xaxis: {
                    title: 'Tanggal',
                    showgrid: true,
                    gridwidth: 1,
                    gridcolor: 'rgba(128,128,128,0.2)'
                },
                yaxis: {
                    title: 'IPH (%)',
                    showgrid: true,
                    gridwidth: 1,
                    gridcolor: 'rgba(128,128,128,0.2)',
                    zeroline: true,
                    zerolinewidth: 2,
                    zerolinecolor: 'rgba(128,128,128,0.5)'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                hovermode: 'x unified',
                showlegend: true,
                height: 500,
                margin: {l: 60, r: 60, t: 60, b: 60}
            };
            
            // Clear container and create chart
            chartContainer.innerHTML = '';
            Plotly.newPlot('forecastChart', traces, layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d']
            });
            
            console.log('‚úÖ Forecast chart loaded successfully');
            
        } else {
            // No data available
            chartContainer.innerHTML = `
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="text-center text-muted">
                        <i class="fas fa-chart-line fa-3x mb-3 text-secondary"></i>
                        <h5>Tidak Ada Data Chart</h5>
                        <p class="mb-0">${data.error || 'Silakan upload data historis terlebih dahulu'}</p>
                        <a href="/data-control" class="btn btn-primary mt-3">
                            <i class="fas fa-upload me-2"></i>Upload Data
                        </a>
                    </div>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('‚ùå Chart loading error:', error);
        document.getElementById('forecastChart').innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h5>Error Memuat Chart</h5>
                    <p class="mb-0">Error: ${error.message}</p>
                    <button class="btn btn-outline-danger mt-3" onclick="loadForecastChart()">
                        <i class="fas fa-redo me-2"></i>Coba Lagi
                    </button>
                </div>
            </div>
        `;
    }
}

function updateMetadataBadges(metadata) {
    console.log('üè∑Ô∏è Updating metadata badges:', metadata);
    
    if (metadata) {
        // Update model name badge
        const modelNameElement = document.getElementById('currentModelName');
        if (modelNameElement) {
            modelNameElement.textContent = metadata.model_name || 'No Model';
        }
        
        // Update weeks count badge
        const weeksCountElement = document.getElementById('currentWeeksCount');
        if (weeksCountElement) {
            weeksCountElement.textContent = metadata.weeks_forecasted || 0;
        }
        
        // Update badge colors based on forecast availability
        const modelBadge = document.getElementById('currentModelBadge');
        const weeksBadge = document.getElementById('currentWeeksBadge');
        
        if (metadata.has_forecast) {
            if (modelBadge) modelBadge.className = 'badge bg-success me-2';
            if (weeksBadge) weeksBadge.className = 'badge bg-info me-2';
        } else {
            if (modelBadge) modelBadge.className = 'badge bg-secondary me-2';
            if (weeksBadge) weeksBadge.className = 'badge bg-secondary me-2';
        }
    }
}

function renderEconomicAlerts(alerts, metadata) {
    console.log('üé® Rendering alerts:', alerts);
    
    if (!alerts || alerts.length === 0) {
        document.getElementById('economicAlertsContainer').innerHTML = `
            <div class="alert alert-success border-0">
                <i class="fas fa-check-circle me-2"></i>
                Tidak ada peringatan aktif. Semua indikator dalam batas normal.
            </div>
        `;
        return;
    }
    
    let html = '';
    
    alerts.forEach((alert, index) => {
        console.log(`üîÑ Processing alert ${index + 1}:`, alert);
        
        // Map severity to Bootstrap alert class
        let alertClass;
        switch(alert.severity) {
            case 'critical':
                alertClass = 'alert-danger';
                break;
            case 'warning':
                alertClass = 'alert-warning';
                break;
            case 'info':
                alertClass = 'alert-info';
                break;
            case 'success':
                alertClass = 'alert-success';
                break;
            default:
                alertClass = 'alert-primary';
        }
        
        // Map priority to badge color
        let priorityBadge;
        switch(alert.priority) {
            case 'critical':
                priorityBadge = 'danger';
                break;
            case 'high':
                priorityBadge = 'warning';
                break;
            case 'medium':
                priorityBadge = 'info';
                break;
            case 'low':
                priorityBadge = 'secondary';
                break;
            default:
                priorityBadge = 'primary';
        }
        
        html += `
            <div class="alert ${alertClass} border-0 py-3 mb-3">
                <div class="d-flex align-items-start">
                    <div class="me-3 mt-1">
                        <i class="fas ${alert.icon || 'fa-info-circle'} fa-lg"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="alert-heading mb-0">${alert.title || 'Peringatan'}</h6>
                            <span class="badge bg-${priorityBadge} ms-2">${(alert.priority || 'medium').toUpperCase()}</span>
                        </div>
                        <p class="mb-2">${alert.message || 'Tidak ada detail'}</p>
                        ${alert.detail ? `<small class="text-muted d-block mb-2"><strong>Detail:</strong> ${alert.detail}</small>` : ''}
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            Terdeteksi pada ${alert.date || 'Tanggal tidak tersedia'}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });
    
    // Add summary info
    if (metadata && metadata.data_period) {
        html += `
            <div class="mt-3 pt-3 border-top">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Berdasarkan ${metadata.data_period.records} data dari ${metadata.data_period.start} - ${metadata.data_period.end}
                    ${metadata.total_alerts > alerts.length ? ` | Menampilkan ${alerts.length} dari ${metadata.total_alerts} peringatan` : ''}
                </small>
            </div>
        `;
    }
    
    console.log('‚úÖ Setting HTML content');
    document.getElementById('economicAlertsContainer').innerHTML = html;
}

function refreshAlerts() {
    const refreshBtn = document.getElementById('refreshAlertsBtn');
    if (refreshBtn) {
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Memuat...';
        refreshBtn.disabled = true;
    }
    
    loadEconomicAlerts().finally(() => {
        setTimeout(() => {
            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Segarkan';
                refreshBtn.disabled = false;
            }
        }, 1000);
    });
}

function renderModelMetrics(metrics) {
    if (!metrics || metrics.length === 0) {
        document.getElementById('modelMetricsContainer').innerHTML = `
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Tidak ada data metrik model tersedia
            </div>
        `;
        return;
    }
    
    let html = '<div class="row g-3">';
    
    metrics.forEach((model, index) => {
        const isTopModel = index === 0;
        
        html += `
            <div class="col-lg-3 col-md-6">
                <div class="card border-${model.status_color} ${isTopModel ? 'border-2' : ''} h-100">
                    ${isTopModel ? '<div class="position-absolute top-0 end-0 m-2"><i class="fas fa-crown text-warning"></i></div>' : ''}
                    
                    <div class="card-header bg-${model.status_color} text-white py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0">${model.name}</h6>
                            <span class="badge bg-light text-${model.status_color}">
                                <i class="fas ${model.status_icon} me-1"></i>
                                ${model.status}
                            </span>
                        </div>
                    </div>
                    
                    <div class="card-body p-3">
                        <!-- Overall Score -->
                        <div class="text-center mb-3">
                            <div class="position-relative d-inline-block">
                                <svg width="60" height="60" class="progress-ring">
                                    <circle cx="30" cy="30" r="25" stroke="#e9ecef" stroke-width="4" fill="transparent"/>
                                    <circle cx="30" cy="30" r="25" stroke="currentColor" stroke-width="4" fill="transparent"
                                            stroke-dasharray="${2 * Math.PI * 25}" 
                                            stroke-dashoffset="${2 * Math.PI * 25 * (1 - model.overall_score / 100)}"
                                            class="text-${model.status_color}" style="transform: rotate(-90deg); transform-origin: center;"/>
                                </svg>
                                <div class="position-absolute top-50 start-50 translate-middle">
                                    <div class="fw-bold">${model.overall_score}%</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Metrics Grid -->
                        <div class="row g-2 text-center small">
                            <div class="col-6">
                                <div class="bg-light rounded p-2">
                                    <div class="fw-bold text-primary">${model.mae.toFixed(4)}</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">MAE</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-light rounded p-2">
                                    <div class="fw-bold text-info">${model.rmse.toFixed(4)}</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">RMSE</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-light rounded p-2">
                                    <div class="fw-bold text-success">${model.r2_score.toFixed(3)}</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">R¬≤</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-light rounded p-2">
                                    <div class="fw-bold text-warning">${model.mape.toFixed(2)}%</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">MAPE</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Info -->
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="fas fa-sync-alt me-1"></i>
                                ${model.training_count} kali training
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Add summary row
    html += `
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info border-0 py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-chart-line me-2"></i>
                                Ringkasan Performa Model
                            </h6>
                            <small class="text-muted">
                                Model terbaik: <strong>${metrics[0].name}</strong> dengan skor ${metrics[0].overall_score}%
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary fs-6">${metrics.length} Model Aktif</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('modelMetricsContainer').innerHTML = html;
}

// Sidebar action functions
function showModelComparison() {
    // Scroll ke grafik perbandingan model
    document.getElementById('modelComparisonChart').scrollIntoView({ behavior: 'smooth' });
}

function showDataAnalytics() {
    // Tampilkan modal analitik data atau navigasi ke tampilan analitik
    alert('Fitur Analitik Data - Segera hadir!');
}

function showAlertSettings() {
    // Tampilkan modal pengaturan alert
    alert('Fitur Pengaturan Alert - Segera hadir!');
}

function exportReports() {
    // Fungsi ekspor
    window.print();
}

function showDashboardSettings() {
    alert('Pengaturan Dashboard - Segera hadir!');
}

function showNotificationSettings() {
    alert('Pengaturan Notifikasi - Segera hadir!');
}

function exportDashboard() {
    window.print();
}

function exportDataToCSV() {
    if (window.dashboard) {
        window.dashboard.showExportModal();
    } else {
        // Fallback jika dashboard object belum ready
        setTimeout(() => {
            if (window.dashboard) {
                window.dashboard.showExportModal();
            } else {
                alert('Dashboard belum siap. Silakan tunggu dan coba lagi.');
            }
        }, 1000);
    }
}

// Forecast Modal Functions
function showForecastModal() {
    const modal = new bootstrap.Modal(document.getElementById('forecastModal'));
    loadAvailableModels();
    modal.show();
}

function loadAvailableModels() {
    const modelSelect = document.getElementById('forecastModel');
    modelSelect.innerHTML = '<option value="">Loading models...</option>';
    
    fetch('/api/available-models')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.models) {
                modelSelect.innerHTML = '<option value="">Pilih model...</option>';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = `${model.name} (MAE: ${model.mae.toFixed(4)})`;
                    if (model.is_best) {
                        option.textContent += ' - TERBAIK';
                        option.selected = true;
                    }
                    modelSelect.appendChild(option);
                });
            } else {
                modelSelect.innerHTML = '<option value="">Tidak ada model tersedia</option>';
            }
        })
        .catch(error => {
            console.error('Error loading models:', error);
            modelSelect.innerHTML = '<option value="">Error loading models</option>';
        });
}

function generateForecast() {
    const model = document.getElementById('forecastModel').value;
    const weeks = document.getElementById('forecastWeeks').value;
    
    if (!model || !weeks) {
        alert('Silakan pilih model dan jangka waktu peramalan');
        return;
    }
    
    const generateBtn = document.querySelector('#forecastModal .btn-primary');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Memproses...';
    generateBtn.disabled = true;
    
    const forecastData = {
        model_name: model,
        weeks: parseInt(weeks),
    };
    
    fetch('/api/generate-forecast', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(forecastData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('forecastModal'));
            modal.hide();
            
            // Show success message
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>‚úÖ Peramalan Berhasil!</strong>
                    <br>
                    <small>Model: <strong>${forecastData.model_name || 'Best'}</strong> | Minggu: <strong>${weeks}</strong></small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const resultsContainer = document.getElementById('forecastResults');

            if (resultsContainer) {
                resultsContainer.innerHTML = alertHtml;
            }

            //  REFRESH CHART DENGAN DELAY
            console.log('‚è≥ Waiting 1 second before refreshing chart...');
            setTimeout(() => {
                console.log('üîÑ Refreshing forecast chart...');
                loadForecastChart();
            }, 1000);
            
            //  REFRESH MODEL METRICS
            setTimeout(() => {
                console.log('üîÑ Refreshing model metrics...');
                loadModelMetrics();
            }, 1500);
            
        } else {
            alert('Error: ' + (data.message || 'Gagal membuat peramalan'));
        }
    })
    .catch(error => {
        console.error('Error generating forecast:', error);
        alert('Error: ' + error.message);
    })
    .finally(() => {
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    });
}

// Make functions globally available
window.showForecastModal = showForecastModal;
window.generateForecast = generateForecast;


document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Setting up ID compatibility layer...');
    
    // Map historicalChart ‚Üí forecastChart
    const forecastChart = document.getElementById('forecastChart');
    if (forecastChart && !document.getElementById('historicalChart')) {
        forecastChart.id = 'historicalChart';
        console.log('   ‚úÖ Mapped forecastChart ‚Üí historicalChart');
    }
    
    // Map modelPerformanceGrid ‚Üí modelMetricsContainer
    const modelMetrics = document.getElementById('modelMetricsContainer');
    if (modelMetrics && !document.getElementById('modelPerformanceGrid')) {
        modelMetrics.id = 'modelPerformanceGrid';
        console.log('   ‚úÖ Mapped modelMetricsContainer ‚Üí modelPerformanceGrid');
    }
    
    // Ensure forecastTable exists
    const forecastTable = document.getElementById('forecastTable');
    if (forecastTable) {
        console.log('   ‚úÖ forecastTable found');
    } else {
        console.warn('   ‚ö†Ô∏è forecastTable not found');
    }
    
    // Map statisticalAlerts
    const statsAlerts = document.getElementById('statisticalAlertsContainer');
    if (statsAlerts && !document.getElementById('statisticalAlerts')) {
        statsAlerts.id = 'statisticalAlerts';
        console.log('   ‚úÖ Mapped statisticalAlertsContainer ‚Üí statisticalAlerts');
    }
    
    console.log('‚úÖ Compatibility layer setup complete');
});

// ‚úÖ GLOBAL FUNCTIONS for sidebar links
function showForecastModal() {
    const modal = new bootstrap.Modal(document.getElementById('forecastModal'));
    modal.show();
}

function generateForecast() {
    const model = document.getElementById('forecastModel').value;
    const weeks = document.getElementById('forecastWeeks').value;
    
    console.log('üîÆ Generating forecast:', { model, weeks });
    
    // Show loading
    const btn = event.target;
    const originalHTML = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Memproses...';
    
    fetch('/api/generate-forecast', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            model_name: model,
            weeks: parseInt(weeks)
        })
    })
    .then(response => response.json())
    .then(data => {
        console.log('‚úÖ Forecast response:', data);
        
        if (data.success) {
            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('forecastModal')).hide();
            
            // Show success message
            alert('‚úÖ Peramalan berhasil dibuat! Dashboard akan diperbarui...');
            
            // Reload page to show new forecast
            window.location.reload();
        } else {
            alert('‚ùå Error: ' + (data.error || 'Gagal membuat peramalan'));
        }
    })
    .catch(error => {
        console.error('‚ùå Forecast error:', error);
        alert('‚ùå Terjadi kesalahan: ' + error.message);
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalHTML;
    });
}

function exportDataToCSV() {
    console.log('üì• Exporting data to CSV...');
    window.location.href = '/api/export-data';
}

function refreshAlerts() {
    console.log('üîÑ Refreshing alerts...');
    window.location.reload();
}
</script>
{% endblock %}