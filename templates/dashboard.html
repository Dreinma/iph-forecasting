{% extends "base.html" %}

{% block title %}PRISMA ‚Äì Indikator Harga Pintar Monitoring & Analitik{% endblock %}

{% block content %}
<style>
/* Custom CSS untuk Model Performance Layout - FORCE HORIZONTAL */
#modelMetricsContainer .row {
    display: flex !important;
    flex-direction: row !important;
    flex-wrap: nowrap !important;
    justify-content: space-between !important;
    align-items: stretch !important;
    gap: 1rem !important;
    margin: 0 !important;
}

#modelMetricsContainer .model-metrics-card {
    flex: 1 1 0 !important;
    min-width: 0 !important;
    max-width: none !important;
    width: auto !important;
    margin: 0 !important;
    padding: 0 !important;
}

/* Force horizontal layout on all screen sizes */
@media (max-width: 1200px) {
    #modelMetricsContainer .row {
        flex-wrap: wrap !important;
    }
    #modelMetricsContainer .model-metrics-card {
        flex: 0 0 calc(50% - 0.5rem) !important;
        max-width: calc(50% - 0.5rem) !important;
    }
}

@media (max-width: 768px) {
    #modelMetricsContainer .row {
        flex-direction: column !important;
    }
    #modelMetricsContainer .model-metrics-card {
        flex: 0 0 100% !important;
        max-width: 100% !important;
    }
}

/* Override Bootstrap grid completely */
#modelMetricsContainer .row > * {
    flex-shrink: 0 !important;
    width: auto !important;
    max-width: none !important;
    padding-right: 0 !important;
    padding-left: 0 !important;
}
</style>

<!-- Page Header -->
<div class="pb-3 mb-4 border-bottom">
    <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-3 gap-3">
        <div>
            <h1 class="h2 text-gradient mb-1">
                <i class="fas fa-tachometer-alt me-2"></i>
                Dashboard
            </h1>
            <p class="text-muted mb-0">Dashboard Peramalan & Analitik IPH</p>
        </div>
        <button type="button" class="btn btn-outline-secondary" onclick="refreshDashboard()">
            <i class="fas fa-refresh me-2"></i>
            <span class="d-none d-sm-inline">Refresh</span>
            <span class="d-sm-none"><i class="fas fa-refresh"></i></span>
        </button>
    </div>
    <div class="d-flex align-items-center gap-2">
        <button type="button" class="btn btn-primary btn-lg shadow-sm" onclick="showForecastModal()">
            <i class="fas fa-chart-line me-2"></i>
            <span class="d-none d-sm-inline">Buat Forecast</span>
            <span class="d-sm-none">Forecast</span>
        </button>
    </div>
</div>

<!-- Action Results Area - Moved to top -->
<div id="uploadResults"></div>
<div id="forecastResults"></div>

<!-- Main Forecast Chart -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-primary me-2"></i>
                    Peramalan IPH & Data Historis
                </h5>
                <div class="d-flex align-items-center">
                    <div class="d-flex align-items-center">
                        <div class="me-3">
                            <span class="badge bg-primary me-2" id="currentModelBadge">
                                <i class="fas fa-robot me-1"></i>
                                <span id="currentModelName">Memuat...</span>
                            </span>
                            <span class="badge bg-info me-2" id="currentWeeksBadge">
                                <i class="fas fa-calendar-alt me-1"></i>
                                <span id="currentWeeksCount">0</span>
                                minggu
                            </span>
                        </div>
                    </div>
                </div>                
            </div>
            <div class="card-body p-0">
                <div id="forecastChart" data-chart-id="historicalChart" style="height: 500px;">
                    <div class="d-flex justify-content-center align-items-center h-100">
                        <div class="text-center text-muted">
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">Memuat...</span>
                            </div>
                            <p class="mb-0">Memuat grafik peramalan...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Economic Alerts -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card border-warning shadow-sm">
            <div class="card-header bg-warning text-dark py-3 d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Peringatan & Notifikasi Ekonomi
                </h6>
            </div>
            <div class="card-body" id="economicAlertsContainer">
                <div class="text-center py-3">
                    <div class="spinner-border text-warning mb-2" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <small class="text-muted">Memuat peringatan ekonomi...</small>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Statistical Alerts Panel -->
<div class="row g-4 mb-4" id="statisticalAlertsPanel" style="display: none;">
    <div class="col-12">
        <div class="card border-info shadow-sm">
            <div class="card-header bg-info text-white py-3">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-bar me-2"></i>
                    Peringatan Statistik
                </h6>
            </div>
            <div class="card-body" id="statisticalAlertsContainer">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </div>
</div>


<!-- Forecast Data Table -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center py-3">
                <h5 class="card-title mb-4">
                    <i class="fas fa-table text-success me-2"></i>
                    Tabel Data Peramalan
                </h5>
                <div id="forecastTableBadges">
                    {% if data and data.current_forecast %}
                    <span class="badge bg-success">
                        {{ data.current_forecast.model_name.replace('_', ' ') }}
                    </span>
                    <span class="badge bg-info">
                        {{ data.current_forecast.weeks_forecasted }} minggu
                    </span>
                    {% else %}
                    <span class="badge bg-secondary">Tidak Ada Data</span>
                    {% endif %}
                </div>
            </div>
            <div class="card-body p-0">
                <!-- ‚úÖ ADD: Dynamic table container with ID -->
                <div id="forecastTable" class="table-responsive">
                    {% if data and data.current_forecast and data.current_forecast.data %}
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="border-0 py-3"><i class="fas fa-calendar me-2 text-muted"></i>Tanggal</th>
                                <th class="border-0 py-3"><i class="fas fa-chart-line me-2 text-muted"></i>Prediksi IPH</th>
                                <th class="border-0 py-3"><i class="fas fa-arrow-down me-2 text-muted"></i>Batas Bawah IPH</th>
                                <th class="border-0 py-3"><i class="fas fa-arrow-up me-2 text-muted"></i>Batas Atas IPH</th>
                                <th class="border-0 py-3"><i class="fas fa-expand-arrows-alt me-2 text-muted"></i>Rentang</th>
                                <th class="border-0 py-3"><i class="fas fa-info me-2 text-muted"></i>Kepercayaan</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in data.current_forecast.data %}
                            <tr>
                                <td class="py-3">
                                    <strong>{{ item.Tanggal[:10] }}</strong>
                                </td>
                                <td class="py-3">
                                    <span class="badge bg-primary fs-6">{{ "%.3f"|format(item.Prediksi) }}</span>
                                </td>
                                <td class="py-3 text-danger">{{ "%.3f"|format(item.Batas_Bawah) }}</td>
                                <td class="py-3 text-success">{{ "%.3f"|format(item.Batas_Atas) }}</td>
                                <td class="py-3">{{ "%.3f"|format(item.Batas_Atas - item.Batas_Bawah) }}</td>
                                <td class="py-3">
                                    {% set confidence = 100 - ((item.Batas_Atas - item.Batas_Bawah) * 10) %}
                                    {% set confidence = confidence if confidence > 20 else 20 %}
                                    <div class="d-flex align-items-center">
                                        <small class="text-muted">{{ confidence|round }}%</small>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% else %}
                    <div class="text-center py-5">
                        <i class="fas fa-table text-muted fa-3x mb-3"></i>
                        <p class="text-muted">Tidak ada data peramalan. Silakan buat peramalan terlebih dahulu.</p>
                        <button class="btn btn-primary" onclick="showForecastModal()">
                            <i class="fas fa-plus me-2"></i>Buat Peramalan
                        </button>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Forecast Modal -->
<div class="modal fade" id="forecastModal" tabindex="-1" aria-labelledby="forecastModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="forecastModalLabel">
                    <i class="fas fa-chart-line me-2"></i>
                    Buat Peramalan IPH
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="forecastForm">
                    <div class="row g-3">
                        <!-- Model Selection - SIMPLIFIED -->
                        <div class="col-md-6">
                            <label for="forecastModel" class="form-label fw-bold">
                                <i class="fas fa-robot me-2 text-primary"></i>
                                Pilih Model
                            </label>
                            <select class="form-select" id="forecastModel" required>
                                <option value="Random_Forest">Random Forest</option>
                                <option value="XGBoost_Advanced">XGBoost Advanced</option>
                                <option value="LightGBM">LightGBM</option>
                                <option value="KNN">K-Nearest Neighbors</option>
                            </select>
                            <small class="form-text text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Pilih model machine learning untuk peramalan
                            </small>
                        </div>
                        
                        <!-- Forecast Period - SIMPLIFIED -->
                        <div class="col-md-6">
                            <label for="forecastWeeks" class="form-label fw-bold">
                                <i class="fas fa-calendar-alt me-2 text-info"></i>
                                Jangka Waktu
                            </label>
                            <select class="form-select" id="forecastWeeks" required>
                                <option value="4">4 Minggu (1 Bulan)</option>
                                <option value="8" selected>8 Minggu (2 Bulan)</option>
                                <option value="12">12 Minggu (3 Bulan)</option>
                            </select>
                            <small class="form-text text-muted d-block mt-2">
                                <i class="fas fa-info-circle me-1"></i>
                                Durasi peramalan yang diinginkan
                            </small>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Batal
                </button>
                <button type="button" class="btn btn-primary" onclick="generateForecast()">
                    <i class="fas fa-play me-1"></i>
                    Buat Peramalan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Model differences summary (compact) -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0">
                    <i class="fas fa-balance-scale text-info me-2"></i>
                    Perbedaan Model
                </h5>
            </div>
            <div class="card-body" id="modelDifferencesContainer">
                <div class="text-center py-3">
                    <div class="spinner-border text-info mb-2" role="status"></div>
                    <div class="text-muted">Memuat ringkasan perbedaan model...</div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>generateForecast

function refreshForecastChart() {
    console.log('üîÑ Refreshing forecast chart...');
    
    const refreshBtn = document.getElementById('refreshChartBtn');
    if (refreshBtn) {
        refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Memuat...';
        refreshBtn.disabled = true;
    }
    
    if (window.dashboard) {
        window.dashboard.loadForecastChart().finally(() => {
            setTimeout(() => {
                if (refreshBtn) {
                    refreshBtn.innerHTML = '<i class="fas fa-sync-alt me-1"></i>Segarkan Grafik';
                    refreshBtn.disabled = false;
                }
                if (window.dashboard) {
                    window.dashboard.showAlert('Grafik peramalan berhasil disegarkan!', 'info');
                }
            }, 1000);
        });
    }
}

document.addEventListener('DOMContentLoaded', function() {
    // Load forecast chart first
    loadForecastChart();

    // Load model differences (compact summary)
    loadModelMetrics();
    
    // Load economic alerts
    loadEconomicAlerts();
    
    // Load forecast table
    loadForecastTable();

    // Initialize tooltips
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

async function loadModelMetrics() {
    try {
        const response = await fetch('/api/dashboard/model-performance');
        const data = await response.json();
        
        if (data.success && data.models) {
            const metrics = data.models.map(model => ({
                name: model.name,
                mae: model.mae,
                rmse: model.rmse,
                r2_score: model.r2,
                mape: model.mape,
                status: model.status,
                training_count: model.training_count || 1
            }));
            renderModelDifferences(metrics);
        } else {
            const container = document.getElementById('modelMetricsContainer') || document.getElementById('modelPerformanceGrid');
            if (container) {
                container.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        ${data.message || 'Tidak ada data metrik model tersedia'}
                    </div>
                `;
            }
        }
    } catch (error) {
        const container = document.getElementById('modelDifferencesContainer');
        if (container) {
            container.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>
                    Error memuat metrik: ${error.message}
                </div>
            `;
        }
    }
}

async function loadEconomicAlerts() {
    console.log('üîç Loading economic alerts...');
    
    try {
        const response = await fetch('/api/economic-alerts');
        console.log('üì° Response status:', response.status);
        
        const data = await response.json();
        console.log('üìä Response data:', data);
        
        if (data.success && data.alerts && data.alerts.length > 0) {
            console.log(`‚úÖ Got ${data.alerts.length} alerts`);
            renderEconomicAlerts(data.alerts, data);
        } else if (data.success && (!data.alerts || data.alerts.length === 0)) {
            console.log('‚ÑπÔ∏è No alerts available');
            document.getElementById('economicAlertsContainer').innerHTML = `
                <div class="alert alert-success border-0">
                    <i class="fas fa-check-circle me-2"></i>
                    Tidak ada peringatan aktif. Semua indikator dalam batas normal.
                </div>
            `;
        } else {
            console.warn('‚ö†Ô∏è API returned error:', data);
            document.getElementById('economicAlertsContainer').innerHTML = `
                <div class="alert alert-warning border-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${data.error || 'Gagal memuat peringatan'}
                </div>
            `;
        }
    } catch (error) {
        console.error('‚ùå Fetch error:', error);
        document.getElementById('economicAlertsContainer').innerHTML = `
            <div class="alert alert-danger border-0">
                <i class="fas fa-times-circle me-2"></i>
                Error memuat peringatan: ${error.message}
            </div>
        `;
    }
}

async function loadForecastChart() {
    console.log('üìä Loading forecast chart...');
    
    try {
        const chartContainer = document.getElementById('forecastChart');
        
        // Show loading state
        chartContainer.innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center text-muted">
                    <div class="spinner-border text-primary mb-3"></div>
                    <p class="mb-0">Memuat grafik peramalan...</p>
                </div>
            </div>
        `;
        
        // Add cache busting to ensure fresh data
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/forecast-chart-data?t=${timestamp}`);
        const data = await response.json();
        
        console.log('üìä Chart data received:', data);
        console.log('üìä Metadata:', data.metadata);
        console.log('üìä Forecast data points:', data.forecast ? data.forecast.length : 0);
        
        if (data.success && data.historical && data.historical.length > 0) {
            // Update metadata badges
            console.log('üè∑Ô∏è Updating metadata badges with:', data.metadata);
            updateMetadataBadges(data.metadata);
            
            // Create chart traces
            const traces = [];
            
            // Historical data trace
            traces.push({
                x: data.historical.map(item => item.date),
                y: data.historical.map(item => item.value),
                type: 'scatter',
                mode: 'lines',
                name: 'üìä Data Historis',
                line: {
                    color: '#1f77b4',
                    width: 3
                },
                hovertemplate: '<b>%{x}</b><br>IPH: %{y:.3f}%<extra></extra>'
            });
            
            // Forecast data trace (if available)
            if (data.forecast && data.forecast.length > 0) {
                console.log(`‚úÖ Found ${data.forecast.length} forecast points`);
                // Compute per-point confidence derived from range diversity
                const ranges = data.forecast.map(it => (it.upper_bound ?? 0) - (it.lower_bound ?? 0));
                const maxRange = Math.max(...ranges);
                const minRange = Math.min(...ranges);
                const backendConfValues = (data.forecast.map(it => typeof it.confidence === 'number' ? it.confidence : null).filter(v => v !== null));
                const backendHasVariance = backendConfValues.some(v => Math.abs(v - backendConfValues[0]) > 1e-6);

                const forecastCustomData = data.forecast.map((item, idx) => {
                    const range = ranges[idx];
                    // If backend confidence has no variance (semua sama), gunakan derivasi dari lebar interval
                    let conf = (backendHasVariance && typeof item.confidence === 'number') ? item.confidence : (maxRange > 0 ? 1 - (range / maxRange) * 0.8 : 0.8);
                    conf = Math.min(0.98, Math.max(0.2, conf));
                    return [item.lower_bound ?? null, item.upper_bound ?? null, conf];
                });
                traces.push({
                    x: data.forecast.map(item => item.date),
                    y: data.forecast.map(item => item.prediction),
                    type: 'scatter',
                    mode: 'lines+markers',
                    name: 'üîÆ Prediksi',
                    line: {
                        color: '#ff6b6b',
                        width: 4,
                        dash: 'dot'
                    },
                    marker: {
                        size: 8,
                        symbol: 'diamond',
                        color: '#ff6b6b',
                        line: {color: 'white', width: 2}
                    },
                    customdata: forecastCustomData,
                    hovertemplate: '<b>%{x}</b>' +
                                   '<br>Prediksi: %{y:.3f}%' +
                                   '<br>Confidence: %{customdata[2]:.1%}' +
                                   '<br>Batas Bawah: %{customdata[0]:.3f}%' +
                                   '<br>Batas Atas: %{customdata[1]:.3f}%' +
                                   '<extra></extra>'
                });
                
                // Confidence interval (if bounds available)
                if (data.forecast[0].lower_bound !== undefined) {
                    const forecastDates = data.forecast.map(item => item.date);
                    const upperBounds = data.forecast.map(item => item.upper_bound);
                    const lowerBounds = data.forecast.map(item => item.lower_bound);
                    
                    traces.push({
                        x: [...forecastDates, ...forecastDates.reverse()],
                        y: [...upperBounds, ...lowerBounds.reverse()],
                        type: 'scatter',
                        mode: 'lines',
                        fill: 'toself',
                        fillcolor: 'rgba(255, 107, 107, 0.2)',
                        line: {color: 'rgba(255,255,255,0)'},
                        name: 'üìà Interval Kepercayaan',
                        showlegend: true,
                        hoverinfo: 'skip'
                    });
                }
            } else {
                console.log('No forecast data available');
            }

            
            // Chart layout
            const layout = {
                title: {
                    text: 'Peramalan IPH & Data Historis',
                    x: 0.5,
                    font: {size: 16, color: '#2D3748'}
                },
                xaxis: {
                    title: 'Tanggal',
                    showgrid: true,
                    gridwidth: 1,
                    gridcolor: 'rgba(128,128,128,0.2)'
                },
                yaxis: {
                    title: 'IPH (%)',
                    showgrid: true,
                    gridwidth: 1,
                    gridcolor: 'rgba(128,128,128,0.2)',
                    zeroline: true,
                    zerolinewidth: 2,
                    zerolinecolor: 'rgba(128,128,128,0.5)'
                },
                plot_bgcolor: 'rgba(0,0,0,0)',
                paper_bgcolor: 'rgba(0,0,0,0)',
                hovermode: 'x unified',
                showlegend: true,
                height: 500,
                margin: {l: 60, r: 60, t: 60, b: 60}
            };
            
            // Clear container and create chart
            chartContainer.innerHTML = '';
            Plotly.newPlot('forecastChart', traces, layout, {
                responsive: true,
                displayModeBar: true,
                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d', 'autoScale2d']
            });
            
            console.log('‚úÖ Forecast chart loaded successfully');
            
        } else {
            // No data available
            chartContainer.innerHTML = `
                <div class="d-flex justify-content-center align-items-center h-100">
                    <div class="text-center text-muted">
                        <i class="fas fa-chart-line fa-3x mb-3 text-secondary"></i>
                        <h5>Tidak Ada Data Chart</h5>
                        <p class="mb-0">${data.error || 'Silakan hubungi admin untuk upload data historis'}</p>
                    </div>
                </div>
            `;
        }
        
    } catch (error) {
        console.error('‚ùå Chart loading error:', error);
        document.getElementById('forecastChart').innerHTML = `
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="text-center text-danger">
                    <i class="fas fa-exclamation-triangle fa-3x mb-3"></i>
                    <h5>Gagal Memuat Grafik</h5>
                    <p class="mb-0">Kesalahan: ${error.message}</p>
                    <button class="btn btn-outline-danger mt-3" onclick="loadForecastChart()">
                        <i class="fas fa-redo me-2"></i>Coba Lagi
                    </button>
                </div>
            </div>
        `;
    }
}

function updateMetadataBadges(metadata) {
    console.log('üè∑Ô∏è Updating metadata badges:', metadata);
    
    if (metadata) {
        // Update model name badge
        const modelNameElement = document.getElementById('currentModelName');
        if (modelNameElement) {
            modelNameElement.textContent = metadata.model_name || 'No Model';
        }
        
        // Update weeks count badge
        const weeksCountElement = document.getElementById('currentWeeksCount');
        if (weeksCountElement) {
            weeksCountElement.textContent = metadata.weeks_forecasted || 0;
        }
        
        // Update badge colors based on forecast availability
        const modelBadge = document.getElementById('currentModelBadge');
        const weeksBadge = document.getElementById('currentWeeksBadge');
        
        if (metadata.has_forecast) {
            if (modelBadge) modelBadge.className = 'badge bg-success me-2';
            if (weeksBadge) weeksBadge.className = 'badge bg-info me-2';
        } else {
            if (modelBadge) modelBadge.className = 'badge bg-secondary me-2';
            if (weeksBadge) weeksBadge.className = 'badge bg-secondary me-2';
        }
    }
}

function renderEconomicAlerts(alerts, metadata) {
    console.log('üé® Rendering alerts:', alerts);
    
    if (!alerts || alerts.length === 0) {
        document.getElementById('economicAlertsContainer').innerHTML = `
            <div class="alert alert-success border-0">
                <i class="fas fa-check-circle me-2"></i>
                Tidak ada peringatan aktif. Semua indikator dalam batas normal.
            </div>
        `;
        return;
    }
    
    let html = '';
    
    alerts.forEach((alert, index) => {
        console.log(`üîÑ Processing alert ${index + 1}:`, alert);
        
        // Map severity to Bootstrap alert class
        let alertClass;
        switch(alert.severity) {
            case 'critical':
                alertClass = 'alert-danger';
                break;
            case 'warning':
                alertClass = 'alert-warning';
                break;
            case 'info':
                alertClass = 'alert-info';
                break;
            case 'success':
                alertClass = 'alert-success';
                break;
            default:
                alertClass = 'alert-primary';
        }
        
        // Map priority to badge color
        let priorityBadge;
        switch(alert.priority) {
            case 'critical':
                priorityBadge = 'danger';
                break;
            case 'high':
                priorityBadge = 'warning';
                break;
            case 'medium':
                priorityBadge = 'info';
                break;
            case 'low':
                priorityBadge = 'secondary';
                break;
            default:
                priorityBadge = 'primary';
        }
        
        html += `
            <div class="alert ${alertClass} border-0 py-3 mb-3">
                <div class="d-flex align-items-start">
                    <div class="me-3 mt-1">
                        <i class="fas ${alert.icon || 'fa-info-circle'} fa-lg"></i>
                    </div>
                    <div class="flex-grow-1">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="alert-heading mb-0">${alert.title || 'Peringatan'}</h6>
                            <span class="badge bg-${priorityBadge} ms-2">${(alert.priority || 'medium').toUpperCase()}</span>
                        </div>
                        <p class="mb-2">${alert.message || 'Tidak ada detail'}</p>
                        ${alert.detail ? `<small class="text-muted d-block mb-2"><strong>Detail:</strong> ${alert.detail}</small>` : ''}
                        <small class="text-muted">
                            <i class="fas fa-calendar me-1"></i>
                            Terdeteksi pada ${alert.date || 'Tanggal tidak tersedia'}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });
    
    // Add summary info
    if (metadata && metadata.data_period) {
        html += `
            <div class="mt-3 pt-3 border-top">
                <small class="text-muted">
                    <i class="fas fa-info-circle me-1"></i>
                    Berdasarkan ${metadata.data_period.records} data dari ${metadata.data_period.start} - ${metadata.data_period.end}
                    ${metadata.total_alerts > alerts.length ? ` | Menampilkan ${alerts.length} dari ${metadata.total_alerts} peringatan` : ''}
                </small>
            </div>
        `;
    }
    
    console.log('‚úÖ Setting HTML content');
    document.getElementById('economicAlertsContainer').innerHTML = html;
}


function renderModelMetrics(metrics) {
    if (!metrics || metrics.length === 0) {
        const container = document.getElementById('modelDifferencesContainer');
        if (container) {
            container.innerHTML = `
                <div class="alert alert-warning">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Tidak ada data metrik model tersedia
                </div>
            `;
        }
        return;
    }
    
    let html = '<div class="row g-3 model-metrics-row" style="display: flex !important; flex-direction: row !important; flex-wrap: nowrap !important; justify-content: space-between !important; align-items: stretch !important; gap: 1rem !important;">';
    
    metrics.forEach((model, index) => {
        const isTopModel = index === 0;
        
        html += `
            <div class="model-metrics-card" style="flex: 1 1 0 !important; min-width: 0 !important; max-width: none !important; width: auto !important;">
                <div class="card border-${model.status_color} ${isTopModel ? 'border-3 shadow-lg' : 'border-2'} h-100">
                    ${isTopModel ? '<div class="position-absolute top-0 end-0 m-2"><i class="fas fa-crown text-warning fa-lg"></i></div>' : ''}
                    
                    <div class="card-header bg-${model.status_color} text-white py-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="mb-0 fw-bold">${model.name.replace('_', ' ')}</h6>
                            <span class="badge bg-light text-${model.status_color} px-2 py-1">
                                <i class="fas ${model.status_icon} me-1"></i>
                                ${model.status}
                            </span>
                        </div>
                    </div>
                    
                    <div class="card-body p-3">
                        <!-- Overall Score -->
                        <div class="text-center mb-3">
                            <div class="position-relative d-inline-block">
                                <svg width="60" height="60" class="progress-ring">
                                    <circle cx="30" cy="30" r="25" stroke="#e9ecef" stroke-width="4" fill="transparent"/>
                                    <circle cx="30" cy="30" r="25" stroke="currentColor" stroke-width="4" fill="transparent"
                                            stroke-dasharray="${2 * Math.PI * 25}" 
                                            stroke-dashoffset="${2 * Math.PI * 25 * (1 - model.overall_score / 100)}"
                                            class="text-${model.status_color}" style="transform: rotate(-90deg); transform-origin: center;"/>
                                </svg>
                                <div class="position-absolute top-50 start-50 translate-middle">
                                    <div class="fw-bold">${model.overall_score}%</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Metrics Grid -->
                        <div class="row g-2 text-center small">
                            <div class="col-6">
                                <div class="bg-light rounded p-2">
                                    <div class="fw-bold text-primary">${model.mae.toFixed(2)}</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">MAE</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-light rounded p-2">
                                    <div class="fw-bold text-info">${model.rmse.toFixed(2)}</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">RMSE</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-light rounded p-2">
                                    <div class="fw-bold text-success">${model.r2_score.toFixed(2)}</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">R¬≤</div>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="bg-light rounded p-2">
                                    <div class="fw-bold text-warning">${model.mape.toFixed(2)}%</div>
                                    <div class="text-muted" style="font-size: 0.7rem;">MAPE</div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Additional Info -->
                        <div class="mt-3 text-center">
                            <small class="text-muted">
                                <i class="fas fa-sync-alt me-1"></i>
                                ${model.training_count} kali training
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    html += '</div>';
    
    // Add summary row
    html += `
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info border-0 py-3">
                    <div class="d-flex align-items-center justify-content-between">
                        <div>
                            <h6 class="mb-1">
                                <i class="fas fa-chart-line me-2"></i>
                                Ringkasan Performa Model
                            </h6>
                            <small class="text-muted">
                                Model terbaik: <strong>${metrics[0].name.replace('_', ' ')}</strong> dengan skor ${metrics[0].overall_score}%
                            </small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-primary fs-6">${metrics.length} Model Aktif</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    const container = document.getElementById('modelMetricsContainer') || document.getElementById('modelPerformanceGrid');
    if (container) {
        container.innerHTML = html;
    }
    
    // Show insights container after metrics are loaded
    const insightsContainer = document.getElementById('modelInsightsContainer');
    if (insightsContainer) {
        insightsContainer.style.display = 'block';
    }
}

function renderModelDifferences(metrics) {
    const container = document.getElementById('modelDifferencesContainer');
    if (!container) return;

    if (!metrics || metrics.length === 0) {
        container.innerHTML = `
            <div class="alert alert-warning border-0">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Tidak ada data perbandingan model.
            </div>
        `;
        return;
    }

    const descriptions = {
        'Random_Forest': {
            title: 'Random Forest',
            icon: 'fas fa-tree',
            summary: 'Ensemble decision trees yang robust terhadap noise',
            highlight: 'Cocok untuk data tabular, jarang overfit'
        },
        'XGBoost_Advanced': {
            title: 'XGBoost Advanced',
            icon: 'fas fa-rocket',
            summary: 'Gradient boosting dengan regularisasi kuat',
            highlight: 'Akurasi tinggi pada pola kompleks'
        },
        'LightGBM': {
            title: 'LightGBM',
            icon: 'fas fa-bolt',
            summary: 'Gradient boosting berbasis histogram',
            highlight: 'Sangat cepat pada data besar'
        },
        'KNN': {
            title: 'K-Nearest Neighbors',
            icon: 'fas fa-project-diagram',
            summary: 'Prediksi berdasarkan tetangga terdekat',
            highlight: 'Non-parametrik, sederhana dan intuitif'
        }
    };

    // Sort by MAE (best first)
    const sortedMetrics = [...metrics].sort((a, b) => (a.mae || Infinity) - (b.mae || Infinity));

    let html = '<div class="row g-3">';
    
    sortedMetrics.forEach((m, index) => {
        const key = m.name;
        const info = descriptions[key] || { 
            title: m.name.replace('_',' '), 
            icon: 'fas fa-chart-line',
            summary: 'Model machine learning untuk peramalan',
            highlight: 'Tersedia untuk forecasting'
        };
        
        const isBest = index === 0;
        const trainedBadge = '';
        const maeBadge = m.mae ? `<span class="badge bg-primary me-1" style="font-size: 0.65rem;">MAE: ${m.mae.toFixed(3)}</span>` : '';
        const r2Badge = m.r2_score ? `<span class="badge bg-success me-1" style="font-size: 0.65rem;">R¬≤: ${m.r2_score.toFixed(2)}</span>` : '';
        
        html += `
            <div class="col-md-6 col-lg-3">
                <div class="card h-100 border-${isBest ? 'primary border-2' : 'light'} shadow-sm ${isBest ? 'bg-light' : ''}">
                    ${isBest ? '<div class="position-absolute top-0 end-0 m-2"><i class="fas fa-star text-warning"></i></div>' : ''}
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center mb-2">
                            <i class="${info.icon} text-primary me-2"></i>
                            <h6 class="card-title mb-0 fw-bold">${info.title}</h6>
                            ${trainedBadge}
                        </div>
                        <p class="card-text small text-muted mb-2" style="font-size: 0.75rem; line-height: 1.4;">
                            ${info.summary}
                        </p>
                        <div class="mb-2">
                            <small class="text-dark fw-medium" style="font-size: 0.7rem;">
                                <i class="fas fa-check-circle text-success me-1"></i>${info.highlight}
                            </small>
                        </div>
                        <div class="mt-2 pt-2 border-top">
                            ${maeBadge}${r2Badge}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

// Load Forecast Table Function
async function loadForecastTable() {
    console.log('üìä Loading forecast table...');
    
    try {
        const forecastTableContainer = document.getElementById('forecastTable');
        const forecastTableBadges = document.getElementById('forecastTableBadges');
        
        if (!forecastTableContainer) {
            console.warn('‚ö†Ô∏è Forecast table container not found');
            return;
        }
        
        // Show loading state
        forecastTableContainer.innerHTML = `
            <div class="d-flex justify-content-center align-items-center py-4">
                <div class="text-center text-muted">
                    <div class="spinner-border text-primary mb-3" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mb-0">Memuat tabel peramalan...</p>
                </div>
            </div>
        `;
        
        // Add cache busting
        const timestamp = new Date().getTime();
        const response = await fetch(`/api/forecast-chart-data?t=${timestamp}`);
        const data = await response.json();
        
        console.log('üìä Forecast table data received:', data);
        
        if (data.success && data.forecast && data.forecast.length > 0) {
            // Update badges
            if (forecastTableBadges) {
                forecastTableBadges.innerHTML = `
                    <span class="badge bg-success">
                        ${data.metadata.model_name.replace('_', ' ')}
                    </span>
                    <span class="badge bg-info">
                        ${data.metadata.weeks_forecasted} minggu
                    </span>
                `;
            }
            
            // Create table
            let tableHtml = `
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="border-0 py-3"><i class="fas fa-calendar me-2 text-muted"></i>Tanggal</th>
                            <th class="border-0 py-3"><i class="fas fa-chart-line me-2 text-muted"></i>Prediksi IPH</th>
                            <th class="border-0 py-3"><i class="fas fa-arrow-down me-2 text-muted"></i>Batas Bawah</th>
                            <th class="border-0 py-3"><i class="fas fa-arrow-up me-2 text-muted"></i>Batas Atas</th>
                            <th class="border-0 py-3"><i class="fas fa-percentage me-2 text-muted"></i>Confidence</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Recompute confidence based on relative interval width to avoid nilai sama
            const ranges = data.forecast.map(it => (it.upper_bound ?? 0) - (it.lower_bound ?? 0));
            const maxRange = Math.max(...ranges);
            const minRange = Math.min(...ranges);

            data.forecast.forEach((item, index) => {
                const range = ranges[index];
                let conf = (maxRange > 0) ? 1 - (range / maxRange) * 0.8 : 0.8;
                conf = Math.min(0.98, Math.max(0.2, conf));
                const confidencePct = (conf * 100).toFixed(1);
                const predictionClass = item.prediction >= 0 ? 'text-success' : 'text-danger';
                const confidenceClass = conf > 0.7 ? 'text-success' : (conf > 0.5 ? 'text-warning' : 'text-danger');
                
                tableHtml += `
                    <tr>
                        <td class="py-3">
                            <div class="fw-medium">${item.date}</div>
                            <small class="text-muted">Minggu ${index + 1}</small>
                        </td>
                        <td class="py-3">
                            <span class="fw-bold ${predictionClass}">${item.prediction.toFixed(2)}%</span>
                        </td>
                        <td class="py-3">
                            <span class="text-danger">${item.lower_bound.toFixed(2)}%</span>
                        </td>
                        <td class="py-3">
                            <span class="text-success">${item.upper_bound.toFixed(2)}%</span>
                        </td>
                        <td class="py-3">
                            <span class="fw-medium ${confidenceClass}">${confidencePct}%</span>
                        </td>
                    </tr>
                `;
            });
            
            tableHtml += `
                    </tbody>
                </table>
            `;
            
            forecastTableContainer.innerHTML = tableHtml;
            console.log('‚úÖ Forecast table loaded successfully');
            
        } else {
            // No forecast data
            forecastTableContainer.innerHTML = `
                <div class="text-center py-5">
                    <div class="text-muted">
                        <i class="fas fa-chart-line fa-3x mb-3"></i>
                        <h6 class="mb-2">Belum Ada Data Peramalan</h6>
                        <p class="mb-0">Gunakan fitur peramalan di dashboard untuk membuat peramalan baru</p>
                    </div>
                </div>
            `;
            
            if (forecastTableBadges) {
                forecastTableBadges.innerHTML = '<span class="badge bg-secondary">Tidak Ada Data</span>';
            }
        }
        
    } catch (error) {
        console.error('‚ùå Error loading forecast table:', error);
        const forecastTableContainer = document.getElementById('forecastTable');
        if (forecastTableContainer) {
            forecastTableContainer.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error memuat tabel peramalan: ${error.message}
                </div>
            `;
        }
    }
}

// Sidebar action functions
function showModelComparison() {
    // Scroll ke grafik perbandingan model
    document.getElementById('modelComparisonChart').scrollIntoView({ behavior: 'smooth' });
}

function showDataAnalytics() {
    // Tampilkan modal analitik data atau navigasi ke tampilan analitik
    alert('Fitur Analitik Data - Segera hadir!');
}

function showAlertSettings() {
    // Tampilkan modal pengaturan alert
    alert('Fitur Pengaturan Alert - Segera hadir!');
}

function exportReports() {
    // Fungsi ekspor
    window.print();
}

function showDashboardSettings() {
    alert('Pengaturan Dashboard - Segera hadir!');
}

function showNotificationSettings() {
    alert('Pengaturan Notifikasi - Segera hadir!');
}

function exportDashboard() {
    window.print();
}

function exportDataToCSV() {
    if (window.dashboard) {
        window.dashboard.showExportModal();
    } else {
        // Fallback jika dashboard object belum ready
        setTimeout(() => {
            if (window.dashboard) {
                window.dashboard.showExportModal();
            } else {
                alert('Dashboard belum siap. Silakan tunggu dan coba lagi.');
            }
        }, 1000);
    }
}

// Forecast Modal Functions
function showForecastModal() {
    const modal = new bootstrap.Modal(document.getElementById('forecastModal'));
    loadAvailableModels();
    modal.show();
}

function loadAvailableModels() {
    const modelSelect = document.getElementById('forecastModel');
            modelSelect.innerHTML = '<option value="">Memuat model...</option>';
    
    fetch('/api/available-models')
        .then(response => response.json())
        .then(data => {
            if (data.success && data.models) {
                modelSelect.innerHTML = '<option value="">Pilih model...</option>';
                data.models.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.name;
                    option.textContent = `${model.name} (MAE: ${model.mae.toFixed(4)})`;
                    if (model.is_best) {
                        option.textContent += ' - TERBAIK';
                        option.selected = true;
                    }
                    modelSelect.appendChild(option);
                });
            } else {
                modelSelect.innerHTML = '<option value="">Tidak ada model tersedia</option>';
            }
        })
        .catch(error => {
            console.error('Error loading models:', error);
            modelSelect.innerHTML = '<option value="">Gagal memuat model</option>';
        });
}

function generateForecast() {
    const model = document.getElementById('forecastModel').value;
    const weeks = document.getElementById('forecastWeeks').value;
    
    if (!model || !weeks) {
        alert('Silakan pilih model dan jangka waktu peramalan');
        return;
    }
    
    const generateBtn = document.querySelector('#forecastModal .btn-primary');
    const originalText = generateBtn.innerHTML;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Memproses...';
    generateBtn.disabled = true;
    
    const forecastData = {
        model_name: model,
        weeks: parseInt(weeks),
    };
    
    fetch('/api/generate-forecast', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(forecastData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('forecastModal'));
            modal.hide();
            
            // Show success message
            const alertHtml = `
                <div class="alert alert-success alert-dismissible fade show" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>‚úÖ Peramalan Berhasil!</strong>
                    <br>
                    <small>Model: <strong>${forecastData.model_name || 'Best'}</strong> | Minggu: <strong>${weeks}</strong></small>
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            const resultsContainer = document.getElementById('forecastResults');

            if (resultsContainer) {
                resultsContainer.innerHTML = alertHtml;
            }

            //  REFRESH CHART DENGAN DELAY
            console.log('‚è≥ Waiting 2 seconds before refreshing chart...');
            setTimeout(() => {
                console.log('üîÑ Refreshing forecast chart...');
                loadForecastChart();
            }, 2000);
            
            //  REFRESH MODEL METRICS
            setTimeout(() => {
                console.log('üîÑ Refreshing model metrics...');
                loadModelMetrics();
            }, 2500);
            
            //  REFRESH FORECAST TABLE
            setTimeout(() => {
                console.log('üîÑ Refreshing forecast table...');
                loadForecastTable();
            }, 3000);
            
        } else {
            alert('Error: ' + (data.message || 'Gagal membuat peramalan'));
        }
    })
    .catch(error => {
        console.error('Error generating forecast:', error);
        alert('Error: ' + error.message);
    })
    .finally(() => {
        generateBtn.innerHTML = originalText;
        generateBtn.disabled = false;
    });
}

// Retrain Models Function - REMOVED: Only available in Admin Panel

// Refresh Dashboard Function
function refreshDashboard() {
    const refreshBtn = document.querySelector('button[onclick="refreshDashboard()"]');
    const originalText = refreshBtn.innerHTML;
    refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Refreshing...';
    refreshBtn.disabled = true;
    
           // Refresh all dashboard components
           Promise.all([
               loadForecastChart(),
               loadModelMetrics(),
               loadEconomicAlerts(),
               loadForecastTable()
           ]).then(() => {
        const alertHtml = `
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <i class="fas fa-sync-alt me-2"></i>
                <strong>‚úÖ Dashboard Diperbarui!</strong>
                <br>
                <small>Semua data telah dimuat ulang</small>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        const resultsContainer = document.getElementById('forecastResults');
        if (resultsContainer) {
            resultsContainer.innerHTML = alertHtml;
        }
    })
    .catch(error => {
        console.error('Error refreshing dashboard:', error);
        alert('Error refreshing dashboard: ' + error.message);
    })
    .finally(() => {
        refreshBtn.innerHTML = originalText;
        refreshBtn.disabled = false;
    });
}

// Make functions globally available
window.showForecastModal = showForecastModal;
window.generateForecast = generateForecast;
window.refreshDashboard = refreshDashboard;


document.addEventListener('DOMContentLoaded', function() {
    console.log('üîß Setting up ID compatibility layer...');
    
    // Keep forecastChart ID as is - no mapping needed
    const forecastChart = document.getElementById('forecastChart');
    if (forecastChart) {
        console.log('   ‚úÖ forecastChart found');
    } else {
        console.warn('   ‚ö†Ô∏è forecastChart not found');
    }
    
    // Map modelPerformanceGrid ‚Üí modelMetricsContainer
    const modelMetrics = document.getElementById('modelMetricsContainer');
    if (modelMetrics && !document.getElementById('modelPerformanceGrid')) {
        modelMetrics.id = 'modelPerformanceGrid';
        console.log('   ‚úÖ Mapped modelMetricsContainer ‚Üí modelPerformanceGrid');
    }
    
    // Ensure forecastTable exists
    const forecastTable = document.getElementById('forecastTable');
    if (forecastTable) {
        console.log('   ‚úÖ forecastTable found');
    } else {
        console.warn('   ‚ö†Ô∏è forecastTable not found');
    }
    
    // Map statisticalAlerts
    const statsAlerts = document.getElementById('statisticalAlertsContainer');
    if (statsAlerts && !document.getElementById('statisticalAlerts')) {
        statsAlerts.id = 'statisticalAlerts';
        console.log('   ‚úÖ Mapped statisticalAlertsContainer ‚Üí statisticalAlerts');
    }
    
    console.log('‚úÖ Compatibility layer setup complete');
});

// ‚úÖ GLOBAL FUNCTIONS for sidebar links
function showForecastModal() {
    const modal = new bootstrap.Modal(document.getElementById('forecastModal'));
    modal.show();
}

// Duplicate function removed - using the first generateForecast function above


function refreshAlerts() {
    console.log('üîÑ Refreshing alerts...');
    window.location.reload();
}
</script>
{% endblock %}