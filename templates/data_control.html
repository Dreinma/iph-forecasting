{% extends "base.html" %}

{% block title %}Data Control - IPH Forecasting{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-3 mb-4 border-bottom">
    <div>
        <h1 class="h2 text-gradient mb-1">
            <i class="fas fa-database me-2"></i>
            Data Control
        </h1>
        <p class="text-muted mb-0">Manage your IPH data and model training</p>
    </div>
    <div class="btn-toolbar">
        <button type="button" class="btn btn-success me-2" onclick="showAddRecordModal()">
            <i class="fas fa-plus me-1"></i>
            Add Single Record
        </button>
        <button type="button" class="btn btn-warning me-2" onclick="retrainModels()">
            <i class="fas fa-sync-alt me-1"></i>
            Retrain Models
        </button>
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-1"></i>
            Back to Dashboard
        </a>
    </div>
</div>



<!-- Upload Data Section - Unified IPH & Commodity -->
<div class="row g-4 mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-cloud-upload-alt text-primary me-2"></i>
                    Upload Data IPH & Komoditas
                </h5>
            </div>
            <div class="card-body">
                <!-- Upload Method Selection -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <i class="fas fa-file-csv fa-3x text-primary mb-3"></i>
                                <h6 class="card-title">Upload File Massal</h6>
                                <p class="card-text small text-muted">Upload file CSV dengan data IPH dan komoditas sekaligus</p>
                                <button type="button" class="btn btn-primary" onclick="showFileUpload()">
                                    <i class="fas fa-upload me-1"></i>
                                    Upload File
                                </button>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <i class="fas fa-plus-circle fa-3x text-success mb-3"></i>
                                <h6 class="card-title">Input Manual</h6>
                                <p class="card-text small text-muted">Tambah data IPH dan komoditas per minggu secara manual</p>
                                <button type="button" class="btn btn-success" onclick="showManualInput()">
                                    <i class="fas fa-keyboard me-1"></i>
                                    Input Manual
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Template Download -->
                <div class="alert alert-info">
                    <h6><i class="fas fa-download me-2"></i>Template File CSV</h6>
                    <p class="mb-2">Download template untuk format data yang benar:</p>
                    <a href="/download/template_iph_komoditas.csv" class="btn btn-outline-primary btn-sm">
                        <i class="fas fa-download me-1"></i>
                        Download Template CSV
                    </a>
                    <small class="text-muted ms-2">Format: Bulan, Minggu ke-, Kab/Kota, Indikator Perubahan Harga (%), Komoditas Andil, Komoditas Fluktuasi, Fluktuasi Harga</small>
                </div>

                <!-- File Upload Form (Hidden by default) -->
                <div id="fileUploadSection" style="display: none;">
                    <form id="uploadForm" enctype="multipart/form-data">
                        <!-- Drag & Drop Area -->
                        <div class="upload-area mb-4" id="uploadArea">
                            <div class="text-center">
                                <i class="fas fa-cloud-upload-alt fa-4x text-primary mb-3"></i>
                                <h5>Drag & Drop file CSV di sini</h5>
                                <p class="text-muted mb-3">atau klik untuk memilih file</p>
                                <button type="button" class="btn btn-primary" id="browseBtn">
                                    <i class="fas fa-folder-open me-2"></i>
                                    Pilih File
                                </button>
                            </div>
                            <input type="file" id="fileInput" name="file" accept=".csv,.xlsx" style="display: none;">
                        </div>
                        
                        <!-- Upload Options -->
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="forecastWeeks" class="form-label">
                                        <i class="fas fa-calendar-alt me-1"></i>
                                        Minggu Peramalan Setelah Upload
                                    </label>
                                    <select class="form-select" id="forecastWeeks" name="forecast_weeks">
                                        <option value="4">4 minggu</option>
                                        <option value="6">6 minggu</option>
                                        <option value="8" selected>8 minggu</option>
                                        <option value="10">10 minggu</option>
                                        <option value="12">12 minggu</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-cog me-1"></i>
                                        Opsi Pemrosesan
                                    </label>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="autoRetrain" checked>
                                        <label class="form-check-label" for="autoRetrain">
                                            Auto-retrain model setelah upload
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="generateForecast" checked>
                                        <label class="form-check-label" for="generateForecast">
                                            Generate peramalan langsung
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Upload Button -->
                        <div class="text-center">
                            <button type="submit" class="btn btn-success btn-lg" id="uploadBtn" disabled>
                                <i class="fas fa-upload me-2"></i>
                                Upload dan Proses Data
                            </button>
                            <button type="button" class="btn btn-secondary ms-2" onclick="hideFileUpload()">
                                <i class="fas fa-times me-1"></i>
                                Batal
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Historical Data Table dengan Pagination -->
<div class="row g-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">
                    <i class="fas fa-table text-success me-2"></i>
                    Historical IPH Data
                </h5>
                <div class="d-flex align-items-center">
                    <span class="me-3">Show:</span>
                    <select class="form-select form-select-sm me-3" id="recordsPerPage" style="width: auto;">
                        <option value="25">25</option>
                        <option value="50" selected>50</option>
                        <option value="100">100</option>
                    </select>
                    <button class="btn btn-outline-primary btn-sm me-2" onclick="refreshHistoricalData()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <span class="badge bg-info" id="totalRecordsBadge">{{ historical_records|length }} records</span>
                </div>
            </div>
            <div class="card-body p-0">
                {% if historical_records %}
                <div class="table-responsive">
                    <table class="table table-hover mb-0" id="historicalDataTable">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="border-0 py-3">#</th>
                                <th class="border-0 py-3">
                                    <i class="fas fa-calendar me-2 text-muted"></i>Date
                                </th>
                                <th class="border-0 py-3">
                                    <i class="fas fa-chart-line me-2 text-muted"></i>IPH Value (%)
                                </th>
                                <th class="border-0 py-3">
                                    <i class="fas fa-info me-2 text-muted"></i>Status
                                </th>
                            </tr>
                        </thead>
                        <tbody id="historicalDataBody">
                            <!-- Data akan dimuat via JavaScript -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Pagination Controls -->
                <div class="card-footer bg-light">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <small class="text-muted" id="paginationInfo">
                                Showing 1 to 50 of {{ historical_records|length }} records
                            </small>
                        </div>
                        <nav aria-label="Data pagination">
                            <ul class="pagination pagination-sm mb-0" id="paginationControls">
                                <!-- Pagination buttons akan dimuat via JavaScript -->
                            </ul>
                        </nav>
                    </div>
                </div>
                {% else %}
                <div class="text-center text-muted py-5">
                    <i class="fas fa-database fa-3x mb-3 opacity-25"></i>
                    <p class="mb-2">No historical data available</p>
                    <small>Upload a CSV file or add records manually to get started</small>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Manual Input Modal -->
<div class="modal fade" id="manualInputModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-keyboard me-2"></i>Input Manual Data IPH & Komoditas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="manualInputForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualBulan" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>Bulan
                                </label>
                                <select class="form-select" id="manualBulan" required>
                                    <option value="">Pilih Bulan</option>
                                    <option value="Januari">Januari</option>
                                    <option value="Februari">Februari</option>
                                    <option value="Maret">Maret</option>
                                    <option value="April">April</option>
                                    <option value="Mei">Mei</option>
                                    <option value="Juni">Juni</option>
                                    <option value="Juli">Juli</option>
                                    <option value="Agustus">Agustus</option>
                                    <option value="September">September</option>
                                    <option value="Oktober">Oktober</option>
                                    <option value="November">November</option>
                                    <option value="Desember">Desember</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualMinggu" class="form-label">
                                    <i class="fas fa-calendar-week me-1"></i>Minggu ke-
                                </label>
                                <select class="form-select" id="manualMinggu" required>
                                    <option value="">Pilih Minggu</option>
                                    <option value="M1">M1</option>
                                    <option value="M2">M2</option>
                                    <option value="M3">M3</option>
                                    <option value="M4">M4</option>
                                    <option value="M5">M5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualTahun" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>Tahun
                                </label>
                                <input type="number" class="form-control" id="manualTahun" 
                                       value="2024" min="2020" max="2030" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualKabKota" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>Kab/Kota
                                </label>
                                <input type="text" class="form-control" id="manualKabKota" 
                                       value="BATU" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manualIPH" class="form-label">
                            <i class="fas fa-chart-line me-1"></i>Indikator Perubahan Harga (%)
                        </label>
                        <input type="number" step="0.001" class="form-control" id="manualIPH" 
                               placeholder="e.g., 1.25 atau -0.85" required>
                        <div class="form-text">Masukkan nilai IPH dalam persen (positif untuk inflasi, negatif untuk deflasi)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manualKomoditasAndil" class="form-label">
                            <i class="fas fa-seedling me-1"></i>Komoditas Andil Perubahan Harga
                        </label>
                        <input type="text" class="form-control" id="manualKomoditasAndil" 
                               placeholder="e.g., BERAS(0.5);CABAI(0.3);MINYAK GORENG(0.2)">
                        <div class="form-text">Format: KOMODITAS(nilai);KOMODITAS(nilai)</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualKomoditasFluktuasi" class="form-label">
                                    <i class="fas fa-chart-bar me-1"></i>Komoditas Fluktuasi Tertinggi
                                </label>
                                <input type="text" class="form-control" id="manualKomoditasFluktuasi" 
                                       placeholder="e.g., CABAI RAWIT">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualNilaiFluktuasi" class="form-label">
                                    <i class="fas fa-percentage me-1"></i>Nilai Fluktuasi
                                </label>
                                <input type="number" step="0.0001" class="form-control" id="manualNilaiFluktuasi" 
                                       placeholder="e.g., 0.0553">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Batal
                </button>
                <button type="button" class="btn btn-success" onclick="addManualRecord()">
                    <i class="fas fa-plus me-1"></i>Tambah Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Results Area -->
<div id="uploadResults"></div>
<div id="actionResults"></div>
{% endblock %}

{% block scripts %}
<script>
// Show/hide file upload section
function showFileUpload() {
    document.getElementById('fileUploadSection').style.display = 'block';
}

function hideFileUpload() {
    document.getElementById('fileUploadSection').style.display = 'none';
}

// Show manual input modal
function showManualInput() {
    const modal = new bootstrap.Modal(document.getElementById('manualInputModal'));
    modal.show();
}

// Add manual record
async function addManualRecord() {
    const formData = {
        bulan: document.getElementById('manualBulan').value,
        minggu: document.getElementById('manualMinggu').value,
        tahun: parseInt(document.getElementById('manualTahun').value),
        kab_kota: document.getElementById('manualKabKota').value,
        iph_value: parseFloat(document.getElementById('manualIPH').value),
        komoditas_andil: document.getElementById('manualKomoditasAndil').value,
        komoditas_fluktuasi: document.getElementById('manualKomoditasFluktuasi').value,
        nilai_fluktuasi: parseFloat(document.getElementById('manualNilaiFluktuasi').value) || 0
    };
    
    // Validate required fields
    if (!formData.bulan || !formData.minggu || !formData.iph_value) {
        showAlert('Mohon isi semua field yang wajib diisi', 'warning');
        return;
    }
    
    try {
        showLoading('Menambahkan data manual...');
        
        const response = await fetch('/api/add-manual-record', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Data berhasil ditambahkan!', 'success');
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('manualInputModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('manualInputForm').reset();
            document.getElementById('manualTahun').value = '2024';
            document.getElementById('manualKabKota').value = 'BATU';
            
            // Refresh page after 2 seconds
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showAlert(`Error: ${result.message}`, 'danger');
        }
        
    } catch (error) {
        showAlert(`Error menambahkan data: ${error.message}`, 'danger');
    } finally {
        hideLoading();
    }
}

// Add single record modal (legacy - keep for compatibility)
function showAddRecordModal() {
    const modalHTML = `
        <div class="modal fade" id="addRecordModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-plus me-2"></i>Add Single IPH Record
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="addRecordForm">
                            <div class="mb-3">
                                <label for="recordDate" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>Date
                                </label>
                                <input type="date" class="form-control" id="recordDate" required>
                                <div class="form-text">Select the date for this IPH record</div>
                            </div>
                            <div class="mb-3">
                                <label for="recordIPH" class="form-label">
                                    <i class="fas fa-chart-line me-1"></i>IPH Value (%)
                                </label>
                                <input type="number" step="0.001" class="form-control" id="recordIPH" 
                                       placeholder="e.g., 1.25 or -0.85" required>
                                <div class="form-text">Enter the IPH value as percentage (positive for inflation, negative for deflation)</div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>Cancel
                        </button>
                        <button type="button" class="btn btn-success" onclick="addSingleRecord()">
                            <i class="fas fa-plus me-1"></i>Add Record
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal
    const existingModal = document.getElementById('addRecordModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to page
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('addRecordModal'));
    modal.show();
}

async function addSingleRecord() {
    const date = document.getElementById('recordDate').value;
    const iph = document.getElementById('recordIPH').value;
    
    if (!date || !iph) {
        alert('Please fill in all fields');
        return;
    }
    
    try {
        showLoading('Adding record...');
        
        const response = await fetch('/api/add-single-record', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                tanggal: date,
                indikator_harga: parseFloat(iph)
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Record added successfully!', 'success');
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('addRecordModal'));
            modal.hide();
            
            // Refresh page after 2 seconds
            setTimeout(() => {
                location.reload();
            }, 2000);
        } else {
            showAlert(`Error: ${result.message}`, 'danger');
        }
        
    } catch (error) {
        showAlert(`Error adding record: ${error.message}`, 'danger');
    } finally {
        hideLoading();
    }
}

async function retrainModels() {
    if (!confirm('Are you sure you want to retrain all models? This may take a few minutes.')) {
        return;
    }
    
    try {
        showLoading('Retraining models...');
        
        const response = await fetch('/api/retrain-models', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        const contentType = response.headers.get('content-type');
        if (!contentType || !contentType.includes('application/json')) {
            const text = await response.text();
            console.error('❌ Non-JSON response:', text);
            throw new Error('Server returned non-JSON response');
        }
        
        const result = await response.json();
        
        if (result.success) {
            showAlert(`✅ Models retrained successfully!\nBest model: ${result.best_model}`, 'success');
            
            // Reload page after 3 seconds
            setTimeout(() => {
                location.reload();
            }, 3000);
        } else {
            showAlert(`❌ Error: ${result.message || result.error}`, 'danger');
        }
        
    } catch (error) {
        console.error('❌ Retrain error:', error);
        showAlert(`❌ Retrain failed: ${error.message}`, 'danger');
    } finally {
        hideLoading();
    }
}

function refreshHistoricalData() {
    location.reload();
}

// Upload functionality (reuse from original upload page)
class DataControlHandler {
    constructor() {
        this.selectedFile = null;
        this.init();
    }
    
    init() {
        this.setupEventListeners();
    }
    
    setupEventListeners() {
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const uploadForm = document.getElementById('uploadForm');
        const browseBtn = document.getElementById('browseBtn');
        
        if (!uploadArea || !fileInput || !uploadForm) return;
        
        // Drag and drop events
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });
        
        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });
        
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                this.handleFileSelection(files[0]);
            }
        });
        
        // Browse button
        if (browseBtn) {
            browseBtn.addEventListener('click', (e) => {
                e.preventDefault();
                e.stopPropagation();
                fileInput.click();
            });
        }
        
        // File input change
        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                this.handleFileSelection(e.target.files[0]);
            }
        });
        
        // Form submission
        uploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            this.handleUpload();
        });
    }
    
    handleFileSelection(file) {
        this.selectedFile = file;
        const uploadBtn = document.getElementById('uploadBtn');
        if (uploadBtn) {
            uploadBtn.disabled = false;
            uploadBtn.textContent = `Upload ${file.name}`;
        }
    }
    
    async handleUpload() {
        if (!this.selectedFile) {
            alert('Please select a file first');
            return;
        }
        
        try {
            showLoading('Uploading and processing data...');
            
            const formData = new FormData();
            formData.append('file', this.selectedFile);
            formData.append('forecast_weeks', document.getElementById('forecastWeeks').value);
            
            const response = await fetch('/api/upload-data', {
                method: 'POST',
                body: formData
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('Data uploaded and processed successfully!', 'success');
                setTimeout(() => location.reload(), 3000);
            } else {
                showAlert(`Upload failed: ${result.error || result.message}`, 'danger');
            }
            
        } catch (error) {
            showAlert(`Upload failed: ${error.message}`, 'danger');
        } finally {
            hideLoading();
        }
    }
}

class HistoricalDataPagination {
    constructor() {
        this.currentPage = 1;
        this.recordsPerPage = 50;
        this.totalRecords = {{ historical_records|length }};
        this.data = {{ historical_records|tojson }};
        this.init();
    }
    
    init() {
        this.setupEventListeners();
        this.renderTable();
        this.renderPagination();
    }
    
    setupEventListeners() {
        document.getElementById('recordsPerPage')?.addEventListener('change', (e) => {
            this.recordsPerPage = parseInt(e.target.value);
            this.currentPage = 1;
            this.renderTable();
            this.renderPagination();
        });
    }
    
    renderTable() {
        const tbody = document.getElementById('historicalDataBody');
        if (!tbody || !this.data) return;
        
        const startIndex = (this.currentPage - 1) * this.recordsPerPage;
        const endIndex = startIndex + this.recordsPerPage;
        const pageData = this.data.slice(startIndex, endIndex);
        
        let html = '';
        pageData.forEach((record, index) => {
            const globalIndex = startIndex + index + 1;
            const date = new Date(record.Tanggal).toLocaleDateString('id-ID');
            const value = parseFloat(record.Indikator_Harga);
            
            let statusBadge = '';
            let statusText = '';
            
            if (value > 2) {
                statusBadge = 'bg-danger';
                statusText = 'High Inflation';
            } else if (value > 0) {
                statusBadge = 'bg-warning';
                statusText = 'Inflation';
            } else if (value < -2) {
                statusBadge = 'bg-info';
                statusText = 'High Deflation';
            } else if (value < 0) {
                statusBadge = 'bg-success';
                statusText = 'Deflation';
            } else {
                statusBadge = 'bg-secondary';
                statusText = 'Stable';
            }
            
            html += `
                <tr>
                    <td class="py-3">${globalIndex}</td>
                    <td class="py-3">
                        <strong>${date}</strong>
                    </td>
                    <td class="py-3">
                        <span class="badge ${statusBadge} fs-6">
                            ${value.toFixed(3)}%
                        </span>
                    </td>
                    <td class="py-3">
                        <span class="badge ${statusBadge}">${statusText}</span>
                    </td>
                </tr>
            `;
        });
        
        tbody.innerHTML = html;
        this.updatePaginationInfo();
    }
    
    renderPagination() {
        const totalPages = Math.ceil(this.totalRecords / this.recordsPerPage);
        const pagination = document.getElementById('paginationControls');
        if (!pagination) return;
        
        let html = '';
        
        // Previous button
        html += `
            <li class="page-item ${this.currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="historicalPagination.goToPage(${this.currentPage - 1})">
                    <i class="fas fa-chevron-left"></i>
                </a>
            </li>
        `;
        
        // Page numbers
        const startPage = Math.max(1, this.currentPage - 2);
        const endPage = Math.min(totalPages, this.currentPage + 2);
        
        for (let i = startPage; i <= endPage; i++) {
            html += `
                <li class="page-item ${i === this.currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="historicalPagination.goToPage(${i})">${i}</a>
                </li>
            `;
        }
        
        // Next button
        html += `
            <li class="page-item ${this.currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="historicalPagination.goToPage(${this.currentPage + 1})">
                    <i class="fas fa-chevron-right"></i>
                </a>
            </li>
        `;
        
        pagination.innerHTML = html;
    }
    
    goToPage(page) {
        const totalPages = Math.ceil(this.totalRecords / this.recordsPerPage);
        if (page < 1 || page > totalPages) return;
        
        this.currentPage = page;
        this.renderTable();
        this.renderPagination();
    }
    
    updatePaginationInfo() {
        const info = document.getElementById('paginationInfo');
        if (!info) return;
        
        const startRecord = (this.currentPage - 1) * this.recordsPerPage + 1;
        const endRecord = Math.min(this.currentPage * this.recordsPerPage, this.totalRecords);
        
        info.textContent = `Showing ${startRecord} to ${endRecord} of ${this.totalRecords} records`;
    }
}

// Initialize pagination
let historicalPagination;
document.addEventListener('DOMContentLoaded', function() {
    if ({{ historical_records|length }} > 0) {
        historicalPagination = new HistoricalDataPagination();
    }
});

// Utility functions
function showLoading(message) {
    const loadingHTML = `
        <div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center" 
             style="background-color: rgba(0,0,0,0.7); z-index: 9999;">
            <div class="text-center text-white">
                <div class="loading-spinner mb-3" style="width: 3rem; height: 3rem; border-width: 4px;"></div>
                <h5>${message}</h5>
            </div>
        </div>
    `;
    
    const existingOverlay = document.getElementById('loadingOverlay');
    if (existingOverlay) existingOverlay.remove();
    
    document.body.insertAdjacentHTML('beforeend', loadingHTML);
}

function hideLoading() {
    const overlay = document.getElementById('loadingOverlay');
    if (overlay) overlay.remove();
}

function showAlert(message, type) {
    const alertHTML = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; max-width: 400px;" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', alertHTML);
    
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            if (alert.textContent.includes(message.substring(0, 20))) {
                alert.remove();
            }
        });
    }, 5000);
}

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    window.dataControlHandler = new DataControlHandler();
});
</script>
{% endblock %}