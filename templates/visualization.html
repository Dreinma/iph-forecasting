{% extends "base.html" %}

{% block title %}Visualisasi Data - IPH Monitoring{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-3 mb-4 border-bottom">
    <div>
        <h1 class="h2 text-gradient mb-1">
            <i class="fas fa-chart-area me-2"></i>
            Visualisasi Data IPH
        </h1>
        <p class="text-muted mb-0">Monitoring & analisis praktis Indikator Perubahan Harga</p>
    </div>
    <div class="btn-toolbar">
        <div class="btn-group me-2">
            <button type="button" class="btn btn-outline-primary" onclick="changeTimeframe('3M')">3 Bulan</button>
            <button type="button" class="btn btn-outline-primary active" onclick="changeTimeframe('6M')">6 Bulan</button>
            <button type="button" class="btn btn-outline-primary" onclick="changeTimeframe('1Y')">1 Tahun</button>
        </div>
        <button type="button" class="btn btn-primary" onclick="refreshVisualization()">
            <i class="fas fa-sync-alt me-1"></i>Refresh
        </button>
    </div>
</div>

<!-- Enhanced Tabs -->
<ul class="nav nav-tabs mb-4" id="vizTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" id="moving-avg-tab" data-bs-toggle="tab" data-bs-target="#moving-avg" type="button">
            <i class="fas fa-chart-line me-1"></i>
            Moving Averages
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="volatility-tab" data-bs-toggle="tab" data-bs-target="#volatility" type="button">
            <i class="fas fa-chart-bar me-1"></i>
            Analisis Volatilitas
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button">
            <i class="fas fa-tachometer-alt me-1"></i>
            Model Performance
        </button>
    </li>
</ul>

<!-- Tab Content -->
<div class="tab-content" id="vizTabContent">
    <!-- Moving Averages -->
    <div class="tab-pane fade show active" id="moving-avg" role="tabpanel">
        <div class="row g-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line text-success me-2"></i>
                            Moving Averages Analysis
                        </h5>
                        <div class="btn-group btn-group-sm">
                            <button type="button" class="btn btn-outline-secondary active" onclick="toggleMA('short')">Short Term</button>
                            <button type="button" class="btn btn-outline-secondary" onclick="toggleMA('long')">Long Term</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div id="movingAvgChart" style="height: 500px;">
                            <div class="text-center py-5">
                                <div class="spinner-border text-success"></div>
                                <p class="mt-2">Memuat analisis moving averages...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Volatility Analysis - FIXED -->
    <div class="tab-pane fade" id="volatility" role="tabpanel">
        <div class="row g-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar text-warning me-2"></i>
                            Analisis Volatilitas & Risk Assessment
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-8">
                                <div id="volatilityChart" style="height: 400px;">
                                    <div class="text-center py-5">
                                        <div class="spinner-border text-warning"></div>
                                        <p class="mt-2">Menghitung volatilitas...</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-light">
                                    <div class="card-body">
                                        <h6 class="card-title">Statistik Risk</h6>
                                        <div id="volatilityStats">
                                            <div class="mb-3">
                                                <small class="text-muted">Volatilitas Saat Ini</small>
                                                <h4 class="text-warning" id="currentVolatility">-</h4>
                                            </div>
                                            <div class="mb-3">
                                                <small class="text-muted">Rata-rata 30 Hari</small>
                                                <h5 id="avgVolatility30">-</h5>
                                            </div>
                                            <div class="mb-3">
                                                <small class="text-muted">Risk Level</small>
                                                <h5 id="riskLevel">-</h5>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Performance -->
    <div class="tab-pane fade" id="performance" role="tabpanel">
        <div class="row g-4">
            <!-- Performance Overview -->
            <div class="col-12">
                <div class="alert alert-info">
                    <h6><i class="fas fa-info-circle me-2"></i>Analisis Performa Model Machine Learning</h6>
                    <p class="mb-0">Bandingkan akurasi semua model ML, lihat trend performa, dan pantau stabilitas prediksi IPH dari waktu ke waktu.</p>
                </div>
            </div>
            
            <!-- Accuracy Trends -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-line text-primary me-2"></i>
                             Trend Akurasi Model
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="accuracyTrendsChart" style="height: 450px;">
                            <div class="text-center py-5">
                                <div class="spinner-border text-primary"></div>
                                <p class="mt-2">Memuat trend akurasi...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Row for Forecast vs Actual and Performance Stats -->
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-crosshairs text-success me-2"></i>
                             Perbandingan Prediksi vs Aktual
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="forecastActualChart" style="height: 450px;">
                            <div class="text-center py-5">
                                <div class="spinner-border text-success"></div>
                                <p class="mt-2">Memuat perbandingan forecast...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Enhanced Performance Stats -->
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-tachometer-alt text-info me-2"></i>
                             Statistik Performa
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="performanceStats">
                            <!-- Best Model Info -->
                            <div class="mb-3 p-3 bg-light rounded">
                                <small class="text-muted"> Model Terbaik</small>
                                <h4 class="text-primary mb-1" id="bestModel">-</h4>
                                <small class="text-success" id="bestModelAccuracy">-</small>
                            </div>
                            
                            <!-- Current Performance -->
                            <div class="row mb-3">
                                <div class="col-6">
                                    <small class="text-muted">MAE Saat Ini</small>
                                    <h5 class="text-primary" id="currentMAE">-</h5>
                                </div>
                                <div class="col-6">
                                    <small class="text-muted">RÂ² Score</small>
                                    <h5 class="text-info" id="currentR2">-</h5>
                                </div>
                            </div>
                            
                            <!-- Model Status -->
                            <div class="mb-3">
                                <small class="text-muted">Status Model</small>
                                <h5 id="modelStatus">-</h5>
                            </div>
                            
                            <!-- Data Info -->
                            <div class="mb-3">
                                <small class="text-muted"> Periode Data</small>
                                <p class="mb-1 small" id="dataCoverage">-</p>
                                <small class="text-muted"> Total Data Points</small>
                                <p class="mb-1 small" id="totalDataPoints">-</p>
                                <small class="text-muted"> Volatilitas Data</small>
                                <p class="mb-1 small" id="dataVolatility">-</p>
                            </div>
                            
                            <!-- Drift Alert -->
                            <div class="alert alert-warning" id="driftAlert" style="display: none;">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <small>Model drift terdeteksi!</small>
                            </div>
                            
                            <!-- Recommendation -->
                            <div class="alert alert-info" id="recommendationAlert" style="display: none;">
                                <i class="fas fa-lightbulb me-2"></i>
                                <small id="recommendationText">-</small>
                            </div>
                            
                            <!-- Last Updated -->
                            <div class="text-center mt-3">
                                <small class="text-muted">Terakhir diperbarui</small>
                                <br>
                                <small id="lastUpdated">-</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Model Comparison Table -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-table text-warning me-2"></i>
                            Tabel Perbandingan Model
                        </h5>
                        <small class="text-muted">Ranking berdasarkan MAE (semakin kecil semakin baik)</small>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover" id="modelComparisonTable">
                                <thead class="table-light">
                                    <tr>
                                        <th>Rank</th>
                                        <th>Model</th>
                                        <th>MAE Saat Ini</th>
                                        <th>RMSE Saat Ini</th>
                                        <th>RÂ² Score</th>
                                        <th>Akurasi</th>
                                        <th>Grade</th>
                                        <th>Trend</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="modelComparisonBody">
                                    <tr>
                                        <td colspan="9" class="text-center py-3">
                                            <div class="spinner-border spinner-border-sm text-primary"></div>
                                            <span class="ms-2">Memuat data perbandingan...</span>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Insights Panel -->
                        <div class="row mt-4" id="insightsPanel" style="display: none;">
                            <div class="col-md-4">
                                <div class="card bg-primary text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-trophy fa-2x mb-2"></i>
                                        <h6>Model Terbaik</h6>
                                        <p class="mb-0 small" id="bestPerformerInsight">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-success text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-check-circle fa-2x mb-2"></i>
                                        <h6>Status Stabilitas</h6>
                                        <p class="mb-0 small" id="stabilityInsight">-</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="card bg-info text-white">
                                    <div class="card-body text-center">
                                        <i class="fas fa-chart-line fa-2x mb-2"></i>
                                        <h6>Karakteristik Data</h6>
                                        <p class="mb-0 small" id="dataCharacteristicsInsight">-</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Model Drift Detection -->
            <div class="col-12">
                <div class="card">
                    <div class="card-header bg-white">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                            Deteksi Penurunan Performa Model
                        </h5>
                    </div>
                    <div class="card-body">
                        <div id="modelDriftChart" style="height: 350px;">
                            <div class="text-center py-5">
                                <div class="spinner-border text-warning"></div>
                                <p class="mt-2">Menganalisis model drift...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentTimeframe = '6M';
    
    async function loadMovingAverages() {
        try {
            const response = await fetch(`/api/visualization/moving-averages?timeframe=${currentTimeframe}`);
            const data = await response.json();
            
            const chartDiv = document.getElementById('movingAvgChart');
            
            if (data.success) {
                chartDiv.innerHTML = '';
                Plotly.newPlot('movingAvgChart', data.chart.data, data.chart.layout, {
                    responsive: true,
                    displayModeBar: true
                });
            } else {
                chartDiv.innerHTML = `<div class="alert alert-warning">${data.message}</div>`;
            }
        } catch (error) {
            document.getElementById('movingAvgChart').innerHTML = 
                `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    }

    async function loadVolatility() {
        console.log('ð Loading volatility...');
        try {
            const response = await fetch(`/api/visualization/volatility?timeframe=${currentTimeframe}`);
            const data = await response.json();
            
            console.log('ð Volatility response:', data);
            
            if (data.success && data.chart) {
                document.getElementById('volatilityChart').innerHTML = '';
                
                // â FIXED: Use same structure as moving averages
                Plotly.newPlot('volatilityChart', data.chart.data, data.chart.layout, {
                    responsive: true,
                    displayModeBar: true
                });
                
                // Update stats
                if (data.stats) {
                    document.getElementById('currentVolatility').textContent = data.stats.current.toFixed(3);
                    document.getElementById('avgVolatility30').textContent = data.stats.avg30.toFixed(3);
                    
                    // Risk level calculation
                    const riskLevel = data.stats.current > data.stats.avg30 * 1.5 ? 'HIGH' : 
                                     data.stats.current > data.stats.avg30 * 1.2 ? 'MEDIUM' : 'LOW';
                    const riskColor = riskLevel === 'HIGH' ? 'text-danger' : 
                                     riskLevel === 'MEDIUM' ? 'text-warning' : 'text-success';
                    
                    const riskElement = document.getElementById('riskLevel');
                    riskElement.textContent = riskLevel;
                    riskElement.className = `h5 ${riskColor}`;
                }
                
                console.log('â Volatility chart loaded successfully');
            } else {
                document.getElementById('volatilityChart').innerHTML = 
                    `<div class="alert alert-warning">${data.message || 'Gagal memuat volatilitas'}</div>`;
            }
        } catch (error) {
            console.error('â Volatility error:', error);
            document.getElementById('volatilityChart').innerHTML = 
                `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    }
    
    async function loadModelPerformance() {
        console.log('ð Loading model performance...');
        try {
            const response = await fetch(`/api/visualization/model-performance?timeframe=${currentTimeframe}`);
            const data = await response.json();
            
            console.log('ð Model performance response:', data);
            
            if (data.success && data.charts) {
                // Load accuracy trends
                if (data.charts.accuracy_trends) {
                    document.getElementById('accuracyTrendsChart').innerHTML = '';
                    Plotly.newPlot('accuracyTrendsChart', 
                        data.charts.accuracy_trends.data, 
                        data.charts.accuracy_trends.layout, {
                        responsive: true,
                        displayModeBar: true
                    });
                }
                
                // Load forecast vs actual
                if (data.charts.forecast_vs_actual) {
                    document.getElementById('forecastActualChart').innerHTML = '';
                    Plotly.newPlot('forecastActualChart', 
                        data.charts.forecast_vs_actual.data, 
                        data.charts.forecast_vs_actual.layout, {
                        responsive: true,
                        displayModeBar: true
                    });
                }
                
                // Load model drift
                if (data.charts.model_drift) {
                    document.getElementById('modelDriftChart').innerHTML = '';
                    Plotly.newPlot('modelDriftChart', 
                        data.charts.model_drift.data, 
                        data.charts.model_drift.layout, {
                        responsive: true,
                        displayModeBar: true
                    });
                }
                
                // Update stats
                if (data.stats) {
                    // Basic stats
                    document.getElementById('bestModel').textContent = data.stats.best_model;
                    document.getElementById('bestModelAccuracy').textContent = data.stats.forecast_accuracy;
                    document.getElementById('currentMAE').textContent = data.stats.current_mae.toFixed(4);
                    document.getElementById('currentR2').textContent = data.stats.current_r2.toFixed(3);
                    document.getElementById('dataCoverage').textContent = data.stats.data_coverage;
                    document.getElementById('totalDataPoints').textContent = data.stats.total_data_points;
                    document.getElementById('dataVolatility').textContent = `${data.stats.data_volatility} (${data.stats.volatility_level})`;
                    document.getElementById('lastUpdated').textContent = data.stats.last_updated;
                    
                    // Model status
                    const status = data.stats.model_stability;
                    const statusColor = status === 'STABIL' ? 'text-success' : 'text-warning';
                    const statusElement = document.getElementById('modelStatus');
                    statusElement.textContent = status;
                    statusElement.className = `h5 ${statusColor}`;
                    
                    // Drift alert
                    const driftAlert = document.getElementById('driftAlert');
                    if (data.stats.drift_detected) {
                        driftAlert.style.display = 'block';
                    } else {
                        driftAlert.style.display = 'none';
                    }
                    
                    // Recommendation
                    const recommendationAlert = document.getElementById('recommendationAlert');
                    const recommendationText = document.getElementById('recommendationText');
                    if (data.stats.recommendation) {
                        recommendationText.textContent = data.stats.recommendation;
                        recommendationAlert.style.display = 'block';
                    }
                    
                    // Model Comparison Table
                    if (data.stats.model_comparison_table) {
                        updateModelComparisonTable(data.stats.model_comparison_table);
                    }
                    
                    // Insights
                    if (data.stats.insights) {
                        updateInsightsPanel(data.stats.insights);
                    }
                }
                
                console.log('â Model performance loaded successfully');
            } else {
                const errorMsg = data.message || 'Gagal memuat model performance';
                document.getElementById('accuracyTrendsChart').innerHTML = 
                    `<div class="alert alert-warning">${errorMsg}</div>`;
            }
        } catch (error) {
            console.error('â Model performance error:', error);
            document.getElementById('accuracyTrendsChart').innerHTML = 
                `<div class="alert alert-danger">Error: ${error.message}</div>`;
        }
    }

    function changeTimeframe(timeframe) {
        currentTimeframe = timeframe;
        
        // Update button states
        document.querySelectorAll('.btn-group button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
        
        refreshVisualization();
    }
    
    function toggleMA(type) {
        const chart = document.getElementById('movingAvgChart');
        if (chart && chart._fullData) {
            const updates = chart._fullData.map(trace => {
                if (trace.name.includes('IPH')) return true;
                if (type === 'short' && (trace.name.includes('MA 3') || trace.name.includes('MA 7'))) return true;
                if (type === 'long' && (trace.name.includes('MA 14') || trace.name.includes('MA 30'))) return true;
                return false;
            });
            
            Plotly.restyle('movingAvgChart', {visible: updates});
        }
        
        event.target.parentElement.querySelectorAll('button').forEach(btn => btn.classList.remove('active'));
        event.target.classList.add('active');
    }
    
    function refreshVisualization() {
        const activeTab = document.querySelector('.tab-pane.active').id;
        
        switch(activeTab) {
            case 'moving-avg': loadMovingAverages(); break;
            case 'volatility': loadVolatility(); break;
            case 'performance': loadModelPerformance(); break;
        }
    }

    function updateModelComparisonTable(tableData) {
        const tbody = document.getElementById('modelComparisonBody');
        tbody.innerHTML = '';
        
        tableData.forEach(row => {
            const tr = document.createElement('tr');
            tr.className = row.is_best ? 'table-success' : '';
            
            // Trend icon
            const trendIcon = row.performance_trend === 'IMPROVING' ? 'ð' : 
                            row.performance_trend === 'DECLINING' ? 'ð' : 'â¡ï¸';
            
            // Status badge
            const statusBadge = row.is_best ? '<span class="badge bg-success">TERBAIK</span>' : 
                            row.grade === 'EXCELLENT' ? '<span class="badge bg-primary">EXCELLENT</span>' :
                            row.grade === 'GOOD' ? '<span class="badge bg-info">GOOD</span>' :
                            row.grade === 'FAIR' ? '<span class="badge bg-warning">FAIR</span>' :
                            '<span class="badge bg-secondary">POOR</span>';
            
            tr.innerHTML = `
                <td><strong>${row.rank}</strong></td>
                <td>
                    <strong>${row.model}</strong>
                    ${row.is_best ? ' ð' : ''}
                </td>
                <td>${row.current_mae}</td>
                <td>${row.current_rmse}</td>
                <td>${row.current_r2}</td>
                <td><strong>${row.accuracy_pct}%</strong></td>
                <td><span class="badge bg-${row.grade_color}">${row.grade}</span></td>
                <td>${trendIcon} ${row.performance_trend}</td>
                <td>${statusBadge}</td>
            `;
            
            tbody.appendChild(tr);
        });
    }

    function updateInsightsPanel(insights) {
        document.getElementById('bestPerformerInsight').textContent = insights.best_performer;
        document.getElementById('stabilityInsight').textContent = insights.stability_status;
        document.getElementById('dataCharacteristicsInsight').textContent = insights.data_characteristics;
        document.getElementById('insightsPanel').style.display = 'block';
    }

    // Tab change handlers
    document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', function (event) {
            const targetId = event.target.getAttribute('data-bs-target').substring(1);
            
            switch(targetId) {
                case 'moving-avg': loadMovingAverages(); break;
                case 'volatility': loadVolatility(); break;
                case 'performance': loadModelPerformance(); break;
            }
        });
    });
    
    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
        loadMovingAverages();
    });
</script>
{% endblock %}