{% extends "base.html" %}

{% block title %}Visualisasi Data - IPH Monitoring{% endblock %}

{% block content %}
<div class="pb-3 mb-4 border-bottom">
    <h1 class="h2 text-gradient mb-1">
        <i class="fas fa-chart-area me-2"></i>
        Visualisasi Data IPH
    </h1>
    <p class="text-muted mb-0">Monitoring data historis Indikator Perubahan Harga</p>
</div>

<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body py-4">
        <div class="row g-3 align-items-end">
            <div class="col-lg-5">
                <label class="form-label fw-bold mb-2 text-muted small text-uppercase">
                    Periode Window
                </label>
                <div class="btn-group w-100" role="group">
                    <button type="button" class="btn btn-outline-primary" onclick="changeTimeframe('1M')">1 Bulan</button>
                    <button type="button" class="btn btn-outline-primary active" onclick="changeTimeframe('3M')">3 Bulan</button>
                    <button type="button" class="btn btn-outline-primary" onclick="changeTimeframe('6M')">6 Bulan</button>
                    <button type="button" class="btn btn-outline-primary" onclick="changeTimeframe('ALL')">Semua Data</button>
                </div>
            </div>

            <div class="col-lg-7">
                <label class="form-label fw-bold mb-2 text-muted small text-uppercase">
                    Mulai Dari (Bulan / Tahun)
                </label>
                <div class="row g-2">
                    <div class="col-7">
                        <select class="form-select" id="startMonthSelect" onchange="applyDateSelection()">
                            <option value="01">Januari</option>
                            <option value="02">Februari</option>
                            <option value="03">Maret</option>
                            <option value="04">April</option>
                            <option value="05">Mei</option>
                            <option value="06">Juni</option>
                            <option value="07">Juli</option>
                            <option value="08">Agustus</option>
                            <option value="09">September</option>
                            <option value="10">Oktober</option>
                            <option value="11">November</option>
                            <option value="12">Desember</option>
                        </select>
                    </div>
                    <div class="col-5">
                        <select class="form-select" id="startYearSelect" onchange="applyDateSelection()">
                            </select>
                    </div>
                </div>
                <div class="form-text small text-muted mt-1" id="rangeInfoText">
                    Menampilkan data mulai dari periode yang dipilih.
                </div>
            </div>
        </div>
    </div>
</div>

<div class="tab-content" id="vizTabContent">
    <div class="tab-pane fade show active" id="volatility" role="tabpanel">
        <div class="row g-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white py-3">
                        <h5 class="card-title mb-0 text-primary">Grafik Pergerakan & Volatilitas IPH</h5>
                    </div>
                    <div class="card-body">
                        <div id="volatilityChart" style="height: 500px;">
                            <div class="d-flex justify-content-center align-items-center h-100 text-muted">Memuat grafik...</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-12">
                <div class="row g-4">
                    <div class="col-md-6 col-lg-3">
                        <div class="card border-info h-100 shadow-sm">
                            <div class="card-body text-center p-4">
                                <h6 class="card-title text-muted text-uppercase small mb-3">Volatilitas Data Terbaru</h6>
                                <div id="currentVolatility" class="display-6 text-info fw-bold">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card border-success h-100 shadow-sm">
                            <div class="card-body text-center p-4">
                                <h6 class="card-title text-muted text-uppercase small mb-3">Rata-rata Window</h6>
                                <div id="avgVolatility30" class="display-6 text-success fw-bold">-</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <div class="card border-secondary h-100 shadow-sm">
                            <div class="card-body text-center p-4">
                                <h6 class="card-title text-muted text-uppercase small mb-3">Range Volatilitas</h6>
                                <div class="d-flex justify-content-center gap-3 align-items-end">
                                    <div><span class="text-danger fw-bold d-block">Max</span><span id="maxVolatility" class="h5">-</span></div>
                                    <div class="border-end h-100"></div>
                                    <div><span class="text-success fw-bold d-block">Min</span><span id="minVolatility" class="h5">-</span></div>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="col-md-6 col-lg-3">
                        <div class="card border-warning h-100 shadow-sm">
                            <div class="card-body text-center p-4">
                                <h6 class="card-title text-muted text-uppercase small mb-3">Level Risiko</h6>
                                <div id="riskLevelText" class="display-6 fw-bold">-</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let currentTimeframe = '3M'; // DEFAULT 3 BULAN
    let selectedStartDate = null;

    async function loadVolatility() {
        console.log(`üîÑ Loading visualization: ${currentTimeframe}, Start: ${selectedStartDate}`);
        
        const chartDiv = document.getElementById('volatilityChart');
        if(!chartDiv.querySelector('.js-plotly-plot')) {
        }

        try {
            let url = `/api/visualization/volatility?timeframe=${currentTimeframe}`;
            if (selectedStartDate && currentTimeframe !== 'ALL') {
                url += `&start_date=${selectedStartDate}`;
            }
            
            const response = await fetch(url);
            const data = await response.json();
            
            if (data.success && data.charts) {  
                const chartData = data.charts.accuracy_trends;
                if (chartData) {
                    // Update Layout
                    chartData.layout.title = { text: `Data Aktual (${currentTimeframe})`, font: { size: 16 } };
                    chartData.layout.margin = {l: 50, r: 20, t: 50, b: 50};
                    
                    const config = { responsive: true, displayModeBar: false };
                    Plotly.newPlot('volatilityChart', chartData.data, chartData.layout, config);
                } else {
                    chartDiv.innerHTML = '<div class="alert alert-info text-center m-5">Tidak ada data untuk periode ini.</div>';
                }
                
                if (data.stats) updateVolatilityStats(data.stats);
            } else {
                chartDiv.innerHTML = `<div class="alert alert-warning m-4">${data.message || 'Gagal memuat data'}</div>`;
                resetStats();
            }
        } catch (error) {
            console.error('‚ùå Visualization error:', error);
            chartDiv.innerHTML = `<div class="alert alert-danger m-4">Error: ${error.message}</div>`;
        }
    }

    function updateVolatilityStats(stats) {
        // Pastikan nilai ada dan format float
        const current = parseFloat(stats.current_volatility || 0).toFixed(2);
        const avg = parseFloat(stats.avg_volatility_30 || 0).toFixed(2);
        const max = parseFloat(stats.max_volatility || 0).toFixed(2);
        const min = parseFloat(stats.min_volatility || 0).toFixed(2);

        // Update DOM
        document.getElementById('currentVolatility').textContent = current;
        document.getElementById('avgVolatility30').textContent = avg;
        document.getElementById('maxVolatility').textContent = max;
        document.getElementById('minVolatility').textContent = min;

        // Hitung Risk Level
        const riskLevelText = document.getElementById('riskLevelText');
        let riskLevel = 'RENDAH';
        let riskColor = 'success';

        if (current > 1.5) { riskLevel = 'TINGGI'; riskColor = 'danger'; }
        else if (current > 0.5) { riskLevel = 'SEDANG'; riskColor = 'warning'; }

        riskLevelText.textContent = riskLevel;
        riskLevelText.className = `display-6 fw-bold text-${riskColor}`;
    }

    function resetStats() {
        ['currentVolatility', 'avgVolatility30', 'maxVolatility', 'minVolatility', 'riskLevelText'].forEach(id => {
            document.getElementById(id).textContent = '-';
        });
    }

    function changeTimeframe(timeframe) {
        currentTimeframe = timeframe;
        
        // Update UI Button
        document.querySelectorAll('.btn-group .btn-outline-primary').forEach(btn => {
            btn.classList.remove('active');
            // Logic simple untuk highlight tombol yang benar
            if((timeframe === 'ALL' && btn.innerText.includes('Semua')) || 
               btn.innerText.includes(timeframe.replace('M', ' Bulan').replace('Y', ' Tahun'))) {
                btn.classList.add('active');
            }
        });

        const mSelect = document.getElementById('startMonthSelect');
        const ySelect = document.getElementById('startYearSelect');

        if (timeframe === 'ALL') {
            mSelect.disabled = true;
            ySelect.disabled = true;
            selectedStartDate = null;
        } else {
            mSelect.disabled = false;
            ySelect.disabled = false;
            // Re-apply date from dropdowns
            applyDateSelection(); 
            return; // applyDateSelection calls loadVolatility
        }

        loadVolatility();
    }

    function applyDateSelection() {
        const month = document.getElementById('startMonthSelect').value;
        const year = document.getElementById('startYearSelect').value;
        
        if (month && year) {
            selectedStartDate = `${year}-${month}-01`; // Format YYYY-MM-DD
            
            // Update info text
            const mName = document.getElementById('startMonthSelect').options[document.getElementById('startMonthSelect').selectedIndex].text;
            document.getElementById('rangeInfoText').textContent = `Menampilkan ${currentTimeframe} data mulai dari ${mName} ${year}`;
            
            loadVolatility();
        }
    }

    async function initializeDropdowns() {
        try {
            const response = await fetch('/api/data/available-periods');
            const data = await response.json();
            
            if (data.success && data.years && data.years.length > 0) {
                const yearSelect = document.getElementById('startYearSelect');
                yearSelect.innerHTML = '';
                
                // Isi Tahun (Terbaru ke Terlama)
                const sortedYears = data.years.sort((a, b) => b - a);
                sortedYears.forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = y;
                    opt.text = y;
                    yearSelect.appendChild(opt);
                });

                // --- LOGIKA DEFAULT: 3 BULAN TERAKHIR ---
                // Ambil periode terakhir yang tersedia
                if (data.periods && data.periods.length > 0) {
                    const lastPeriod = data.periods[data.periods.length - 1]; // e.g. {year: 2025, month: 6}
                    
                    // Hitung mundur 3 bulan
                    let targetDate = new Date(lastPeriod.year, lastPeriod.month - 1, 1); // JS month 0-11
                    targetDate.setMonth(targetDate.getMonth() - 3);
                    
                    const defYear = targetDate.getFullYear();
                    const defMonth = String(targetDate.getMonth() + 1).padStart(2, '0'); // Kembali ke format 01-12

                    // Set Dropdown Values
                    yearSelect.value = defYear; 
                    // Fallback jika tahun hasil hitungan tidak ada di data (jarang terjadi)
                    if (!yearSelect.value) yearSelect.value = sortedYears[0];

                    document.getElementById('startMonthSelect').value = defMonth;
                    
                    // Set global start date
                    selectedStartDate = `${defYear}-${defMonth}-01`;
                    
                    console.log(`üìÖ Default Start Date set to: ${selectedStartDate} (3 months window)`);
                }
            }
        } catch (error) {
            console.error('‚ùå Init error:', error);
        }
    }

    document.addEventListener('DOMContentLoaded', async function() {
        await initializeDropdowns();
        loadVolatility(); // Load awal dengan default 3 bulan
    });
</script>
{% endblock %}