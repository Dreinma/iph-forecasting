{% extends "base_admin.html" %}

{% block page_title %}Create Admin User{% endblock %}
{% block page_subtitle %}Tambahkan admin user baru{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <!-- Flash Messages -->
        {% with messages = get_flashed_messages(with_categories=true) %}
            {% if messages %}
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else category }} alert-dismissible fade show" role="alert">
                        <i class="fas fa-{{ 'exclamation-circle' if category == 'danger' or category == 'error' else 'check-circle' if category == 'success' else 'info-circle' }} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                {% endfor %}
            {% endif %}
        {% endwith %}
        
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-user-plus text-primary me-2"></i>Create Admin User
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('admin.create_admin') }}">
                    {{ form.hidden_tag() }}
                    
                    <div class="alert alert-info d-flex align-items-center mb-4" role="alert">
                        <i class="fas fa-info-circle me-2"></i>
                        <div>
                            <strong>Cara Membuat Admin User:</strong><br>
                            <small>1. Isi Username, Password, dan Konfirmasi Password (Email/Identifier opsional)<br>
                            2. Pastikan Username dan Email (jika diisi) belum digunakan oleh admin lain<br>
                            3. Password minimal 8 karakter dan harus cocok dengan konfirmasi password</small>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.username.label(class="form-label") }}
                        {{ form.username(class="form-control" + (" is-invalid" if form.username.errors else ""), placeholder="contoh: admin2") }}
                        {% if form.username.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.username.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">Username harus unik dan 3-50 karakter</small>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.email.label(class="form-label") }}
                        {{ form.email(class="form-control" + (" is-invalid" if form.email.errors else ""), placeholder="opsional: bisa email atau teks biasa") }}
                        {% if form.email.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.email.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">Email/Identifier opsional, maksimal 100 karakter (bisa menggunakan teks biasa)</small>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.password.label(class="form-label") }}
                        {{ form.password(class="form-control" + (" is-invalid" if form.password.errors else ""), placeholder="Minimal 8 karakter") }}
                        {% if form.password.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.password.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">Password minimal 8 karakter</small>
                    </div>
                    
                    <div class="mb-3">
                        {{ form.confirm_password.label(class="form-label") }}
                        {{ form.confirm_password(class="form-control" + (" is-invalid" if form.confirm_password.errors else ""), placeholder="Ulangi password yang sama") }}
                        {% if form.confirm_password.errors %}
                            <div class="invalid-feedback">
                                {% for error in form.confirm_password.errors %}
                                    <div>{{ error }}</div>
                                {% endfor %}
                            </div>
                        {% endif %}
                        <small class="form-text text-muted">Password harus sama dengan field Password di atas</small>
                    </div>
                    
                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <a href="{{ url_for('admin.settings') }}" class="btn btn-secondary">
                            <i class="fas fa-times me-2"></i>Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Create Admin User
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('=== CREATE ADMIN PAGE LOADED ===');
    
    const form = document.querySelector('form[method="POST"]');
    const submitBtn = form?.querySelector('button[type="submit"]');
    
    console.log('Form element:', form ? 'FOUND' : 'NOT FOUND');
    console.log('Submit button:', submitBtn ? 'FOUND' : 'NOT FOUND');
    
    if (form && submitBtn) {
        // Check CSRF token first
        const csrfToken = document.querySelector('input[name="csrf_token"]');
        if (csrfToken) {
            console.log('✓ CSRF token found:', csrfToken.value.substring(0, 20) + '...');
        } else {
            console.warn('✗ CSRF token NOT found! This may cause form submission to fail.');
        }
        
        // Attach submit handler
        form.addEventListener('submit', function(e) {
            console.log('=== FORM SUBMIT TRIGGERED ===');
            console.log('Form action:', form.action);
            console.log('Form method:', form.method);
            
            // Validate required fields before submit
            const username = form.querySelector('input[name="username"]')?.value;
            const password = form.querySelector('input[name="password"]')?.value;
            const confirmPassword = form.querySelector('input[name="confirm_password"]')?.value;
            
            console.log('Username:', username || 'EMPTY');
            console.log('Password length:', password ? password.length : 0);
            console.log('Confirm password length:', confirmPassword ? confirmPassword.length : 0);
            
            if (!username || username.trim().length < 3) {
                alert('Username harus diisi dan minimal 3 karakter!');
                e.preventDefault();
                return false;
            }
            
            if (!password || password.length < 8) {
                alert('Password harus diisi dan minimal 8 karakter!');
                e.preventDefault();
                return false;
            }
            
            if (password !== confirmPassword) {
                alert('Password dan Konfirmasi Password tidak cocok!');
                e.preventDefault();
                return false;
            }
            
            // All validations passed - update button state
            submitBtn.disabled = true;
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating...';
            
            console.log('Form submitting...');
            
            // Re-enable after 10 seconds in case of error
            setTimeout(() => {
                if (submitBtn.disabled) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    console.warn('Form submission timeout - button re-enabled');
                }
            }, 10000);
            
            // Let form submit normally (no preventDefault)
        });
        
        console.log('✓ Form submit handler attached successfully');
    } else {
        console.error('✗ Form or submit button not found!');
        if (!form) console.error('  - Form element missing');
        if (!submitBtn) console.error('  - Submit button missing');
    }
    
    // Also attach click handler to submit button as backup
    if (submitBtn) {
        submitBtn.addEventListener('click', function(e) {
            console.log('Submit button clicked');
            // Don't prevent default - let form submit normally
        });
    }
});
</script>
{% endblock %}

