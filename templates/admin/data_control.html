{% extends "base_admin.html" %}

{% block page_title %}Data Management{% endblock %}
{% block page_subtitle %}Upload, edit, dan kelola data IPH{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Manajemen Data</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('static', filename='uploads/template_iph_komoditas.csv') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-download me-1"></i> Template
            </a>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="fas fa-upload me-1"></i> Upload CSV
            </button>
            <button type="button" class="btn btn-sm btn-outline-success" onclick="openManualModal()">
                <i class="fas fa-plus me-1"></i> Tambah Manual
            </button>
        </div>
    </div>
</div>

<div class="row mb-3">
    <div class="col-md-4 ms-auto">
        <input type="text" class="form-control" id="searchInput" placeholder="Cari data...">
    </div>
</div>

<div class="card border-0 shadow-sm">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-striped table-hover mb-0" id="dataTable">
                <thead class="table-light">
                    <tr>
                        <th>Tanggal</th>
                        <th>Bulan</th>
                        <th>Minggu</th>
                        <th>Tahun</th>
                        <th>IPH (%)</th>
                        <th class="text-end">Aksi</th>
                    </tr>
                </thead>
                <tbody id="dataBody">
                    </tbody>
            </table>
        </div>
        <div id="paginationContainer" class="p-3 border-top"></div>
    </div>
</div>

<div class="modal fade" id="uploadModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Upload Data CSV</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="fileUpload" class="form-label">Pilih File (.csv, .xlsx)</label>
                    <input type="file" class="form-control" id="fileUpload" accept=".csv, .xlsx">
                    <div class="form-text small mt-2">
                        Pastikan kolom sesuai template: Bulan, Minggu ke, Kab/Kota, Indikator IPH, Komoditas Andil, dll.
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" onclick="uploadData()">Upload</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="addManualModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title"><i class="fas fa-plus-circle me-2"></i>Tambah Data Manual</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="manualInputForm">
                    <div class="row g-3">
                        <div class="col-md-4">
                            <label class="form-label">Bulan</label>
                            <select class="form-select" name="bulan" required>
                                <option value="">Pilih...</option>
                                <option value="Januari">Januari</option>
                                <option value="Februari">Februari</option>
                                <option value="Maret">Maret</option>
                                <option value="April">April</option>
                                <option value="Mei">Mei</option>
                                <option value="Juni">Juni</option>
                                <option value="Juli">Juli</option>
                                <option value="Agustus">Agustus</option>
                                <option value="September">September</option>
                                <option value="Oktober">Oktober</option>
                                <option value="November">November</option>
                                <option value="Desember">Desember</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Minggu ke-</label>
                            <select class="form-select" name="minggu" required>
                                <option value="M1">M1</option>
                                <option value="M2">M2</option>
                                <option value="M3">M3</option>
                                <option value="M4">M4</option>
                                <option value="M5">M5</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Tahun</label>
                            <input type="number" class="form-control" name="tahun" value="2025" required>
                        </div>
                        
                        <div class="col-md-6">
                            <label class="form-label">Kab/Kota</label>
                            <input type="text" class="form-control" name="kab_kota" value="BATU" readonly>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Indikator Perubahan Harga (%)</label>
                            <input type="number" step="0.01" class="form-control" name="iph_value" placeholder="Contoh: -0.43" required>
                        </div>

                        <div class="col-12">
                            <label class="form-label">Komoditas Andil Perubahan Harga</label>
                            <textarea class="form-control" name="komoditas_andil" rows="2" placeholder='Contoh: BAWANG PUTIH(-0.42); BAWANG MERAH(-0.17); CABAI MERAH(-0.13)'></textarea>
                            <div class="form-text">Format: NAMA KOMODITAS(NILAI); NAMA KOMODITAS(NILAI)</div>
                        </div>

                        <div class="col-md-6">
                            <label class="form-label">Komoditas Fluktuasi Tertinggi</label>
                            <input type="text" class="form-control" name="komoditas_fluktuasi" placeholder="Contoh: CABAI RAWIT">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Nilai Fluktuasi</label>
                            <input type="number" step="0.0001" class="form-control" name="nilai_fluktuasi" placeholder="Contoh: 0.1812">
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-success" onclick="submitManualData()">Simpan Data</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="editDataModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Edit Data IPH</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editDataForm">
                    <input type="hidden" id="edit_id" name="id">
                    <div class="mb-3">
                        <label class="form-label">Tanggal (Read-only)</label>
                        <input type="text" class="form-control" id="edit_tanggal" readonly disabled>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">IPH Value (%)</label>
                        <input type="number" step="0.01" class="form-control" id="edit_iph" name="indikator_harga" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" onclick="submitEditData()">Update</button>
            </div>
        </div>
    </div>
</div>

<div id="actionResults" class="position-fixed top-0 end-0 p-3" style="z-index: 1050"></div>

{% endblock %}

{% block scripts %}
<script>
// Variabel Global
let currentPage = 1;
const perPage = 20;
let searchTimeout = null;

document.addEventListener('DOMContentLoaded', function() {
    loadDataTable(1);
    
    // Search Listener
    document.getElementById('searchInput')?.addEventListener('input', function(e) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            loadDataTable(1);
        }, 500);
    });
});

// --- LOAD DATA TABLE ---
async function loadDataTable(page = 1) {
    const search = document.getElementById('searchInput')?.value || '';
    const url = `/admin/api/data/list?page=${page}&per_page=${perPage}&search=${encodeURIComponent(search)}`;
    const tbody = document.getElementById('dataBody'); 
    
    tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5"><div class="spinner-border text-primary mb-2"></div><p class="text-muted small mb-0">Memuat data...</p></td></tr>`;
    
    try {
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.data) {
            renderTableRows(result.data.items);
            renderPagination(result.data.pagination);
            currentPage = page;
        } else {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">${result.error || 'Gagal memuat data'}</td></tr>`;
        }
    } catch (error) {
        console.error('Load Error:', error);
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">Error koneksi: ${error.message}</td></tr>`;
    }
}

function renderTableRows(items) {
    const tbody = document.getElementById('dataBody');
    tbody.innerHTML = '';
    
    if (!items || items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-muted">Tidak ada data ditemukan</td></tr>`;
        return;
    }
    
    items.forEach(item => {
        let dateStr = item.tanggal ? item.tanggal.split('T')[0] : '-';
        const iphClass = (item.indikator_harga < 0) ? 'text-success' : (item.indikator_harga > 0 ? 'text-danger' : 'text-dark');

        const row = `
            <tr>
                <td class="align-middle font-monospace small">${dateStr}</td>
                <td class="align-middle">${item.bulan || '-'}</td>
                <td class="align-middle">${item.minggu || '-'}</td>
                <td class="align-middle">${item.tahun || '-'}</td>
                <td class="align-middle fw-bold ${iphClass}">
                    ${item.indikator_harga !== null ? item.indikator_harga.toFixed(2) + '%' : '-'}
                </td>
                <td class="align-middle text-end">
                    <button class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="deleteData(${item.id})" title="Hapus Data">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}


function renderPagination(pagination) {
    const container = document.getElementById('paginationContainer');
    if (!container) return;
    if (pagination.pages <= 1) { container.innerHTML = ''; return; }

    let html = `<nav><ul class="pagination justify-content-center mb-0 pagination-sm">`;
    
    // Prev
    html += `<li class="page-item ${pagination.page === 1 ? 'disabled' : ''}">
            <button class="page-link" onclick="loadDataTable(${pagination.page - 1})"><i class="fas fa-chevron-left"></i></button></li>`;

    // Pages (Simplified)
    const start = Math.max(1, pagination.page - 1);
    const end = Math.min(pagination.pages, pagination.page + 1);
    for (let i = start; i <= end; i++) {
        html += `<li class="page-item ${i === pagination.page ? 'active' : ''}">
                <button class="page-link" onclick="loadDataTable(${i})">${i}</button></li>`;
    }

    // Next
    html += `<li class="page-item ${pagination.page === pagination.pages ? 'disabled' : ''}">
            <button class="page-link" onclick="loadDataTable(${pagination.page + 1})"><i class="fas fa-chevron-right"></i></button></li>`;

    html += `</ul></nav>`;
    container.innerHTML = html;
}

// --- FITUR TAMBAH MANUAL ---
function openManualModal() {
    // Reset form
    document.getElementById('manualInputForm').reset();
    // Set default tahun
    document.querySelector('[name="tahun"]').value = new Date().getFullYear();
    const modal = new bootstrap.Modal(document.getElementById('addManualModal'));
    modal.show();
}

async function submitManualData() {
    const form = document.getElementById('manualInputForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Validasi dasar
    if (!data.bulan || !data.minggu || !data.tahun || !data.iph_value) {
        alert('Mohon lengkapi field wajib (Bulan, Minggu, Tahun, IPH)');
        return;
    }

    try {
        const response = await fetch('/admin/api/add-manual-record', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        
        if (result.success) {
            showAlert('Data berhasil disimpan!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addManualModal')).hide();
            loadDataTable(1); // Reload ke halaman pertama
        } else {
            alert('Gagal: ' + result.message);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// --- FITUR EDIT ---
function openEditModal(item) {
    document.getElementById('edit_id').value = item.id;
    document.getElementById('edit_iph').value = item.indikator_harga;
    document.getElementById('edit_tanggal').value = item.tanggal;
    
    const modal = new bootstrap.Modal(document.getElementById('editDataModal'));
    modal.show();
}

async function submitEditData() {
    const id = document.getElementById('edit_id').value;
    const iph = document.getElementById('edit_iph').value;

    try {
        const response = await fetch('/admin/api/data/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, indikator_harga: iph })
        });
        const result = await response.json();
        
        if(result.success) {
            showAlert('Data berhasil diupdate', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editDataModal')).hide();
            loadDataTable(currentPage);
        } else {
            alert('Gagal update: ' + result.message);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// --- FITUR DELETE ---
async function deleteData(id) {
    if(!confirm('Yakin ingin menghapus data ini permanen?')) return;
    
    try {
        const response = await fetch(`/admin/api/data/${id}`, { method: 'DELETE' });
        const result = await response.json();
        if(result.success) {
            showAlert('Data dihapus', 'success');
            loadDataTable(currentPage);
        } else {
            alert('Gagal hapus: ' + result.error);
        }
    } catch(e) {
        alert('Error: ' + e.message);
    }
}

// --- FITUR UPLOAD ---
async function uploadData() {
    const fileInput = document.getElementById('fileUpload');
    const file = fileInput?.files[0];
    if (!file) { alert('Pilih file dulu!'); return; }
    
    const formData = new FormData();
    formData.append('file', file);
    
    try {
        // UI Loading state
        const btn = document.querySelector('#uploadModal .btn-primary');
        const oldText = btn.innerHTML;
        btn.disabled = true; btn.innerHTML = 'Uploading...';

        const response = await fetch('/api/upload-data', { method: 'POST', body: formData });
        const result = await response.json();
        
        if (result.success) {
            showAlert(`Upload Sukses! ${result.merge_info.new_records} data baru.`, 'success');
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide();
            loadDataTable(1);
        } else {
            alert('Upload Gagal: ' + result.message);
        }
        
        btn.disabled = false; btn.innerHTML = oldText;
    } catch (error) {
        alert('Error: ' + error.message);
    }
}

function showAlert(message, type) {
    const container = document.getElementById('actionResults');
    container.innerHTML = `
        <div class="alert alert-${type} alert-dismissible fade show shadow-sm" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    setTimeout(() => { container.innerHTML = ''; }, 3000);
}
</script>
{% endblock %}