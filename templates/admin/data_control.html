{% extends "base_admin.html" %}

{% block page_title %}Data Management{% endblock %}
{% block page_subtitle %}Upload, edit, dan kelola data IPH{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h5 class="mb-1">Data Management</h5>
        <p class="text-muted mb-0">Upload, edit, dan kelola data IPH dan komoditas</p>
    </div>
    <div>
        <button type="button" class="btn btn-primary" onclick="showUploadModal()">
            <i class="fas fa-upload me-2"></i>Upload Data
        </button>
    </div>
</div>

<!-- Upload Data Section -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
        <h6 class="card-title mb-0">
            <i class="fas fa-cloud-upload-alt text-primary me-2"></i>Upload Data
        </h6>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <label class="form-label">Upload CSV/Excel</label>
                <input type="file" class="form-control" id="fileUpload" accept=".csv,.xlsx,.xls">
            </div>
            <div class="col-md-6">
                <label class="form-label">Upload Template</label>
                <a href="/download/template_iph_komoditas.csv" class="btn btn-outline-secondary w-100">
                    <i class="fas fa-download me-2"></i>Download Template
                </a>
            </div>
        </div>
        <div class="row g-3 mt-2">
            <div class="col-md-6">
                <label class="form-label">Minggu Peramalan Setelah Upload</label>
                <select class="form-select" id="forecastWeeks">
                    <option value="4">4 minggu</option>
                    <option value="6">6 minggu</option>
                    <option value="8" selected>8 minggu</option>
                    <option value="10">10 minggu</option>
                    <option value="12">12 minggu</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Opsi Pemrosesan</label>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="autoRetrain" checked>
                    <label class="form-check-label" for="autoRetrain">
                        Auto-retrain model setelah upload
                    </label>
                </div>
                <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="generateForecast" checked>
                    <label class="form-check-label" for="generateForecast">
                        Generate peramalan langsung
                    </label>
                </div>
            </div>
        </div>
        <div class="mt-3">
            <button class="btn btn-success" onclick="uploadData()">
                <i class="fas fa-upload me-2"></i>Upload Data
            </button>
        </div>
    </div>
</div>

<!-- Manual Input Section -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
        <h6 class="card-title mb-0">
            <i class="fas fa-edit text-info me-2"></i>Manual Input
        </h6>
    </div>
    <div class="card-body">
        <button class="btn btn-info" onclick="showManualInputModal()">
            <i class="fas fa-plus me-2"></i>Tambah Data Manual
        </button>
    </div>
</div>

<!-- Data Table -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <div>
            <h6 class="card-title mb-0">
                <i class="fas fa-database text-primary me-2"></i>Data Historis
            </h6>
            <small class="text-muted">
                <i class="fas fa-list me-1"></i>Total: <strong id="totalRecordsCount">{{ total_records if total_records else 0 }}</strong> record
            </small>
        </div>
        <div>
            <input type="text" class="form-control form-control-sm d-inline-block" style="width: 200px;" 
                   placeholder="Search..." id="searchInput">
        </div>
    </div>
    <div class="card-body">
        <div id="dataTableContainer">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">Memuat data...</p>
            </div>
        </div>
    </div>
</div>

<!-- Manual Input Modal -->
<div class="modal fade" id="manualInputModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="fas fa-keyboard me-2"></i>Input Manual Data IPH & Komoditas
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="manualInputForm">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualBulan" class="form-label">
                                    <i class="fas fa-calendar me-1"></i>Bulan
                                </label>
                                <select class="form-select" id="manualBulan" required>
                                    <option value="">Pilih Bulan</option>
                                    <option value="Januari">Januari</option>
                                    <option value="Februari">Februari</option>
                                    <option value="Maret">Maret</option>
                                    <option value="April">April</option>
                                    <option value="Mei">Mei</option>
                                    <option value="Juni">Juni</option>
                                    <option value="Juli">Juli</option>
                                    <option value="Agustus">Agustus</option>
                                    <option value="September">September</option>
                                    <option value="Oktober">Oktober</option>
                                    <option value="November">November</option>
                                    <option value="Desember">Desember</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualMinggu" class="form-label">
                                    <i class="fas fa-calendar-week me-1"></i>Minggu ke-
                                </label>
                                <select class="form-select" id="manualMinggu" required>
                                    <option value="">Pilih Minggu</option>
                                    <option value="M1">M1</option>
                                    <option value="M2">M2</option>
                                    <option value="M3">M3</option>
                                    <option value="M4">M4</option>
                                    <option value="M5">M5</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualTahun" class="form-label">
                                    <i class="fas fa-calendar-alt me-1"></i>Tahun
                                </label>
                                <input type="number" class="form-control" id="manualTahun" 
                                       value="2024" min="2020" max="2100" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualKabKota" class="form-label">
                                    <i class="fas fa-map-marker-alt me-1"></i>Kab/Kota
                                </label>
                                <input type="text" class="form-control" id="manualKabKota" 
                                       value="BATU" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manualIPH" class="form-label">
                            <i class="fas fa-chart-line me-1"></i>Indikator Perubahan Harga (%)
                        </label>
                        <input type="number" step="0.001" class="form-control" id="manualIPH" 
                               placeholder="e.g., 1.25 atau -0.85" required>
                        <div class="form-text">Masukkan nilai IPH dalam persen (positif untuk inflasi, negatif untuk deflasi)</div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="manualKomoditasAndil" class="form-label">
                            <i class="fas fa-seedling me-1"></i>Komoditas Andil Perubahan Harga
                        </label>
                        <input type="text" class="form-control" id="manualKomoditasAndil" 
                               placeholder="e.g., BERAS(0.5);CABAI(0.3);MINYAK GORENG(0.2)">
                        <div class="form-text">Format: KOMODITAS(nilai);KOMODITAS(nilai)</div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualKomoditasFluktuasi" class="form-label">
                                    <i class="fas fa-chart-bar me-1"></i>Komoditas Fluktuasi Tertinggi
                                </label>
                                <input type="text" class="form-control" id="manualKomoditasFluktuasi" 
                                       placeholder="e.g., CABAI RAWIT">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="manualNilaiFluktuasi" class="form-label">
                                    <i class="fas fa-percentage me-1"></i>Nilai Fluktuasi
                                </label>
                                <input type="number" step="0.0001" class="form-control" id="manualNilaiFluktuasi" 
                                       placeholder="e.g., 0.0553">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>Batal
                </button>
                <button type="button" class="btn btn-success" onclick="addManualRecord()">
                    <i class="fas fa-plus me-1"></i>Tambah Data
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Data Modal -->
<div class="modal fade" id="editDataModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title">
                    <i class="fas fa-edit me-2"></i>Edit Data
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="editDataForm">
                    <input type="hidden" id="editDataId">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editTanggal" class="form-label">Tanggal</label>
                                <input type="date" class="form-control" id="editTanggal" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editIPH" class="form-label">IPH Value (%)</label>
                                <input type="number" step="0.001" class="form-control" id="editIPH" required>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editBulan" class="form-label">Bulan</label>
                                <input type="text" class="form-control" id="editBulan">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editMinggu" class="form-label">Minggu</label>
                                <input type="text" class="form-control" id="editMinggu">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="editKabKota" class="form-label">Kab/Kota</label>
                                <input type="text" class="form-control" id="editKabKota">
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                <button type="button" class="btn btn-primary" onclick="saveEditData()">
                    <i class="fas fa-save me-1"></i>Simpan Perubahan
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Results Area -->
<div id="uploadResults"></div>
<div id="actionResults"></div>
{% endblock %}

{% block scripts %}
<script>
// Show upload modal (if needed in future)
function showUploadModal() {
    // Currently using inline form, but can be converted to modal if needed
    document.getElementById('fileUpload')?.click();
}

// Show manual input modal
function showManualInputModal() {
    const modal = new bootstrap.Modal(document.getElementById('manualInputModal'));
    modal.show();
}

// Add manual record
async function addManualRecord() {
    const formData = {
        bulan: document.getElementById('manualBulan').value,
        minggu: document.getElementById('manualMinggu').value,
        tahun: parseInt(document.getElementById('manualTahun').value),
        kab_kota: document.getElementById('manualKabKota').value,
        iph_value: parseFloat(document.getElementById('manualIPH').value),
        komoditas_andil: document.getElementById('manualKomoditasAndil').value,
        komoditas_fluktuasi: document.getElementById('manualKomoditasFluktuasi').value,
        nilai_fluktuasi: parseFloat(document.getElementById('manualNilaiFluktuasi').value) || 0
    };
    
    // Validate required fields
    if (!formData.bulan || !formData.minggu || !formData.iph_value) {
        showAlert('Mohon isi semua field yang wajib diisi', 'warning');
        return;
    }
    
    try {
        showLoading('Menambahkan data manual...');
        
        const response = await fetch('/api/add-manual-record', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Data berhasil ditambahkan!', 'success');
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('manualInputModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('manualInputForm').reset();
            document.getElementById('manualTahun').value = '2024';
            document.getElementById('manualKabKota').value = 'BATU';
            
            // Reload data table
            loadDataTable(currentPage);
        } else {
            showAlert(`Error: ${result.message}`, 'danger');
        }
        
    } catch (error) {
        showAlert(`Error menambahkan data: ${error.message}`, 'danger');
    } finally {
        hideLoading();
    }
}

// Upload data
async function uploadData() {
    const fileInput = document.getElementById('fileUpload');
    const file = fileInput?.files[0];
    
    if (!file) {
        showAlert('Silakan pilih file terlebih dahulu', 'warning');
        return;
    }
    
    const forecastWeeks = document.getElementById('forecastWeeks')?.value || 8;
    const formData = new FormData();
    formData.append('file', file);
    formData.append('forecast_weeks', forecastWeeks);
    
    try {
        showLoading('Mengupload dan memproses data...');
        
        const response = await fetch('/api/upload-data', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('✅ Data berhasil diupload dan diproses!', 'success');
            fileInput.value = '';
            
            // Reload data table
            setTimeout(() => {
                loadDataTable(1);
            }, 2000);
        } else {
            showAlert(`❌ Error: ${result.message || result.error}`, 'danger');
        }
    } catch (error) {
        showAlert(`❌ Error: ${error.message}`, 'danger');
    } finally {
        hideLoading();
    }
}

// Load data table
let currentPage = 1;
const perPage = 20;

function loadDataTable(page = 1) {
    const search = document.getElementById('searchInput')?.value || '';
    const url = `/admin/api/data/list?page=${page}&per_page=${perPage}&search=${encodeURIComponent(search)}`;
    
    document.getElementById('dataTableContainer').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">Memuat data...</p>
        </div>
    `;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderDataTable(data.data);
                currentPage = page;
                
                // Update total records count
                if (data.data && data.data.pagination && data.data.pagination.total !== undefined) {
                    const totalCountElement = document.getElementById('totalRecordsCount');
                    if (totalCountElement) {
                        totalCountElement.textContent = data.data.pagination.total;
                    }
                }
            } else {
                document.getElementById('dataTableContainer').innerHTML = 
                    `<div class="alert alert-danger">Error: ${data.error || 'Gagal memuat data'}</div>`;
            }
        })
        .catch(error => {
            document.getElementById('dataTableContainer').innerHTML = 
                `<div class="alert alert-danger">Error: ${error.message}</div>`;
        });
}

function renderDataTable(data) {
    if (!data.items || data.items.length === 0) {
        document.getElementById('dataTableContainer').innerHTML = 
            `<div class="alert alert-info">Tidak ada data</div>`;
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Bulan</th>
                        <th>Minggu</th>
                        <th>IPH Value</th>
                        <th>Kab/Kota</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.items.forEach(item => {
        const tanggal = item.tanggal ? (typeof item.tanggal === 'string' ? item.tanggal : item.tanggal.split('T')[0]) : '-';
        html += `
            <tr>
                <td>${tanggal}</td>
                <td>${item.bulan || '-'}</td>
                <td>${item.minggu || '-'}</td>
                <td>${item.indikator_harga ? item.indikator_harga.toFixed(2) : '-'}</td>
                <td>${item.kab_kota || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="editData(${item.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteData(${item.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `</tbody></table></div>`;
    
    // Pagination
    if (data.pagination && data.pagination.pages > 1) {
        html += `<nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
        `;
        
        for (let i = 1; i <= data.pagination.pages; i++) {
            html += `<li class="page-item ${i === data.pagination.page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadDataTable(${i}); return false;">${i}</a>
            </li>`;
        }
        
        html += `</ul></nav>`;
    }
    
    document.getElementById('dataTableContainer').innerHTML = html;
}

// Edit data
async function editData(id) {
    try {
        const response = await fetch(`/admin/api/data/${id}`);
        const result = await response.json();
        
        if (result.success && result.data) {
            const data = result.data;
            
            document.getElementById('editDataId').value = id;
            document.getElementById('editTanggal').value = data.tanggal ? (typeof data.tanggal === 'string' ? data.tanggal.split('T')[0] : data.tanggal) : '';
            document.getElementById('editIPH').value = data.indikator_harga || '';
            document.getElementById('editBulan').value = data.bulan || '';
            document.getElementById('editMinggu').value = data.minggu || '';
            document.getElementById('editKabKota').value = data.kab_kota || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editDataModal'));
            modal.show();
        } else {
            showAlert('Gagal memuat data untuk diedit', 'danger');
        }
    } catch (error) {
        showAlert(`Error: ${error.message}`, 'danger');
    }
}

// Save edit data
async function saveEditData() {
    const id = document.getElementById('editDataId').value;
    const data = {
        tanggal: document.getElementById('editTanggal').value,
        indikator_harga: parseFloat(document.getElementById('editIPH').value),
        bulan: document.getElementById('editBulan').value,
        minggu: document.getElementById('editMinggu').value,
        kab_kota: document.getElementById('editKabKota').value
    };
    
    try {
        showLoading('Menyimpan perubahan...');
        
        const response = await fetch(`/admin/api/data/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Data berhasil diupdate!', 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('editDataModal'));
            modal.hide();
            
            loadDataTable(currentPage);
        } else {
            showAlert(`Error: ${result.error || 'Gagal menyimpan perubahan'}`, 'danger');
        }
    } catch (error) {
        showAlert(`Error: ${error.message}`, 'danger');
    } finally {
        hideLoading();
    }
}

// Delete data
function deleteData(id) {
    if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) {
        return;
    }
    
    fetch(`/admin/api/data/${id}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Data berhasil dihapus', 'success');
            loadDataTable(currentPage);
        } else {
            showAlert('Error: ' + (data.error || 'Gagal menghapus data'), 'danger');
        }
    })
    .catch(error => showAlert('Error: ' + error.message, 'danger'));
}

// Utility functions
function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const resultsArea = document.getElementById('actionResults');
    if (resultsArea) {
        resultsArea.innerHTML = alertHtml;
        setTimeout(() => {
            const alert = resultsArea.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    } else {
        alert(message);
    }
}

function showLoading(message) {
    console.log('Loading:', message);
    // Can add loading overlay here if needed
}

function hideLoading() {
    // Hide loading overlay if added
}

// Search functionality
document.getElementById('searchInput')?.addEventListener('keyup', function(e) {
    if (e.key === 'Enter') {
        loadDataTable(1);
    }
});

// Load data table on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDataTable(1);
    console.log('Data Management page loaded');
});
</script>
{% endblock %}
