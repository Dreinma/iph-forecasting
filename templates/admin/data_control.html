{% extends "base_admin.html" %}

{% block page_title %}Data Management{% endblock %}
{% block page_subtitle %}Upload, edit, dan kelola data IPH{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Manajemen Data</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('static', filename='uploads/template_iph_komoditas.csv') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-download me-1"></i> Template
            </a>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="fas fa-upload me-1"></i> Upload CSV
            </button>
            <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#addManualModal">
                <i class="fas fa-plus me-1"></i> Tambah Manual
            </button>
        </div>
    </div>
</div>

<div class="modal fade" id="addManualModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="manualInputForm" onsubmit="submitManualData(event)">
                <div class="modal-header">
                    <h5 class="modal-title">Input Data Manual</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tahun</label>
                        <input type="number" class="form-control" name="tahun" value="2025" required>
                    </div>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-success">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Data Table -->
<div class="table-responsive">
    <table class="table table-striped table-sm" id="dataTable">
        <thead>
            <tr>
                <th>Tanggal</th>
                <th>Bulan</th>
                <th>Minggu</th>
                <th>Tahun</th>
                <th>IPH (%)</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="dataBody">
            </tbody>
    </table>
</div>

<div class="modal fade" id="editDataModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editDataForm" onsubmit="submitEditData(event)">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit_id" name="id">
                    <div class="mb-3">
                        <label class="form-label">IPH Value (%)</label>
                        <input type="number" step="0.01" class="form-control" id="edit_iph" name="indikator_harga" required>
                    </div>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Results Area -->
<div id="uploadResults"></div>
<div id="actionResults"></div>
{% endblock %}

{% block scripts %}
<script>
// Variabel Global
let currentPage = 1;
const perPage = 20;
let searchTimeout = null;

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Data Management page loaded');
    loadDataTable(1);
    
    // Search Listener (Debounce)
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('input', function(e) {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                loadDataTable(1);
            }, 500); // Tunggu 500ms setelah user berhenti mengetik
        });
    }
});

// --- LOAD DATA TABLE ---
async function loadDataTable(page = 1) {
    const search = document.getElementById('searchInput')?.value || '';
    // URL API yang sudah diperbaiki
    const url = `/admin/api/data/list?page=${page}&per_page=${perPage}&search=${encodeURIComponent(search)}`;
    
    const tbody = document.getElementById('dataBody'); // Pastikan ID ini ada di <tbody> tabel Anda
    
    // Tampilkan Loading
    tbody.innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-5">
                <div class="spinner-border text-primary mb-2" role="status"></div>
                <p class="text-muted small mb-0">Memuat data...</p>
            </td>
        </tr>
    `;
    
    try {
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.data) {
            renderTableRows(result.data.items);
            renderPagination(result.data.pagination);
            
            // Update total count di header card (jika ada elemennya)
            const totalEl = document.getElementById('totalRecordsCount'); // Ganti ID jika beda
            if (totalEl && result.data.pagination) {
                totalEl.textContent = result.data.pagination.total;
            }
            
            currentPage = page;
        } else {
            tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">${result.error || 'Gagal memuat data'}</td></tr>`;
        }
    } catch (error) {
        console.error('Load Error:', error);
        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-danger py-4">Error koneksi: ${error.message}</td></tr>`;
    }
}

// --- RENDER TABLE ROWS ---
function renderTableRows(items) {
    const tbody = document.getElementById('dataBody');
    tbody.innerHTML = '';
    
    if (!items || items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5 text-muted">Tidak ada data ditemukan</td></tr>`;
        return;
    }
    
    items.forEach(item => {
        // Format Tanggal (Fallback aman)
        let dateStr = item.tanggal; 
        if (item.tanggal && item.tanggal.includes('T')) {
            dateStr = item.tanggal.split('T')[0]; // Ambil YYYY-MM-DD
        }

        const sourceBadge = item.data_source === 'manual_input' 
            ? '<span class="badge bg-info">Manual</span>' 
            : '<span class="badge bg-secondary">Upload</span>';

        const row = `
            <tr>
                <td class="align-middle font-monospace small">${dateStr}</td>
                <td class="align-middle">${item.bulan || '-'}</td>
                <td class="align-middle">${item.minggu || '-'}</td>
                <td class="align-middle">${item.tahun || '-'}</td>
                <td class="align-middle fw-bold ${item.indikator_harga < 0 ? 'text-success' : 'text-danger'}">
                    ${item.indikator_harga ? item.indikator_harga.toFixed(2) : '0.00'}%
                </td>
                <td class="align-middle">
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" onclick='openEditModal(${JSON.stringify(item)})' title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteData(${item.id})" title="Hapus">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

// --- RENDER PAGINATION ---
function renderPagination(pagination) {
    // Pastikan Anda memiliki <div id="paginationContainer"></div> di HTML di bawah tabel
    const container = document.getElementById('paginationContainer');
    if (!container) return; // Skip jika container tidak ada

    if (pagination.pages <= 1) {
        container.innerHTML = ''; // Sembunyikan jika hanya 1 halaman
        return;
    }

    let html = `<nav><ul class="pagination justify-content-center mb-0">`;

    // Prev Button
    html += `
        <li class="page-item ${pagination.page === 1 ? 'disabled' : ''}">
            <button class="page-link" onclick="loadDataTable(${pagination.page - 1})">Prev</button>
        </li>
    `;

    // Page Numbers (Simple: Current +/- 1)
    const start = Math.max(1, pagination.page - 1);
    const end = Math.min(pagination.pages, pagination.page + 1);

    for (let i = start; i <= end; i++) {
        html += `
            <li class="page-item ${i === pagination.page ? 'active' : ''}">
                <button class="page-link" onclick="loadDataTable(${i})">${i}</button>
            </li>
        `;
    }

    // Next Button
    html += `
        <li class="page-item ${pagination.page === pagination.pages ? 'disabled' : ''}">
            <button class="page-link" onclick="loadDataTable(${pagination.page + 1})">Next</button>
        </li>
    `;

    html += `</ul></nav>`;
    container.innerHTML = html;
}

// --- CRUD OPERATIONS ---

// 1. Upload CSV
async function uploadData() {
    const fileInput = document.getElementById('fileUpload'); // Pastikan ID ini benar di HTML
    const file = fileInput?.files[0];
    
    if (!file) {
        showAlert('Silakan pilih file CSV/Excel terlebih dahulu', 'warning');
        return;
    }
    
    const formData = new FormData();
    formData.append('file', file);
    
    // Ambil tombol untuk loading state
    const btn = document.querySelector('button[onclick="uploadData()"]');
    if(btn) { btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Uploading...'; }

    try {
        const response = await fetch('/api/upload-data', {
            method: 'POST',
            body: formData
        });
        const result = await response.json();
        
        if (result.success) {
            showAlert(`‚úÖ Sukses! ${result.merge_info.new_records} data baru ditambahkan.`, 'success');
            fileInput.value = ''; // Reset input
            bootstrap.Modal.getInstance(document.getElementById('uploadModal')).hide(); // Tutup modal
            loadDataTable(1); // Reload tabel
        } else {
            showAlert(`‚ùå Gagal: ${result.message}`, 'danger');
        }
    } catch (error) {
        showAlert(`‚ùå Error: ${error.message}`, 'danger');
    } finally {
        if(btn) { btn.disabled = false; btn.innerHTML = '<i class="fas fa-upload me-1"></i> Upload'; }
    }
}

// 2. Add Manual
async function addManualRecord() {
    // Pastikan ID input di HTML sesuai dengan ini
    const data = {
        bulan: document.getElementById('manualBulan').value,
        minggu: document.getElementById('manualMinggu').value,
        tahun: document.getElementById('manualTahun').value,
        kab_kota: 'BATU', // Default
        iph_value: document.getElementById('manualIPH').value
    };

    if (!data.bulan || !data.minggu || !data.tahun || !data.iph_value) {
        alert('Mohon lengkapi semua field wajib!');
        return;
    }

    try {
        const response = await fetch('/admin/api/add-manual-record', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        
        if (result.success) {
            showAlert('Data manual berhasil disimpan', 'success');
            bootstrap.Modal.getInstance(document.getElementById('addManualModal')).hide();
            loadDataTable(1);
        } else {
            alert('Gagal: ' + result.message);
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// 3. Edit Data
function openEditModal(item) {
    document.getElementById('edit_id').value = item.id;
    document.getElementById('edit_iph').value = item.indikator_harga;
    // Set value lain jika form edit punya field lain
    const modal = new bootstrap.Modal(document.getElementById('editDataModal'));
    modal.show();
}

async function submitEditData(event) {
    event.preventDefault();
    const id = document.getElementById('edit_id').value;
    const iph = document.getElementById('edit_iph').value;

    try {
        const response = await fetch('/admin/api/data/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id: id, indikator_harga: iph })
        });
        const result = await response.json();
        if(result.success) {
            showAlert('Data berhasil diupdate', 'success');
            bootstrap.Modal.getInstance(document.getElementById('editDataModal')).hide();
            loadDataTable(currentPage);
        } else {
            alert('Gagal update: ' + result.message);
        }
    } catch (e) {
        alert('Error sistem: ' + e.message);
    }
}

// 4. Delete Data
async function deleteData(id) {
    if(!confirm('Yakin ingin menghapus data ini permanen?')) return;
    
    try {
        const response = await fetch(`/admin/api/data/${id}`, { method: 'DELETE' });
        const result = await response.json();
        if(result.success) {
            showAlert('Data dihapus', 'success');
            loadDataTable(currentPage);
        } else {
            alert('Gagal hapus: ' + result.error);
        }
    } catch(e) {
        alert('Error: ' + e.message);
    }
}

// --- UTILS ---
function showAlert(msg, type) {
    // Pastikan ada <div id="actionResults"></div> di HTML untuk menampilkan alert
    const container = document.getElementById('actionResults');
    if(container) {
        container.innerHTML = `
            <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                ${msg}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
    } else {
        alert(msg);
    }
}
</script>
{% endblock %}