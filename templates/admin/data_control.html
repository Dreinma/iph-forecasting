{% extends "base_admin.html" %}

{% block page_title %}Data Management{% endblock %}
{% block page_subtitle %}Upload, edit, dan kelola data IPH{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Manajemen Data</h1>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group me-2">
            <a href="{{ url_for('static', filename='uploads/template_iph_komoditas.csv') }}" class="btn btn-sm btn-outline-secondary">
                <i class="fas fa-download me-1"></i> Template
            </a>
            <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#uploadModal">
                <i class="fas fa-upload me-1"></i> Upload CSV
            </button>
            <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#addManualModal">
                <i class="fas fa-plus me-1"></i> Tambah Manual
            </button>
        </div>
    </div>
</div>

<div class="modal fade" id="addManualModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="manualInputForm" onsubmit="submitManualData(event)">
                <div class="modal-header">
                    <h5 class="modal-title">Input Data Manual</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Tahun</label>
                        <input type="number" class="form-control" name="tahun" value="2025" required>
                    </div>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-success">Simpan</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Data Table -->
<div class="table-responsive">
    <table class="table table-striped table-sm" id="dataTable">
        <thead>
            <tr>
                <th>Tanggal</th>
                <th>Bulan</th>
                <th>Minggu</th>
                <th>Tahun</th>
                <th>IPH (%)</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody id="dataBody">
            </tbody>
    </table>
</div>

<div class="modal fade" id="editDataModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editDataForm" onsubmit="submitEditData(event)">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Data</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="edit_id" name="id">
                    <div class="mb-3">
                        <label class="form-label">IPH Value (%)</label>
                        <input type="number" step="0.01" class="form-control" id="edit_iph" name="indikator_harga" required>
                    </div>
                    </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                    <button type="submit" class="btn btn-primary">Update</button>
                </div>
            </form>
        </div>
    </div>
</div>


<!-- Results Area -->
<div id="uploadResults"></div>
<div id="actionResults"></div>
{% endblock %}

{% block scripts %}
<script>

    
// Show upload modal (if needed in future)
function showUploadModal() {
    // Currently using inline form, but can be converted to modal if needed
    document.getElementById('fileUpload')?.click();
}

// Show manual input modal
function showManualInputModal() {
    const modal = new bootstrap.Modal(document.getElementById('manualInputModal'));
    modal.show();
}

// Add manual record
async function addManualRecord() {
    const formData = {
        bulan: document.getElementById('manualBulan').value,
        minggu: document.getElementById('manualMinggu').value,
        tahun: parseInt(document.getElementById('manualTahun').value),
        kab_kota: document.getElementById('manualKabKota').value,
        iph_value: parseFloat(document.getElementById('manualIPH').value),
        komoditas_andil: document.getElementById('manualKomoditasAndil').value,
        komoditas_fluktuasi: document.getElementById('manualKomoditasFluktuasi').value,
        nilai_fluktuasi: parseFloat(document.getElementById('manualNilaiFluktuasi').value) || 0
    };
    
    // Validate required fields
    if (!formData.bulan || !formData.minggu || !formData.iph_value) {
        showAlert('Mohon isi semua field yang wajib diisi', 'warning');
        return;
    }
    
    try {
        showLoading('Menambahkan data manual...');
        
        const response = await fetch('/api/add-manual-record', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Data berhasil ditambahkan!', 'success');
            
            // Hide modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('manualInputModal'));
            modal.hide();
            
            // Clear form
            document.getElementById('manualInputForm').reset();
            document.getElementById('manualTahun').value = '2024';
            document.getElementById('manualKabKota').value = 'BATU';
            
            // Reload data table
            loadDataTable(currentPage);
        } else {
            showAlert(`Error: ${result.message}`, 'danger');
        }
        
    } catch (error) {
        showAlert(`Error menambahkan data: ${error.message}`, 'danger');
    } finally {
        hideLoading();
    }
}

// Upload data
async function uploadData() {
    const fileInput = document.getElementById('fileUpload');
    const file = fileInput?.files[0];
    
    if (!file) {
        showAlert('Silakan pilih file terlebih dahulu', 'warning');
        return;
    }
    
    const forecastWeeks = document.getElementById('forecastWeeks')?.value || 8;
    const formData = new FormData();
    formData.append('file', file);
    formData.append('forecast_weeks', forecastWeeks);
    
    try {
        showLoading('Mengupload dan memproses data...');
        
        const response = await fetch('/api/upload-data', {
            method: 'POST',
            body: formData
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('✅ Data berhasil diupload dan diproses!', 'success');
            fileInput.value = '';
            
            // Reload data table
            setTimeout(() => {
                loadDataTable(1);
            }, 2000);
        } else {
            showAlert(`❌ Error: ${result.message || result.error}`, 'danger');
        }
    } catch (error) {
        showAlert(`❌ Error: ${error.message}`, 'danger');
    } finally {
        hideLoading();
    }
}

// Load data table
let currentPage = 1;
const perPage = 20;
async function loadData(page = 1) {
    const search = document.getElementById('searchInput')?.value || '';
    
    // PERBAIKAN: Gunakan URL '/admin/api/data/list'
    const url = `/admin/api/data/list?page=${page}&per_page=${perPage}&search=${encodeURIComponent(search)}`;
    
    const tbody = document.getElementById('dataBody');
    tbody.innerHTML = `
        <tr>
            <td colspan="7" class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">Memuat data...</p>
            </td>
        </tr>
    `;
    
    try {
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.data) {
            renderTable(result.data.items);
            updatePagination(result.data.pagination);
            
            // Update total records counter jika ada
            const totalEl = document.getElementById('totalRecords');
            if (totalEl) totalEl.textContent = result.data.pagination.total;
            
            currentPage = page;
        } else {
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">${result.error || 'Gagal memuat data'}</td></tr>`;
        }
    } catch (error) {
        console.error('Error loading data:', error);
        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">Error koneksi: ${error.message}</td></tr>`;
    }
}

function renderTable(items) {
    const tbody = document.getElementById('dataBody');
    tbody.innerHTML = '';
    
    if (items.length === 0) {
        tbody.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-muted">Tidak ada data ditemukan</td></tr>`;
        return;
    }
    
    items.forEach(item => {
        // Format tanggal
        let dateStr = item.tanggal;
        try {
            dateStr = new Date(item.tanggal).toLocaleDateString('id-ID', {day: 'numeric', month: 'long', year: 'numeric'});
        } catch(e) {}

        // PERBAIKAN: Gunakan properti yang benar (sesuai JSON response dari to_dict)
        const row = `
            <tr>
                <td>${dateStr}</td>
                <td>${item.bulan || '-'}</td>
                <td>${item.minggu || '-'}</td>
                <td>${item.tahun || '-'}</td>
                <td>${item.indikator_harga.toFixed(2)}%</td>
                <td>
                    <span class="badge ${item.data_source === 'manual_input' ? 'bg-info' : 'bg-secondary'}">
                        ${item.data_source === 'manual_input' ? 'Manual' : 'Upload'}
                    </span>
                </td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick='editData(${JSON.stringify(item)})' title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deleteData(${item.id})" title="Hapus">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });
}

function updatePagination(pagination) {
    const container = document.getElementById('paginationContainer'); // Pastikan ID ini ada di HTML
    if (!container) return;

    let html = `
        <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item ${pagination.page === 1 ? 'disabled' : ''}">
                    <button class="page-link" onclick="loadData(${pagination.page - 1})">Previous</button>
                </li>
                <li class="page-item disabled">
                    <span class="page-link">Halaman ${pagination.page} dari ${pagination.pages}</span>
                </li>
                <li class="page-item ${pagination.page === pagination.pages ? 'disabled' : ''}">
                    <button class="page-link" onclick="loadData(${pagination.page + 1})">Next</button>
                </li>
            </ul>
        </nav>
    `;
    container.innerHTML = html;
}

function loadDataTable(page = 1) {
    const search = document.getElementById('searchInput')?.value || '';
    const url = `/admin/api/data/list?page=${page}&per_page=${perPage}&search=${encodeURIComponent(search)}`;
    
    document.getElementById('dataTableContainer').innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary" role="status"></div>
            <p class="text-muted mt-2">Memuat data...</p>
        </div>
    `;
    
    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderDataTable(data.data);
                currentPage = page;
                
                // Update total records count
                if (data.data && data.data.pagination && data.data.pagination.total !== undefined) {
                    const totalCountElement = document.getElementById('totalRecordsCount');
                    if (totalCountElement) {
                        totalCountElement.textContent = data.data.pagination.total;
                    }
                }
            } else {
                document.getElementById('dataTableContainer').innerHTML = 
                    `<div class="alert alert-danger">Error: ${data.error || 'Gagal memuat data'}</div>`;
            }
        })
        .catch(error => {
            document.getElementById('dataTableContainer').innerHTML = 
                `<div class="alert alert-danger">Error: ${error.message}</div>`;
        });
}

function renderDataTable(data) {
    if (!data.items || data.items.length === 0) {
        document.getElementById('dataTableContainer').innerHTML = 
            `<div class="alert alert-info">Tidak ada data</div>`;
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Tanggal</th>
                        <th>Bulan</th>
                        <th>Minggu</th>
                        <th>IPH Value</th>
                        <th>Kab/Kota</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    data.items.forEach(item => {
        const tanggal = item.tanggal ? (typeof item.tanggal === 'string' ? item.tanggal : item.tanggal.split('T')[0]) : '-';
        html += `
            <tr>
                <td>${tanggal}</td>
                <td>${item.bulan || '-'}</td>
                <td>${item.minggu || '-'}</td>
                <td>${item.indikator_harga ? item.indikator_harga.toFixed(2) : '-'}</td>
                <td>${item.kab_kota || '-'}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="editData(${item.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteData(${item.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `</tbody></table></div>`;
    
    // Pagination
    if (data.pagination && data.pagination.pages > 1) {
        html += `<nav aria-label="Page navigation">
            <ul class="pagination justify-content-center">
        `;
        
        for (let i = 1; i <= data.pagination.pages; i++) {
            html += `<li class="page-item ${i === data.pagination.page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="loadDataTable(${i}); return false;">${i}</a>
            </li>`;
        }
        
        html += `</ul></nav>`;
    }
    
    document.getElementById('dataTableContainer').innerHTML = html;
}

function renderRow(item) {
    return `
        <tr>
            <td>${item.Tanggal || '-'}</td>
            <td>${item.Bulan || '-'}</td>
            <td>${item.Minggu || '-'}</td>
            <td>${item.Tahun || '-'}</td>
            <td>${item['Indikator_Harga']}</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" 
                    onclick='openEditModal(${JSON.stringify(item)})'>
                    <i class="fas fa-edit"></i>
                </button>
            </td>
        </tr>
    `;
}

function openEditModal(item) {
    // Pastikan item memiliki ID (perlu disesuaikan jika API list data belum return ID)
    // Jika data list belum return ID, Anda harus update backend 'get_data_list' dulu
    document.getElementById('edit_id').value = item.id || ''; 
    document.getElementById('edit_iph').value = item['Indikator_Harga'];
    
    const modal = new bootstrap.Modal(document.getElementById('editDataModal'));
    modal.show();
}

async function submitEditData(event) {
    event.preventDefault();
    const form = document.getElementById('editDataForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());

    // Anda perlu membuat route API ini di admin/routes.py
    try {
        const response = await fetch('/api/data/update', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });
        const result = await response.json();
        if(result.success) {
            alert('Data berhasil diupdate');
            bootstrap.Modal.getInstance(document.getElementById('editDataModal')).hide();
            loadData(); // Reload tabel
        } else {
            alert('Gagal: ' + result.message);
        }
    } catch (e) {
        alert('Error sistem');
    }
}

// Edit data
async function editData(id) {
    try {
        const response = await fetch(`/admin/api/data/${id}`);
        const result = await response.json();
        
        if (result.success && result.data) {
            const data = result.data;
            
            document.getElementById('editDataId').value = id;
            document.getElementById('editTanggal').value = data.tanggal ? (typeof data.tanggal === 'string' ? data.tanggal.split('T')[0] : data.tanggal) : '';
            document.getElementById('editIPH').value = data.indikator_harga || '';
            document.getElementById('editBulan').value = data.bulan || '';
            document.getElementById('editMinggu').value = data.minggu || '';
            document.getElementById('editKabKota').value = data.kab_kota || '';
            
            const modal = new bootstrap.Modal(document.getElementById('editDataModal'));
            modal.show();
        } else {
            showAlert('Gagal memuat data untuk diedit', 'danger');
        }
    } catch (error) {
        showAlert(`Error: ${error.message}`, 'danger');
    }
}

// Save edit data
async function saveEditData() {
    const id = document.getElementById('editDataId').value;
    const data = {
        tanggal: document.getElementById('editTanggal').value,
        indikator_harga: parseFloat(document.getElementById('editIPH').value),
        bulan: document.getElementById('editBulan').value,
        minggu: document.getElementById('editMinggu').value,
        kab_kota: document.getElementById('editKabKota').value
    };
    
    try {
        showLoading('Menyimpan perubahan...');
        
        const response = await fetch(`/admin/api/data/${id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Data berhasil diupdate!', 'success');
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('editDataModal'));
            modal.hide();
            
            loadDataTable(currentPage);
        } else {
            showAlert(`Error: ${result.error || 'Gagal menyimpan perubahan'}`, 'danger');
        }
    } catch (error) {
        showAlert(`Error: ${error.message}`, 'danger');
    } finally {
        hideLoading();
    }
}

// Delete data
function deleteData(id) {
    if (!confirm('Apakah Anda yakin ingin menghapus data ini?')) {
        return;
    }
    
    fetch(`/admin/api/data/${id}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json',
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Data berhasil dihapus', 'success');
            loadDataTable(currentPage);
        } else {
            showAlert('Error: ' + (data.error || 'Gagal menghapus data'), 'danger');
        }
    })
    .catch(error => showAlert('Error: ' + error.message, 'danger'));
}

// Utility functions
function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const resultsArea = document.getElementById('actionResults');
    if (resultsArea) {
        resultsArea.innerHTML = alertHtml;
        setTimeout(() => {
            const alert = resultsArea.querySelector('.alert');
            if (alert) {
                alert.remove();
            }
        }, 5000);
    } else {
        alert(message);
    }
}

function showLoading(message) {
    console.log('Loading:', message);
    // Can add loading overlay here if needed
}

function hideLoading() {
    // Hide loading overlay if added
}

// Search functionality
document.getElementById('searchInput')?.addEventListener('keyup', function(e) {
    if (e.key === 'Enter') {
        loadDataTable(1);
    }
});

// Load data table on page load
document.addEventListener('DOMContentLoaded', function() {
    loadDataTable(1);
    console.log('Data Management page loaded');
});
</script>
{% endblock %}
