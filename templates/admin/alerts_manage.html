{% extends "base_admin.html" %}

{% block page_title %}Alert Management{% endblock %}
{% block page_subtitle %}Kelola alert rules dan history{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center mb-4 gap-3">
    <div>
        <h5 class="mb-1">Alert Management</h5>
        <p class="text-muted mb-0">Kelola alert rules, history, dan konfigurasi</p>
    </div>
    <div class="w-100 w-md-auto">
        <button type="button" class="btn btn-primary w-100 w-md-auto" onclick="showCreateRuleModal()">
            <i class="fas fa-plus me-2"></i>Create Alert Rule
        </button>
    </div>
</div>

<!-- Alert Rules -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white">
        <h6 class="card-title mb-0">
            <i class="fas fa-list text-primary me-2"></i>Alert Rules
        </h6>
    </div>
    <div class="card-body">
        <!-- Info Box: Cara Penggunaan Alert Rules -->
        <div class="alert alert-info mb-4">
            <h6 class="alert-heading">
                <i class="fas fa-info-circle me-2"></i>Cara Menggunakan Alert Rules
            </h6>
            <p class="mb-2"><strong>Alert Rules</strong> memungkinkan Anda membuat aturan peringatan khusus yang akan otomatis mengecek data IPH dan memicu alert jika kondisi terpenuhi.</p>
            
            <hr>
            
            <h6 class="mt-3 mb-2"><strong>Contoh Use Case:</strong></h6>
            <ul class="mb-2">
                <li><strong>Contoh 1:</strong> Buat rule "IPH Inflasi Tinggi" dengan threshold > 2.5% dan operator ">" → Sistem akan alert jika IPH lebih dari 2.5%</li>
                <li><strong>Contoh 2:</strong> Buat rule "IPH Deflasi Kritis" dengan threshold < -1.0% dan operator "<" → Sistem akan alert jika IPH turun di bawah -1.0%</li>
                <li><strong>Contoh 3:</strong> Buat rule "IPH Stabilitas" dengan threshold = 0.0% dan operator "==" → Sistem akan alert jika IPH tepat di 0% (stabil)</li>
            </ul>
            
            <h6 class="mt-3 mb-2"><strong>Komponen Rule:</strong></h6>
            <ul class="mb-0">
                <li><strong>Rule Name:</strong> Nama yang mudah diingat untuk rule ini</li>
                <li><strong>Rule Type:</strong> Threshold (cek nilai), Volatility (cek volatilitas), Trend (cek trend)</li>
                <li><strong>Threshold Value:</strong> Nilai batas yang akan dicek (contoh: 2.5 untuk 2.5%)</li>
                <li><strong>Comparison Operator:</strong> > (lebih besar), < (lebih kecil), >= (lebih besar/sama), <= (lebih kecil/sama), == (sama dengan)</li>
                <li><strong>Severity Level:</strong> Low (info), Medium (warning), High (perhatian), Critical (kritis)</li>
            </ul>
            
            <div class="mt-3">
                <strong>Catatan:</strong> Alert Rules ini berbeda dengan alert otomatis sistem (2σ, 3σ). Rules ini adalah custom rules yang bisa Anda buat sesuai kebutuhan khusus.
            </div>
        </div>
        
        <div id="alertRulesList">
            <div class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">Memuat alert rules...</p>
            </div>
        </div>
    </div>
</div>

<!-- Alert History -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0">
            <i class="fas fa-history text-info me-2"></i>Alert History
        </h6>
        <div>
            <select class="form-select form-select-sm d-inline-block" style="width: auto;" id="filterSeverity">
                <option value="">All Severity</option>
                <option value="low">Low</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
            </select>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Type</th>
                        <th>Severity</th>
                        <th>Message</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="alertHistoryBody">
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="text-muted mt-2">Memuat history...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Note: Alert Configuration removed - Statistical boundaries (2σ, 3σ) are calculated dynamically from data, not from configuration -->
{% endblock %}

{% block scripts %}
<script>
let currentAlertPage = 1;
const alertPerPage = 20;

// Load alert rules
async function loadAlertRules() {
    try {
        const response = await fetch('/admin/api/alerts/rules');
        const result = await response.json();
        
        if (result.success && result.rules) {
            renderAlertRules(result.rules);
        } else {
            showAlert('Gagal memuat alert rules', 'danger');
        }
    } catch (error) {
        document.getElementById('alertRulesList').innerHTML = `
            <div class="alert alert-danger">Error: ${error.message}</div>
        `;
    }
}

function renderAlertRules(rules) {
    const container = document.getElementById('alertRulesList');
    
    if (!rules || rules.length === 0) {
        container.innerHTML = `
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                Belum ada alert rules. Klik "Create Alert Rule" untuk membuat rule baru.
            </div>
        `;
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover">';
    html += `
        <thead>
            <tr>
                <th>Rule Name</th>
                <th>Type</th>
                <th>Threshold</th>
                <th>Severity</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
    `;
    
    rules.forEach(rule => {
        const statusBadge = rule.is_active 
            ? '<span class="badge bg-success">Active</span>' 
            : '<span class="badge bg-secondary">Inactive</span>';
        
        html += `
            <tr>
                <td><strong>${rule.rule_name}</strong></td>
                <td>${rule.rule_type}</td>
                <td>${rule.threshold_value || '-'}</td>
                <td><span class="badge bg-${getSeverityColor(rule.severity_level)}">${rule.severity_level}</span></td>
                <td>${statusBadge}</td>
                <td>
                    <button class="btn btn-sm btn-info" onclick="editRule(${rule.id})" title="Edit">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-danger" onclick="deleteRule(${rule.id})" title="Delete">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.innerHTML = html;
}

function getSeverityColor(severity) {
    const colors = {
        'low': 'info',
        'medium': 'warning',
        'high': 'danger',
        'critical': 'dark'
    };
    return colors[severity.toLowerCase()] || 'secondary';
}

// Load alert history
async function loadAlertHistory(page = 1) {
    const severityFilter = document.getElementById('filterSeverity')?.value || '';
    const url = `/admin/api/alerts/history?page=${page}&per_page=${alertPerPage}${severityFilter ? '&severity=' + encodeURIComponent(severityFilter) : ''}`;
    
    document.getElementById('alertHistoryBody').innerHTML = `
        <tr>
            <td colspan="6" class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">Memuat history...</p>
            </td>
        </tr>
    `;
    
    try {
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.data) {
            renderAlertHistory(result.data);
            currentAlertPage = page;
        } else {
            showAlert('Gagal memuat alert history', 'danger');
        }
    } catch (error) {
        document.getElementById('alertHistoryBody').innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <div class="alert alert-danger">Error: ${error.message}</div>
                </td>
            </tr>
        `;
    }
}

function renderAlertHistory(data) {
    const tbody = document.getElementById('alertHistoryBody');
    
    if (!data.items || data.items.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Belum ada alert history</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    data.items.forEach(alert => {
        const date = alert.created_at ? new Date(alert.created_at).toLocaleDateString('id-ID') : '-';
        const statusBadge = alert.acknowledged 
            ? '<span class="badge bg-success">Acknowledged</span>' 
            : '<span class="badge bg-warning">Pending</span>';
        
        html += `
            <tr>
                <td>${date}</td>
                <td>${alert.alert_type || '-'}</td>
                <td><span class="badge bg-${getSeverityColor(alert.severity)}">${alert.severity}</span></td>
                <td>${alert.title || alert.message || '-'}</td>
                <td>${statusBadge}</td>
                <td>
                    ${!alert.acknowledged ? `
                        <button class="btn btn-sm btn-success" onclick="acknowledgeAlert(${alert.id})" title="Acknowledge">
                            <i class="fas fa-check"></i>
                        </button>
                    ` : ''}
                </td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
}

// Create/Edit Rule Modal
function showCreateRuleModal(ruleId = null) {
    const modalHtml = `
        <div class="modal fade" id="ruleModal" tabindex="-1">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header bg-primary text-white">
                        <h5 class="modal-title">
                            <i class="fas fa-${ruleId ? 'edit' : 'plus'} me-2"></i>
                            ${ruleId ? 'Edit' : 'Create'} Alert Rule
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="ruleForm">
                            <input type="hidden" id="ruleId" value="${ruleId || ''}">
                            <div class="mb-3">
                                <label class="form-label">Rule Name</label>
                                <input type="text" class="form-control" id="ruleName" required>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Rule Type</label>
                                        <select class="form-select" id="ruleType">
                                            <option value="threshold">Threshold</option>
                                            <option value="volatility">Volatility</option>
                                            <option value="trend">Trend</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Severity Level</label>
                                        <select class="form-select" id="severityLevel">
                                            <option value="low">Low</option>
                                            <option value="medium">Medium</option>
                                            <option value="high">High</option>
                                            <option value="critical">Critical</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Threshold Value</label>
                                        <input type="number" step="0.01" class="form-control" id="thresholdValue">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="form-label">Comparison Operator</label>
                                        <select class="form-select" id="comparisonOperator">
                                            <option value=">">Greater Than (>)</option>
                                            <option value="<">Less Than (<)</option>
                                            <option value=">=">Greater or Equal (>=)</option>
                                            <option value="<=">Less or Equal (<=)</option>
                                            <option value="==">Equal (==)</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="ruleDescription" rows="3"></textarea>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="ruleIsActive" checked>
                                <label class="form-check-label" for="ruleIsActive">Active</label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Batal</button>
                        <button type="button" class="btn btn-primary" onclick="saveRule()">
                            <i class="fas fa-save me-1"></i>Simpan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal
    const existing = document.getElementById('ruleModal');
    if (existing) existing.remove();
    
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('ruleModal'));
    
    if (ruleId) {
        loadRuleData(ruleId);
    }
    
    modal.show();
}

async function loadRuleData(ruleId) {
    try {
        const response = await fetch(`/admin/api/alerts/rules`);
        const result = await response.json();
        
        if (result.success && result.rules) {
            const rule = result.rules.find(r => r.id === ruleId);
            if (rule) {
                document.getElementById('ruleName').value = rule.rule_name || '';
                document.getElementById('ruleType').value = rule.rule_type || 'threshold';
                document.getElementById('severityLevel').value = rule.severity_level || 'medium';
                document.getElementById('thresholdValue').value = rule.threshold_value || '';
                document.getElementById('comparisonOperator').value = rule.comparison_operator || '>';
                document.getElementById('ruleDescription').value = rule.description || '';
                document.getElementById('ruleIsActive').checked = rule.is_active !== false;
            }
        }
    } catch (error) {
        showAlert('Error loading rule: ' + error.message, 'danger');
    }
}

async function saveRule() {
    const ruleId = document.getElementById('ruleId').value;
    const data = {
        rule_name: document.getElementById('ruleName').value,
        rule_type: document.getElementById('ruleType').value,
        severity_level: document.getElementById('severityLevel').value,
        threshold_value: parseFloat(document.getElementById('thresholdValue').value) || null,
        comparison_operator: document.getElementById('comparisonOperator').value,
        description: document.getElementById('ruleDescription').value,
        is_active: document.getElementById('ruleIsActive').checked
    };
    
    if (!data.rule_name) {
        showAlert('Rule name harus diisi', 'warning');
        return;
    }
    
    try {
        const url = ruleId 
            ? `/admin/api/alerts/rules/${ruleId}`
            : '/admin/api/alerts/rules';
        const method = ruleId ? 'PUT' : 'POST';
        
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Alert rule berhasil disimpan', 'success');
            const modal = bootstrap.Modal.getInstance(document.getElementById('ruleModal'));
            modal.hide();
            loadAlertRules();
        } else {
            showAlert('Error: ' + (result.error || 'Gagal menyimpan rule'), 'danger');
        }
    } catch (error) {
        showAlert('Error: ' + error.message, 'danger');
    }
}

function editRule(ruleId) {
    showCreateRuleModal(ruleId);
}

async function deleteRule(ruleId) {
    if (!confirm('Apakah Anda yakin ingin menghapus alert rule ini?')) {
        return;
    }
    
    try {
        const response = await fetch(`/admin/api/alerts/rules/${ruleId}`, {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Alert rule berhasil dihapus', 'success');
            loadAlertRules();
        } else {
            showAlert('Error: ' + (result.error || 'Gagal menghapus rule'), 'danger');
        }
    } catch (error) {
        showAlert('Error: ' + error.message, 'danger');
    }
}

async function acknowledgeAlert(alertId) {
    try {
        const response = await fetch(`/admin/api/alerts/${alertId}/acknowledge`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({})
        });
        
        const result = await response.json();
        
        if (result.success) {
            showAlert('Alert berhasil di-acknowledge', 'success');
            loadAlertHistory(currentAlertPage);
        } else {
            showAlert('Error: ' + (result.error || 'Gagal acknowledge alert'), 'danger');
        }
    } catch (error) {
        showAlert('Error: ' + error.message, 'danger');
    }
}

// Alert Configuration form removed - Statistical boundaries are calculated dynamically from data

// Utility functions
function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container-fluid') || document.body;
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) alert.remove();
    }, 5000);
}

// Event listeners
document.getElementById('filterSeverity')?.addEventListener('change', function() {
    loadAlertHistory(1);
});

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadAlertRules();
    loadAlertHistory(1);
    console.log('Alert management page loaded');
});
</script>
{% endblock %}

