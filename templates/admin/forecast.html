{% extends "base_admin.html" %}

{% block page_title %}Forecast Management{% endblock %}
{% block page_subtitle %}History dan analitik forecast{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h5 class="mb-1">Forecast Management</h5>
        <p class="text-muted mb-0">History dan analitik forecast yang pernah dibuat</p>
    </div>
    <div>
        <button type="button" class="btn btn-outline-secondary" onclick="exportForecastHistory()">
            <i class="fas fa-download me-2"></i>Export History
        </button>
    </div>
</div>

<!-- Forecast Statistics -->
<div class="row g-4 mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h6 class="text-muted mb-2">Total Forecasts</h6>
                <h3 id="totalForecasts">-</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h6 class="text-muted mb-2">This Month</h6>
                <h3 id="forecastsThisMonth">-</h3>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <h6 class="text-muted mb-2">Most Used Model</h6>
                <h3 id="mostUsedModel">-</h3>
            </div>
        </div>
    </div>
</div>

<!-- Forecast History Table -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h6 class="card-title mb-0">
            <i class="fas fa-history text-primary me-2"></i>Forecast History
        </h6>
        <div>
            <select class="form-select form-select-sm d-inline-block" style="width: auto;" id="filterModel">
                <option value="">All Models</option>
                <option value="XGBoost">XGBoost</option>
                <option value="LightGBM">LightGBM</option>
                <option value="Random_Forest">Random Forest</option>
                <option value="KNN">KNN</option>
            </select>
        </div>
    </div>
    <div class="card-body">
        <div class="table-responsive">
            <table class="table table-hover" id="forecastHistoryTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Date</th>
                        <th>Model</th>
                        <th>Weeks</th>
                        <th>Avg Prediction</th>
                        <th>Trend</th>
                    </tr>
                </thead>
                <tbody id="forecastHistoryBody">
                    <tr>
                        <td colspan="6" class="text-center py-4">
                            <div class="spinner-border text-primary" role="status"></div>
                            <p class="text-muted mt-2">Memuat history...</p>
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Forecast Analytics -->
<div class="card border-0 shadow-sm">
    <div class="card-header bg-white">
        <h6 class="card-title mb-0">
            <i class="fas fa-chart-pie text-info me-2"></i>Forecast Analytics
        </h6>
    </div>
    <div class="card-body">
        <div id="forecastAnalyticsChart" style="height: 400px;"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
let currentForecastPage = 1;
const forecastPerPage = 20;

// Load forecast statistics
async function loadForecastStatistics() {
    try {
        const response = await fetch('/admin/api/forecasts/statistics');
        const result = await response.json();
        
        if (result.success && result.statistics) {
            document.getElementById('totalForecasts').textContent = result.statistics.total_forecasts || 0;
            document.getElementById('forecastsThisMonth').textContent = result.statistics.this_month || 0;
            document.getElementById('mostUsedModel').textContent = result.statistics.most_used_model || 'N/A';
        }
    } catch (error) {
        console.error('Error loading statistics:', error);
    }
}

// Load forecast history
async function loadForecastHistory(page = 1) {
    const modelFilter = document.getElementById('filterModel')?.value || '';
    const url = `/admin/api/forecasts/history?page=${page}&per_page=${forecastPerPage}${modelFilter ? '&model=' + encodeURIComponent(modelFilter) : ''}`;
    
    document.getElementById('forecastHistoryBody').innerHTML = `
        <tr>
            <td colspan="5" class="text-center py-4">
                <div class="spinner-border text-primary" role="status"></div>
                <p class="text-muted mt-2">Memuat history...</p>
            </td>
        </tr>
    `;
    
    try {
        const response = await fetch(url);
        const result = await response.json();
        
        if (result.success && result.data) {
            renderForecastHistory(result.data);
            currentForecastPage = page;
        } else {
            showAlert('Gagal memuat forecast history: ' + (result.error || 'Unknown error'), 'danger');
        }
    } catch (error) {
        document.getElementById('forecastHistoryBody').innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-4">
                    <div class="alert alert-danger">Error: ${error.message}</div>
                </td>
            </tr>
        `;
    }
}

function renderForecastHistory(data) {
    const tbody = document.getElementById('forecastHistoryBody');
    
    if (!data.items || data.items.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center py-4">
                    <i class="fas fa-inbox fa-3x text-muted mb-3"></i>
                    <p class="text-muted">Belum ada forecast history</p>
                </td>
            </tr>
        `;
        return;
    }
    
    let html = '';
    data.items.forEach(item => {
        const date = item.created_at ? new Date(item.created_at).toLocaleDateString('id-ID') : '-';
        const avgPred = item.avg_prediction !== null && item.avg_prediction !== undefined 
            ? item.avg_prediction.toFixed(2) + '%' : '-';
        const trendBadge = item.trend === 'Naik' 
            ? '<span class="badge bg-success">Naik</span>' 
            : item.trend === 'Turun' 
            ? '<span class="badge bg-danger">Turun</span>' 
            : '<span class="badge bg-secondary">Stable</span>';
        
        html += `
            <tr>
                <td>#${item.id}</td>
                <td>${date}</td>
                <td><span class="badge bg-primary">${item.model_name || 'N/A'}</span></td>
                <td>${item.weeks_forecasted || 0} minggu</td>
                <td>${avgPred}</td>
                <td>${trendBadge}</td>
            </tr>
        `;
    });
    
    tbody.innerHTML = html;
    
    // Pagination
    if (data.pagination && data.pagination.pages > 1) {
        const paginationHtml = generatePagination(data.pagination, loadForecastHistory);
        tbody.insertAdjacentHTML('afterend', `<tr><td colspan="6">${paginationHtml}</td></tr>`);
    }
}

// Delete forecast removed - Forecast history should be preserved for audit trail

// Export forecast history
function exportForecastHistory() {
    window.location.href = '/admin/api/forecasts/export';
}

// Load analytics chart
async function loadForecastAnalytics() {
    try {
        // Get all forecasts for analytics
        const response = await fetch('/admin/api/forecasts/history?per_page=1000');
        const result = await response.json();
        
        if (result.success && result.data && result.data.items) {
            renderAnalyticsChart(result.data.items);
        }
    } catch (error) {
        console.error('Error loading analytics:', error);
    }
}

function renderAnalyticsChart(forecasts) {
    if (!forecasts || forecasts.length === 0) {
        document.getElementById('forecastAnalyticsChart').innerHTML = `
            <div class="text-center py-5 text-muted">
                <i class="fas fa-chart-pie fa-3x mb-3"></i>
                <p>Tidak ada data untuk analitik</p>
            </div>
        `;
        return;
    }
    
    // Group by model
    const modelCounts = {};
    const monthlyCounts = {};
    
    forecasts.forEach(forecast => {
        const model = forecast.model_name || 'Unknown';
        modelCounts[model] = (modelCounts[model] || 0) + 1;
        
        if (forecast.created_at) {
            const month = new Date(forecast.created_at).toLocaleDateString('id-ID', { year: 'numeric', month: 'short' });
            monthlyCounts[month] = (monthlyCounts[month] || 0) + 1;
        }
    });
    
    // Model distribution pie chart
    const modelData = {
        values: Object.values(modelCounts),
        labels: Object.keys(modelCounts),
        type: 'pie',
        name: 'Model Usage'
    };
    
    const modelLayout = {
        title: 'Forecast Distribution by Model',
        height: 300,
        margin: { l: 20, r: 20, t: 40, b: 20 }
    };
    
    Plotly.newPlot('forecastAnalyticsChart', [modelData], modelLayout, {responsive: true});
}

// Utility functions
function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const container = document.querySelector('.container-fluid') || document.body;
    container.insertAdjacentHTML('afterbegin', alertHtml);
    
    setTimeout(() => {
        const alert = container.querySelector('.alert');
        if (alert) alert.remove();
    }, 5000);
}

function generatePagination(pagination, callback) {
    let html = `<nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">`;
    
    for (let i = 1; i <= pagination.pages; i++) {
        html += `
            <li class="page-item ${i === pagination.page ? 'active' : ''}">
                <a class="page-link" href="#" onclick="${callback.name}(${i}); return false;">${i}</a>
            </li>
        `;
    }
    
    html += `</ul></nav>`;
    return html;
}

// Event listeners
document.getElementById('filterModel')?.addEventListener('change', function() {
    loadForecastHistory(1);
});

// Load data on page load
document.addEventListener('DOMContentLoaded', function() {
    loadForecastStatistics();
    loadForecastHistory(1);
    loadForecastAnalytics();
    console.log('Forecast management page loaded');
});
</script>
{% endblock %}

