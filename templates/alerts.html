{% extends "base.html" %}

{% block title %}Peringatan & Notifikasi Ekonomi - IPH Forecasting{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-3 mb-4 border-bottom">
    <div>
        <h1 class="h2 text-gradient mb-1">
            <i class="fas fa-chart-line me-2"></i>
            Analisis & Peringatan IPH Komoditas
        </h1>
        <p class="text-muted mb-0">Monitoring volatilitas dan peringatan perubahan harga komoditas</p>
    </div>
    <div class="btn-toolbar">
        <button type="button" class="btn btn-outline-primary" onclick="refreshAlerts()">
            <i class="fas fa-sync-alt me-1"></i>
            Refresh
        </button>
    </div>
</div>

<!-- IPH Komoditas Analysis -->
<div class="row g-4 mb-4 align-items-stretch">
    <div class="col-sm-12 col-md-4 col-lg-4">
        <div class="card bg-primary text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-white-50">IPH Saat Ini</h6>
                        <h3 class="mb-0" id="currentIPH">-0.83%</h3>
                        <small class="text-white-50">vs minggu lalu</small>
                    </div>
                    <i class="fas fa-chart-line fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-12 col-md-4 col-lg-4">
        <div class="card bg-warning text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-white-50">Volatilitas IPH</h6>
                        <h3 class="mb-0" id="iphVolatility">1.24</h3>
                        <small class="text-white-50">Standard Deviation</small>
                    </div>
                    <i class="fas fa-wave-square fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    <div class="col-sm-12 col-md-4 col-lg-4">
        <div class="card bg-info text-white h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <h6 class="text-white-50">Trend 4 Minggu</h6>
                        <h3 class="mb-0" id="iphTrend">-0.45%</h3>
                        <small class="text-white-50">Rata-rata perubahan</small>
                    </div>
                    <i class="fas fa-arrow-trend-down fa-2x opacity-50"></i>
                </div>
            </div>
        </div>
    </div>
    
</div>

<!-- Peringatan & Notifikasi IPH Komoditas (Full Width) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-bell text-warning me-2"></i>
                    Peringatan & Notifikasi IPH Komoditas
                </h5>
            </div>
            <div class="card-body">
                <div id="economicAlertsList">
                    <!-- Economic alerts will be loaded here -->
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Insight IPH Komoditas (Full Width) -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-lightbulb text-warning me-2"></i>
                    Insight IPH Komoditas
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-4">
                    <div class="col-md-6">
                        <div class="alert alert-info border-0 h-100">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-3">
                                    <i class="fas fa-info-circle fa-lg mt-1"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-2 fw-bold">Analisis IPH Terkini</h6>
                                    <p class="mb-2 text-dark">
                                        IPH menunjukkan penurunan -0.83% dibanding minggu lalu, 
                                        dipengaruhi penurunan harga beras (-1.26%) dan bawang merah (-0.29%).
                                    </p>
                                    <small class="text-muted d-flex align-items-center">
                                        <i class="fas fa-clock me-1"></i>
                                        Terakhir diperbarui: 25 Oktober 2025
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="alert alert-warning border-0 h-100">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0 me-3">
                                    <i class="fas fa-exclamation-triangle fa-lg mt-1"></i>
                                </div>
                                <div class="flex-grow-1">
                                    <h6 class="alert-heading mb-2 fw-bold">Peringatan Volatilitas Tinggi</h6>
                                    <p class="mb-2 text-dark">
                                        Volatilitas IPH mencapai 1.24 (standar deviasi), menunjukkan fluktuasi harga komoditas yang tinggi. 
                                        Cabai rawit dan bawang merah menunjukkan volatilitas ekstrem.
                                    </p>
                                    <small class="text-muted d-flex align-items-center">
                                        <i class="fas fa-clock me-1"></i>
                                        Terakhir diperbarui: 25 Oktober 2025
                                    </small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Analisis Komoditas Utama & Trend & Prediksi IPH (Side by Side) -->
<div class="row g-4">
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-bar text-info me-2"></i>
                    Analisis Komoditas Utama
                </h5>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Beras -->
                    <div class="col-12">
                        <div class="d-flex align-items-center p-3 bg-light rounded">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">Beras</h6>
                                <small class="text-muted">Komoditas utama</small>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="badge bg-success fs-6">-1.26%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Minyak Goreng -->
                    <div class="col-12">
                        <div class="d-flex align-items-center p-3 bg-light rounded">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">Minyak Goreng</h6>
                                <small class="text-muted">Fluktuasi tinggi</small>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="badge bg-warning fs-6">-0.25%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bawang Merah -->
                    <div class="col-12">
                        <div class="d-flex align-items-center p-3 bg-light rounded">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">Bawang Merah</h6>
                                <small class="text-muted">Volatilitas tinggi</small>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="badge bg-danger fs-6">-0.29%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cabai Rawit -->
                    <div class="col-12">
                        <div class="d-flex align-items-center p-3 bg-light rounded">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">Cabai Rawit</h6>
                                <small class="text-muted">Fluktuasi ekstrem</small>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="badge bg-danger fs-6">0.06%</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Telur Ayam -->
                    <div class="col-12">
                        <div class="d-flex align-items-center p-3 bg-light rounded">
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-bold">Telur Ayam Ras</h6>
                                <small class="text-muted">Stabil</small>
                            </div>
                            <div class="flex-shrink-0">
                                <span class="badge bg-info fs-6">0.02%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-6">
        <div class="card h-100">
            <div class="card-header bg-white">
                <h5 class="card-title mb-0">
                    <i class="fas fa-list-check text-success me-2"></i>
                    Rekomendasi Tindakan
                </h5>
            </div>
            <div class="card-body">
                <div>
                    <h6 class="text-dark mb-3 fw-bold">
                        <i class="fas fa-lightbulb text-warning me-2"></i>
                        Rekomendasi:
                    </h6>
                    <div class="list-group list-group-flush">
                        <div class="list-group-item d-flex align-items-center px-0 py-2">
                            <i class="fas fa-check text-success me-3"></i>
                            <span class="small">Monitor volatilitas cabai rawit & bawang merah</span>
                        </div>
                        <div class="list-group-item d-flex align-items-center px-0 py-2">
                            <i class="fas fa-check text-success me-3"></i>
                            <span class="small">Analisis dampak musim panen beras</span>
                        </div>
                        <div class="list-group-item d-flex align-items-center px-0 py-2">
                            <i class="fas fa-check text-success me-3"></i>
                            <span class="small">Perhatikan tren harga minyak goreng</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
// Economic alerts system JavaScript
let economicAlerts = [];
let economicIndicators = {};

async function loadEconomicAlerts() {
    try {
        const response = await fetch('/api/dashboard/economic-alerts');
        const data = await response.json();
        
        if (data.success) {
            economicAlerts = data.alerts || [];
            displayEconomicAlerts();
        } else {
            // Fallback: show sample economic alerts
            showSampleEconomicAlerts();
        }
    } catch (error) {
        console.error('Error loading economic alerts:', error);
        showSampleEconomicAlerts();
    }
}

async function loadEconomicIndicators() {
    try {
        const response = await fetch('/api/dashboard/economic-indicators');
        const data = await response.json();
        
        if (data.success) {
            economicIndicators = data.indicators;
            updateEconomicIndicators();
        } else {
            // Use default values
            updateEconomicIndicators();
        }
    } catch (error) {
        console.error('Error loading economic indicators:', error);
        updateEconomicIndicators();
    }
}

function displayEconomicAlerts() {
    const container = document.getElementById('economicAlertsList');
    
    if (economicAlerts.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-chart-line fa-3x mb-3"></i>
                <p>Tidak ada peringatan ekonomi terkini</p>
                <small>Peringatan akan muncul ketika ada perubahan signifikan pada indikator ekonomi</small>
            </div>
        `;
        return;
    }
    
    let html = '';
    economicAlerts.forEach(alert => {
        const priorityClass = {
            'critical': 'danger',
            'high': 'warning',
            'medium': 'info',
            'low': 'secondary'
        }[alert.priority] || 'secondary';
        
        const icon = {
            'volatility': 'fa-wave-square',
            'commodity': 'fa-seedling',
            'anomaly': 'fa-exclamation-triangle',
            'trend': 'fa-chart-line',
            'price': 'fa-tags',
            'seasonal': 'fa-calendar',
            'impact': 'fa-chart-bar'
        }[alert.type] || 'fa-bell';
        
        html += `
            <div class="alert alert-${priorityClass} border-0 mb-3" role="alert">
                <div class="d-flex align-items-start">
                    <div class="flex-shrink-0 me-3">
                        <i class="fas ${icon} fa-lg mt-1"></i>
                    </div>
                    <div class="flex-grow-1">
                        <h6 class="alert-heading mb-2 fw-bold">${alert.title}</h6>
                        <p class="mb-2 text-dark">${alert.message}</p>
                        <small class="text-muted d-flex align-items-center">
                            <i class="fas fa-calendar me-1"></i>
                            ${new Date(alert.timestamp).toLocaleDateString('id-ID')}
                        </small>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function showSampleEconomicAlerts() {
    const sampleAlerts = [
        {
            title: "Penurunan IPH Signifikan",
            message: "IPH turun -0.83% minggu ini, dipengaruhi penurunan harga beras (-1.26%) dan bawang merah (-0.29%).",
            priority: "high",
            type: "trend",
            timestamp: new Date().toISOString()
        },
        {
            title: "Volatilitas Tinggi Cabai Rawit",
            message: "Cabai rawit menunjukkan fluktuasi ekstrem dengan volatilitas 0.06%. Perlu monitoring ketat.",
            priority: "medium",
            type: "commodity",
            timestamp: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString()
        }
    ];
    
    economicAlerts = sampleAlerts;
    displayEconomicAlerts();
}

function updateEconomicIndicators() {
    // Update economic indicators with current or default values
    const indicators = {
        currentIPH: economicIndicators.currentIPH || "-0.83%",
        iphVolatility: economicIndicators.iphVolatility || "1.24",
        iphTrend: economicIndicators.iphTrend || "-0.45%"
    };
    
    document.getElementById('currentIPH').textContent = indicators.currentIPH;
    document.getElementById('iphVolatility').textContent = indicators.iphVolatility;
    document.getElementById('iphTrend').textContent = indicators.iphTrend;
    // anomalyCount removed from UI
}

function refreshAlerts() {
    loadEconomicAlerts();
    loadEconomicIndicators();
    showAlert('Data ekonomi diperbarui!', 'info');
}

function showAlert(message, type) {
    const alertHTML = `
        <div class="alert alert-${type} fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; max-width: 400px;" role="alert">
            <div class="d-flex align-items-center">
                <i class="fas fa-info-circle me-2"></i>
                ${message}
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', alertHTML);
    
    setTimeout(() => {
        const alerts = document.querySelectorAll('.alert');
        alerts.forEach(alert => {
            if (alert.textContent.includes(message.substring(0, 20))) {
                alert.remove();
            }
        });
    }, 5000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadEconomicAlerts();
    loadEconomicIndicators();
    
    // Auto-refresh every 60 seconds
    setInterval(() => {
        loadEconomicAlerts();
        loadEconomicIndicators();
    }, 60000);
});
</script>
{% endblock %}