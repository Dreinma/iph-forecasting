{% extends "base.html" %}

{% block title %}Insight Komoditas - IPH Monitoring{% endblock %}

{% block content %}
<!-- Page Header -->
<div class="pb-3 mb-4 border-bottom">
        <h1 class="h2 text-gradient mb-1">
            <i class="fas fa-wheat-awn me-2"></i>
            Insight Komoditas
        </h1>
        <p class="text-muted mb-0">Analisis dampak komoditas terhadap perubahan harga</p>
</div>

<!-- Current Week Insights -->
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-calendar-week text-primary me-2"></i>
                        Insight Minggu Ini
                    </h5>
                </div>
    <div class="card-body">
                <div id="currentWeekInsights">
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Memuat...</span>
                        </div>
                        <p class="mt-2 text-muted">Memuat insight minggu ini...</p>
            </div>
        </div>
    </div>
</div>
    
<!-- Commodity Trends -->
<div class="card mb-4 border-0 shadow-sm">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
                    <i class="fas fa-trending-up text-success me-2"></i>
                    Analisis Tren Komoditas
                </h5>
        <div class="d-flex align-items-center gap-2">
            <div class="d-flex align-items-center gap-2">
                <select class="form-select form-select-sm" id="trendStartMonth" style="width: auto;">
                    <option>Januari</option><option>Februari</option><option>Maret</option><option>April</option><option>Mei</option><option>Juni</option><option>Juli</option><option>Agustus</option><option>September</option><option>Oktober</option><option>November</option><option>Desember</option>
                </select>
                <select class="form-select form-select-sm" id="trendStartYear" style="width: auto;">
                    <option>2023</option><option>2024</option><option>2025</option>
                </select>
                <span class="text-muted small">s/d</span>
                <select class="form-select form-select-sm" id="trendEndMonth" style="width: auto;">
                    <option>Januari</option><option>Februari</option><option>Maret</option><option>April</option><option>Mei</option><option>Juni</option><option>Juli</option><option>Agustus</option><option>September</option><option>Oktober</option><option>November</option><option>Desember</option>
                </select>
                <select class="form-select form-select-sm" id="trendEndYear" style="width: auto;">
                    <option>2023</option><option>2024</option><option>2025</option>
                </select>
                <button class="btn btn-sm btn-primary" id="applyTrendWindowBtn">Terapkan</button>
            </div>
        </div>
            </div>
            <div class="card-body">
                <div id="commodityTrends">
                    <div class="text-center py-4">
                        <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Memuat...</span>
                        </div>
                        <p class="mt-2 text-muted">Menganalisis trend komoditas...</p>
            </div>
        </div>
    </div>
</div>

<!-- Ranking Komoditas Paling Berpengaruh -->
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-chart-bar text-primary me-2"></i>
            Top 5 Komoditas Paling Berpengaruh
                </h5>
        <div class="d-flex align-items-center gap-2">
            <div class="d-flex align-items-center gap-2">
                <select class="form-select form-select-sm" id="rankingStartMonth" style="width: auto;">
                    <option>Januari</option><option>Februari</option><option>Maret</option><option>April</option><option>Mei</option><option>Juni</option><option>Juli</option><option>Agustus</option><option>September</option><option>Oktober</option><option>November</option><option>Desember</option>
                </select>
                <select class="form-select form-select-sm" id="rankingStartYear" style="width: auto;">
                    <option>2023</option><option>2024</option><option>2025</option>
                </select>
                <span class="text-muted small">s/d</span>
                <select class="form-select form-select-sm" id="rankingEndMonth" style="width: auto;">
                    <option>Januari</option><option>Februari</option><option>Maret</option><option>April</option><option>Mei</option><option>Juni</option><option>Juli</option><option>Agustus</option><option>September</option><option>Oktober</option><option>November</option><option>Desember</option>
                </select>
                <select class="form-select form-select-sm" id="rankingEndYear" style="width: auto;">
                    <option>2023</option><option>2024</option><option>2025</option>
                </select>
                <button class="btn btn-sm btn-primary" id="applyRankingWindowBtn">Terapkan</button>
            </div>
        </div>
            </div>
            <div class="card-body">
        <div id="impactRanking" style="height: 400px;">
        </div>
    </div>
</div>


{% endblock %}


{% block scripts %}
<script>

// --- 1. FUNGSI API & HELPER ---

// Definisikan monthMap secara global agar bisa diakses semua fungsi
const monthMap = {Januari:'01', Februari:'02', Maret:'03', April:'04', Mei:'05', Juni:'06', Juli:'07', Agustus:'08', September:'09', Oktober:'10', November:'11', Desember:'12'};

/**
 * Panggilan API yang aman dengan timeout dan error handling.
 */
async function safeApiCall(url) {
    try {
        console.log(`üåê Memanggil API: ${url}`);
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 15000); // 15 detik timeout

        const response = await fetch(url, {
            signal: controller.signal,
            headers: { 'Accept': 'application/json', 'Content-Type': 'application/json' }
        });
        clearTimeout(timeoutId);

        if (!response.ok) {
            const errorText = await response.text();
            throw new Error(`HTTP ${response.status}: ${response.statusText} | ${errorText}`);
        }
        
        const data = await response.json();
        console.log(`‚úÖ Sukses API: ${url}`, data);
        return data;
    } catch (error) {
        console.error(`‚ùå Error API: ${url}`, error);
        if (error.name === 'AbortError') {
            return { success: false, error: 'Timeout', message: 'Permintaan API memakan waktu terlalu lama.' };
        }
        return { success: false, error: error.message, message: `Error Jaringan: ${error.message}` };
    }
}

/**
 * Memformat nama komoditas (e.g., CABAI_RAWIT -> cabai rawit)
 */
function formatCommodityName(rawName) {
    if (!rawName) return '';
    try {
        return String(rawName).replace(/_/g, ' ').toLowerCase();
    } catch (_) {
        return rawName;
    }
}

/**
 * Konfigurasi helper untuk badge trend
 */
function getTrendConfig(trend, strength) {
    const configs = {
        'increasing': { icon: 'üìà', text: 'Naik', color: strength === 'strong' ? 'danger' : 'warning' },
        'decreasing': { icon: 'üìâ', text: 'Turun', color: strength === 'strong' ? 'success' : 'info' },
        'stable': { icon: '‚û°Ô∏è', text: 'Stabil', color: 'secondary' },
        'insufficient_data': { icon: '?', text: 'Data Kurang', color: 'secondary' }
    };
    return configs[trend] || configs['stable'];
}

/**
 * Menampilkan pesan loading di container
 */
function showLoading(containerId, message, spinnerColor = 'primary') {
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = `
            <div class="text-center py-4">
                <div class="spinner-border text-${spinnerColor}" role="status">
                    <span class="visually-hidden">Memuat...</span>
                </div>
                <p class="text-muted mt-2">${message}</p>
            </div>`;
    }
}

/**
 * Menampilkan pesan error di container
 */
function showError(containerId, message, onRetryFunction = null) {
    const container = document.getElementById(containerId);
    if (container) {
        const retryButton = onRetryFunction
            ? `<button class="btn btn-outline-danger btn-sm mt-2" onclick="${onRetryFunction}"><i class="fas fa-redo me-1"></i>Coba Lagi</button>`
            : '';
        container.innerHTML = `
            <div class="alert alert-danger border-0">
                <div class="d-flex align-items-start">
                    <div class="me-3"><i class="fas fa-exclamation-triangle fa-lg"></i></div>
                    <div>
                        <h6 class="mb-1">Error</h6>
                        <small>${message}</small>
                        ${retryButton}
                    </div>
                </div>
            </div>`;
    }
}

// --- 2. FUNGSI RENDER (INSIGHT MINGGU INI) ---

async function loadCurrentWeekInsights() {
    console.log('üìÖ Memuat Insight Minggu Ini...');
    const containerId = 'currentWeekInsights';
    showLoading(containerId, 'Memuat insight minggu ini...', 'primary');
    
    try {
        const data = await safeApiCall('/api/commodity/current-week');
        if (data.success && data.iph_analysis) {
            document.getElementById(containerId).innerHTML = renderEnhancedCurrentWeekInsights(data);
        } else {
            showError(containerId, data.message || 'Data minggu ini tidak tersedia.', 'loadCurrentWeekInsights()');
        }
    } catch (error) {
        showError(containerId, error.message, 'loadCurrentWeekInsights()');
    }
}

function renderEnhancedCurrentWeekInsights(data) {
    // (Fungsi ini sama seperti di file Anda, tidak perlu diubah)
    const iph = data.iph_analysis;
    const period = data.period;
    const commodities = data.commodity_impacts;
    const deriveYear = () => {
        if (period && period.tanggal) {
            const y = new Date(period.tanggal).getFullYear();
            if (!isNaN(y)) return y;
        }
        const m = String(period?.bulan || '').match(/['`](\d{2})$/);
        if (m) return 2000 + parseInt(m[1], 10);
        return new Date().getFullYear();
    };
    const cleanMonth = String(period?.bulan || '').replace(/['`]\d{2}$/,'').trim();
    const weekNum = parseInt(String(period?.minggu || '').toString().replace(/\D/g,'')) || period?.minggu || '';
    const prettyPeriod = `${cleanMonth} ${deriveYear()} Minggu ${weekNum}`;
    
    return `
        <div class="row g-4">
            <div class="col-md-4">
                <div class="text-center">
                    <div class="mb-3">
                        <h4 class="text-muted mb-1">${prettyPeriod}</h4>
                        <small class="text-muted">${period.kota}</small>
                    </div>
                    <div class="mb-3">
                        <div class="h2 fw-bold text-${iph.color} mb-2">
                            ${iph.value > 0 ? '+' : ''}${iph.value.toFixed(2)}%
                        </div>
                        <div class="text-muted small">Indikator Perubahan Harga</div>
                    </div>
                </div>
            </div>
            <div class="col-md-8">
                <h6 class="mb-3 text-dark"><i class="fas fa-chart-line me-2"></i>Komoditas Berpengaruh</h6>
                <div class="row g-2">
                    ${commodities.significant_positive && commodities.significant_positive.length > 0 ? `
                        ${commodities.significant_positive.slice(0, 3).map(c => `
                            <div class="col-md-4">
                                <div class="card border-success border-opacity-50">
                                    <div class="card-body py-2 px-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div><div class="fw-medium small">${formatCommodityName(c.name)}</div></div>
                                            <span class="badge bg-success">+${c.impact.toFixed(2)}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    ` : ''}
                    ${commodities.significant_negative && commodities.significant_negative.length > 0 ? `
                        ${commodities.significant_negative.slice(0, 3).map(c => `
                            <div class="col-md-4">
                                <div class="card border-danger border-opacity-50">
                                    <div class="card-body py-2 px-3">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <div><div class="fw-medium small">${formatCommodityName(c.name)}</div></div>
                                            <span class="badge bg-danger">${c.impact.toFixed(2)}%</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    ` : ''}
                    ${(commodities.significant_positive.length === 0 && commodities.significant_negative.length === 0) ? `
                        <div class="col-12"><small class="text-muted">Tidak ada komoditas berpengaruh signifikan minggu ini.</small></div>
                    ` : ''}
                </div>
            </div>
        </div>
    `;
}

// --- 3. FUNGSI RENDER (TREN KOMODITAS) ---

async function loadCommodityTrends() {
    console.log(`üìà Memuat Tren Komoditas...`);
    const containerId = 'commodityTrends';
    showLoading(containerId, 'Menganalisis tren komoditas...', 'success');
    
    try {
        const { params, rangeText } = getFilterParams('trend');
        
        if (params.length < 3) { // Membutuhkan periods, start_key, end_key
            console.warn("Parameter filter tren kosong, menunggu init...");
            return; // initDefaults() akan memanggil ini lagi
        }

        const data = await safeApiCall(`/api/commodity/trends?${params.join('&')}`);
        
        if (data.success && data.commodity_trends && Object.keys(data.commodity_trends).length > 0) {
            document.getElementById(containerId).innerHTML = renderEnhancedCommodityTrends(data);
        } else {
            document.getElementById(containerId).innerHTML = `
                <div class="alert alert-warning border-0">
                    <div class="d-flex align-items-start">
                        <div class="me-3"><i class="fas fa-info-circle fa-lg text-warning"></i></div>
                        <div>
                            <h6 class="mb-1">Data Komoditas Tidak Tersedia</h6>
                            <small class="text-muted d-block mb-1">Periode: ${rangeText}</small>
                            <div class="small text-dark">${data.summary || 'Tidak ditemukan data komoditas pada rentang ini.'}</div>
                        </div>
                    </div>
                </div>`;
        }
    } catch (error) {
        showError(containerId, error.message, 'loadCommodityTrends()');
    }
}

function renderEnhancedCommodityTrends(data) {
    // (Fungsi ini sama seperti di file Anda, tidak perlu diubah)
    const trends = Object.entries(data.commodity_trends).slice(0, 8); 
    
    return `
        <div class="d-flex justify-content-between align-items-center mb-3">
            <small class="text-muted">${data.commodities_found || 0} komoditas ‚Ä¢ ${data.periods_analyzed || 0} periode</small>
            <span class="badge bg-light text-dark">${trends.length} ditampilkan</span>
        </div>
        <div class="row g-3 mb-3">
            ${trends.map(([name, info], index) => {
                const trend = info.trend || 'stable';
                const trend_strength = info.trend_strength || 'weak';
                const appearances = info.appearances || 0;
                
                const trendConfig = getTrendConfig(trend, trend_strength);
                const dark = (['secondary','light'].includes(trendConfig.color) ? 'text-dark' : '');

                return `
                    <div class="col-md-6">
                        <div class="card h-100 ${index === 0 ? 'border-primary border-2' : 'border-light'}">
                            ${index === 0 ? '<div class="position-absolute top-0 end-0 m-2"><i class="fas fa-crown text-warning"></i></div>' : ''}
                            <div class="card-body p-3">
                                <h6 class="mb-0 fw-bold">${formatCommodityName(name)}</h6>
                                <div class="mt-2">
                                    <span class="badge bg-${trendConfig.color} ${dark}">${trendConfig.icon} ${trendConfig.text}</span>
                                    <small class="text-muted ms-2">${appearances}x kemunculan</small>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
        <div class="row mt-3">
            <div class="col-md-4"><div class="text-center p-2 bg-success bg-opacity-10 rounded"><div class="fw-bold text-success">${Object.values(data.commodity_trends).filter(t => t.trend === 'increasing').length}</div><small class="text-muted">Trend Naik</small></div></div>
            <div class="col-md-4"><div class="text-center p-2 bg-info bg-opacity-10 rounded"><div class="fw-bold text-info">${Object.values(data.commodity_trends).filter(t => t.trend === 'decreasing').length}</div><small class="text-muted">Trend Turun</small></div></div>
            <div class="col-md-4"><div class="text-center p-2 bg-secondary bg-opacity-10 rounded"><div class="fw-bold text-secondary">${Object.values(data.commodity_trends).filter(t => t.trend === 'stable').length}</div><small class="text-muted">Stabil</small></div></div>
        </div>
    `;
}

// --- 4. FUNGSI RENDER (TOP 5 KOMODITAS) ---

async function loadImpactRanking() {
    console.log('üìä Memuat Ranking Dampak (Bar Chart)...');
    const containerId = 'impactRanking';
    
    try {
        const { params, rangeText } = getFilterParams('ranking');
        
        if (params.length < 3) { // Membutuhkan periods, start_key, end_key
            console.warn("Parameter filter ranking kosong, menunggu init...");
            return; // initDefaults() akan memanggil ini lagi
        }

        const data = await safeApiCall(`/api/commodity/impact-ranking?${params.join('&')}`);
        
        if (data.success && data.bar_chart_data && data.bar_chart_data.x && data.bar_chart_data.x.length > 0) {
            renderImpactRankingBarChart(data, rangeText); // Panggil fungsi yang benar
        } else {
            document.getElementById(containerId).innerHTML = `
                <div class="alert alert-light border-0">
                    <div class="text-center py-5">
                        <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                        <h6 class="text-muted">Tidak Ada Data Komoditas</h6>
                        <p class="mb-0 small text-muted">${data.error || 'Belum ada data komoditas yang dapat dianalisis untuk rentang waktu ini.'}</p>
                    </div>
                </div>`;
        }
    } catch (error) {
        showError(containerId, error.message, 'loadImpactRanking()');
    }
}

/**
 * Render Bar Chart (Bukan Box Plot)
 */
function renderImpactRankingBarChart(data, rangeText) {
    const container = document.getElementById('impactRanking');
    
    // Data sudah diformat oleh backend
    const plotlyData = [data.bar_chart_data];

    // Kustomisasi untuk 'hover' dan 'bar minimalis'
    plotlyData[0].width = 0.6; // Membuat bar lebih ramping (minimalis)
    plotlyData[0].text = plotlyData[0].y.map(val => `${val} kemunculan`); // Data untuk hover
    plotlyData[0].hoverinfo = 'text+x'; // Tampilkan 'text' dan nama komoditas (x)

    const layout = {
        title: {
            text: `Top 5 Komoditas Paling Sering Muncul<br><span style="font-size: 0.8em; color: #6c757d;">(${rangeText})</span>`,
            font: {
                size: 18,
                color: '#333'
            },
            x: 0.5, // Pusatkan judul
            xanchor: 'center'
        },
        yaxis: {
            title: 'Jumlah Kemunculan (Frekuensi)'
        },
        xaxis: {
            title: 'Komoditas'
        },
        margin: { t: 60, b: 50, l: 60, r: 20 },
        hovermode: 'closest',
        showlegend: false
    };

    Plotly.newPlot(container, plotlyData, layout, {responsive: true});
}

// --- 5. FUNGSI UTAMA (SETUP DAN INISIALISASI) ---

/**
 * Mengambil parameter filter dari dropdown
 */
function getFilterParams(prefix) {
    const smEl = document.getElementById(`${prefix}StartMonth`);
    const syEl = document.getElementById(`${prefix}StartYear`);
    const emEl = document.getElementById(`${prefix}EndMonth`);
    const eyEl = document.getElementById(`${prefix}EndYear`);

    if (!smEl || !syEl || !emEl || !eyEl) {
        console.error(`Elemen filter untuk prefix "${prefix}" tidak ditemukan.`);
        return { params: [], rangeText: 'Error' };
    }

    const sm = smEl.value;
    const sy = syEl.value;
    const em = emEl.value;
    const ey = eyEl.value;
    
    let params = [];
    
    params.push(`periods=999`);

    if (sm && sy && monthMap[sm]) {
        params.push(`start_key=${sy}-${monthMap[sm]}`);
    } else {
        console.warn(`Filter ${prefix} (Start) tidak lengkap/valid: ${sm} ${sy}`);
    }

    if (em && ey && monthMap[em]) {
        params.push(`end_key=${ey}-${monthMap[em]}`);
    } else {
         console.warn(`Filter ${prefix} (End) tidak lengkap/valid: ${em} ${ey}`);
    }
    
    // Validasi parameter (harus ada 3: periods, start, end)
    if (params.length < 3) { 
        console.warn(`Filter ${prefix} tidak lengkap. Mengembalikan params kosong.`);
        return { params: [], rangeText: 'Memuat...' };
    }
    
    const rangeText = (sm && sy && em && ey) ? `${sm} ${sy} ‚Äì ${em} ${ey}` : 'Rentang Waktu Error';
    
    return { params, rangeText };
}

/**
 * Validasi rentang tanggal
 */
function validateDateRange(smElId, syElId, emElId, eyElId, containerId) {
    const smEl = document.getElementById(smElId);
    const syEl = document.getElementById(syElId);
    const emEl = document.getElementById(emElId);
    const eyEl = document.getElementById(eyElId);
    
    if (!smEl || !syEl || !emEl || !eyEl) return false; 
    
    const sm = smEl.value;
    const sy = syEl.value;
    const em = emEl.value;
    const ey = eyEl.value;
    
    if (sm && sy && em && ey && monthMap[sm] && monthMap[em]) { 
        const startYm = parseInt(`${sy}${monthMap[sm]}`);
        const endYm = parseInt(`${ey}${monthMap[em]}`);
        
        if (startYm > endYm) {
            showError(containerId, 'Rentang Waktu Tidak Valid: Tanggal mulai harus lebih awal dari tanggal akhir.');
            [smEl, syEl, emEl, eyEl].forEach(el => { if (el) el.classList.add('is-invalid'); });
            setTimeout(() => { [smEl, syEl, emEl, eyEl].forEach(el => { if (el) el.classList.remove('is-invalid'); }); }, 2000);
            return false;
        }
    }
    return true;
}

/**
 * Mendaftarkan semua event listener
 */
function setupEventListeners() {
    
    // Fungsi async untuk mengisi default dan memuat data awal
    (async function initDefaults(){
        try {
            console.log("Memulai initDefaults, mengambil periode...");
            const json = await safeApiCall('/api/data/available-periods');
            
            if (json.success && json.periods && json.periods.length > 0) {
                console.log("Periode diterima, mengisi dropdown...");
                const last = json.periods[json.periods.length - 1];
                const prev = json.periods[Math.max(0, json.periods.length - 3)]; // 3 bulan lalu
                
                const startMonth = monthMap[(prev.month || (parseInt(prev.key.split('-')[1])||1))-1] || 'Januari';
                const startYear = String(prev.year || parseInt(prev.key.split('-')[0]) || '');
                const endMonth = monthMap[(last.month || (parseInt(last.key.split('-')[1])||1))-1] || 'Januari';
                const endYear = String(last.year || parseInt(last.key.split('-')[0]) || '');

                // Terapkan ke filter Trend
                ['trendStartMonth', 'rankingStartMonth'].forEach(id => { 
                    if(document.getElementById(id)) document.getElementById(id).value = startMonth; 
                });
                ['trendStartYear', 'rankingStartYear'].forEach(id => { 
                    if(document.getElementById(id)) document.getElementById(id).value = startYear; 
                });
                ['trendEndMonth', 'rankingEndMonth'].forEach(id => { 
                    if(document.getElementById(id)) document.getElementById(id).value = endMonth; 
                });
                ['trendEndYear', 'rankingEndYear'].forEach(id => { 
                    if(document.getElementById(id)) document.getElementById(id).value = endYear; 
                });
                console.log(`Dropdown diisi: ${startMonth} ${startYear} s/d ${endMonth} ${endYear}`);
                
                // Muat data awal SETELAH dropdown diisi
                loadCommodityTrends();
                loadImpactRanking();
                return;
            }
        } catch (e) {
             console.error("Gagal initDefaults:", e);
        }
        
        // Fallback jika API gagal
        console.warn("Gagal mengambil periode, memuat dengan parameter default (mungkin gagal).");
        loadCommodityTrends();
        loadImpactRanking();
    })();

    // Listener untuk filter Trend
    document.getElementById('applyTrendWindowBtn')?.addEventListener('click', function() {
        if (!validateDateRange('trendStartMonth', 'trendStartYear', 'trendEndMonth', 'trendEndYear', 'commodityTrends')) {
            return;
        }
        loadCommodityTrends(); // Akan membaca filter
    });

    // Listener untuk filter Ranking
    document.getElementById('applyRankingWindowBtn')?.addEventListener('click', function() {
        if (!validateDateRange('rankingStartMonth', 'rankingStartYear', 'rankingEndMonth', 'rankingEndYear', 'impactRanking')) {
            return;
        }
        loadImpactRanking(); // Akan membaca filter
    });
}

/**
 * Cek ketersediaan data (opsional)
 */
async function checkCommodityDataAvailability() {
    try {
        const data = await safeApiCall('/api/commodity/data-status');
        if (!data.success || !data.has_data) {
            console.warn('Tidak ada data komoditas ditemukan.');
        }
    } catch (error) {
        console.log('Could not check data availability:', error);
    }
}

// --- 6. INISIALISASI HALAMAN ---

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Halaman Insight Komoditas (v4) Dimuat');
    
    checkCommodityDataAvailability();
    
    // setupEventListeners akan mengisi dropdown dan KEMUDIAN memicu
    // loadCommodityTrends() dan loadImpactRanking()
    setupEventListeners(); 
    
    // Insight minggu ini bisa berjalan paralel
    loadCurrentWeekInsights();
    
    
    // Setup auto-refresh
    setInterval(() => {
        console.log('‚è∞ Auto-refreshing commodity insights...');
        loadCurrentWeekInsights();
        loadCommodityTrends();
        loadImpactRanking();
    }, 5 * 60 * 1000); // 5 menit
});

</script>

<style>
    .text-purple {
        color: #6f42c1 !important;
    }

    .bg-purple {
        background-color: #6f42c1 !important;
    }

    .border-purple {
        border-color: #6f42c1 !important;
    }

    .spinner-border.text-purple {
        border-color: #6f42c1;
        border-right-color: transparent;
    }

    .timeline-month {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .timeline-month:hover {
        transform: scale(1.1);
        z-index: 10;
    }
</style>

{% endblock %}


    <!-- 
    <script>
    // Enhanced Commodity Insights JavaScript dengan robust error handling
    let currentTrendPeriod = 4;
    let currentAlertThreshold = 0.05;
    let currentSeasonalView = 'overview';
    let dataLoadingStatus = {
        currentWeek: false,
        monthly: false,
        trends: false,
        alerts: false,
        seasonal: false,
        impact: false
    };
    const monthMap = {Januari:'01', Februari:'02', Maret:'03', April:'04', Mei:'05', Juni:'06', Juli:'07', Agustus:'08', September:'09', Oktober:'10', November:'11', Desember:'12'};

    // --- 1. FUNGSI API & HELPER ---
    async function safeApiCall(url, defaultValue = null) {
        try {
            console.log(`üåê Calling API: ${url}`);
            
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10 second timeout

            const response = await fetch(url, {
                signal: controller.signal,
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                }
            });
            
            clearTimeout(timeoutId);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log(`‚úÖ API Success: ${url}`, data);
            
            return data;
            
        } catch (error) {
            console.error(`‚ùå API Error: ${url}`, error);
            
            if (error.name === 'AbortError') {
                return { success: false, error: 'Timeout', message: 'Permintaan memakan waktu terlalu lama' };
            }
            
            return { 
                success: false, 
                error: error.message, 
                message: `Error jaringan: ${error.message}` 
            };
        }
    }

    function formatCommodityName(rawName) {
        if (!rawName) return '';
        try {
            return String(rawName).replace(/_/g, ' ').toLowerCase();
        } catch (_) {
            return rawName;
        }
    }

    function getTrendConfig(trend, strength) {
        const configs = {
            'increasing': { icon: 'üìà', text: 'Naik', color: strength === 'strong' ? 'danger' : 'warning' },
            'decreasing': { icon: 'üìâ', text: 'Turun', color: strength === 'strong' ? 'success' : 'info' },
            'stable': { icon: '‚û°Ô∏è', text: 'Stabil', color: 'secondary' },
            'insufficient_data': { icon: '?', text: 'Data Kurang', color: 'secondary' }
        };
        return configs[trend] || configs['stable'];
    }

    function showLoading(containerId, message, spinnerColor = 'primary') {
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = `
                <div class="text-center py-4">
                    <div class="spinner-border text-${spinnerColor}" role="status">
                        <span class="visually-hidden">Memuat...</span>
                    </div>
                    <p class="text-muted mt-2">${message}</p>
                </div>`;
        }
    }

    function showError(containerId, message, onRetryFunction = null) {
        const container = document.getElementById(containerId);
        if (container) {
            const retryButton = onRetryFunction
                ? `<button class="btn btn-outline-danger btn-sm mt-2" onclick="${onRetryFunction}"><i class="fas fa-redo me-1"></i>Coba Lagi</button>`
                : '';
            container.innerHTML = `
                <div class="alert alert-danger border-0">
                    <div class="d-flex align-items-start">
                        <div class="me-3"><i class="fas fa-exclamation-triangle fa-lg"></i></div>
                        <div>
                            <h6 class="mb-1">Error</h6>
                            <small>${message}</small>
                            ${retryButton}
                        </div>
                    </div>
                </div>`;
        }
    }

    // --- 2. FUNGSI RENDER (INSIGHT MINGGU INI) ---
    async function loadCurrentWeekInsights() {
        console.log('üìÖ Memuat Insight Minggu Ini...');
        const containerId = 'currentWeekInsights';
        showLoading(containerId, 'Memuat insight minggu ini...', 'primary');
        
        try {
            const data = await safeApiCall('/api/commodity/current-week');
            if (data.success && data.iph_analysis) {
                document.getElementById(containerId).innerHTML = renderEnhancedCurrentWeekInsights(data);
            } else {
                showError(containerId, data.message || 'Data minggu ini tidak tersedia.', 'loadCurrentWeekInsights()');
            }
        } catch (error) {
            showError(containerId, error.message, 'loadCurrentWeekInsights()');
        }
    }

    function renderEnhancedCurrentWeekInsights(data) {
        const iph = data.iph_analysis;
        const period = data.period;
        const commodities = data.commodity_impacts;
        // Normalize period label: "Juni 2025 Minggu 4"
        const deriveYear = () => {
            if (period && period.tanggal) {
                const y = new Date(period.tanggal).getFullYear();
                if (!isNaN(y)) return y;
            }

            // Try to parse trailing `'YY` from bulan
            const m = String(period?.bulan || '').match(/['`](\d{2})$/);
            if (m) return 2000 + parseInt(m[1], 10);
            return new Date().getFullYear();
        };
        const cleanMonth = String(period?.bulan || '').replace(/['`]\d{2}$/,'').trim();
        const weekNum = parseInt(String(period?.minggu || '').toString().replace(/\D/g,'')) || period?.minggu || '';
        const prettyPeriod = `${cleanMonth} ${deriveYear()} Minggu ${weekNum}`;
        
        return `
            <div class="row g-4">
                <div class="col-md-4">
                    <div class="text-center">
                        <div class="mb-3">
                            <h4 class="text-muted mb-1">${prettyPeriod}</h4>
                            <small class="text-muted">${period.kota}</small>
                        </div>
                        <div class="mb-3">
                            <div class="h2 fw-bold text-${iph.color} mb-2">
                                ${iph.value > 0 ? '+' : ''}${iph.value.toFixed(2)}%
                            </div>
                            <div class="text-muted small">Indikator Perubahan Harga</div>
                        </div>
                    </div>
                </div>
                <div class="col-md-8">
                    <h6 class="mb-3 text-dark"><i class="fas fa-chart-line me-2"></i>Komoditas Berpengaruh</h6>
                    <div class="row g-2">
                        ${commodities.significant_positive && commodities.significant_positive.length > 0 ? `
                            ${commodities.significant_positive.slice(0, 3).map(c => `
                                <div class="col-md-4">
                                    <div class="card border-success border-opacity-50">
                                        <div class="card-body py-2 px-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div><div class="fw-medium small">${formatCommodityName(c.name)}</div></div>
                                                <span class="badge bg-success">+${c.impact.toFixed(2)}%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        ` : ''}
                        ${commodities.significant_negative && commodities.significant_negative.length > 0 ? `
                            ${commodities.significant_negative.slice(0, 3).map(c => `
                                <div class="col-md-4">
                                    <div class="card border-danger border-opacity-50">
                                        <div class="card-body py-2 px-3">
                                            <div class="d-flex justify-content-between align-items-center">
                                                <div><div class="fw-medium small">${formatCommodityName(c.name)}</div></div>
                                                <span class="badge bg-danger">${c.impact.toFixed(2)}%</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        ` : ''}
                        ${(commodities.significant_positive.length === 0 && commodities.significant_negative.length === 0) ? `
                            <div class="col-12"><small class="text-muted">Tidak ada komoditas berpengaruh signifikan minggu ini.</small></div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    // --- 3. FUNGSI RENDER (TREN KOMODITAS) ---
    async function loadCommodityTrends() {
        console.log(`üìà Memuat Tren Komoditas...`);
        const containerId = 'commodityTrends';
        showLoading(containerId, 'Menganalisis tren komoditas...', 'success');
        
        try {
            const { params, rangeText } = getFilterParams('trend');
            
            if (params.length < 2) { 
                console.warn("Parameter filter tren kosong, menunggu init...");
                return; 
            }

            const data = await safeApiCall(`/api/commodity/trends?${params.join('&')}`);
            
            if (data.success && data.commodity_trends && Object.keys(data.commodity_trends).length > 0) {
                document.getElementById(containerId).innerHTML = renderEnhancedCommodityTrends(data);
            } else {
                document.getElementById(containerId).innerHTML = `
                    <div class="alert alert-warning border-0">
                        <div class="d-flex align-items-start">
                            <div class="me-3"><i class="fas fa-info-circle fa-lg text-warning"></i></div>
                            <div>
                                <h6 class="mb-1">Data Komoditas Tidak Tersedia</h6>
                                <small class="text-muted d-block mb-1">Periode: ${rangeText}</small>
                                <div class="small text-dark">${data.summary || 'Tidak ditemukan data komoditas pada rentang ini.'}</div>
                            </div>
                        </div>
                    </div>`;
            }
        } catch (error) {
            showError(containerId, error.message, 'loadCommodityTrends()');
        }
    }

    // PERBAIKI FUNGSI RENDER COMMODITY TRENDS
    function renderEnhancedCommodityTrends(data, periods) {
        if (!data.commodity_trends || Object.keys(data.commodity_trends).length === 0) {
            return `
                <div class="alert alert-warning border-0">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Data Trend Tidak Tersedia</h6>
                    <p class="mb-0">Tidak ada data trend komoditas untuk ${periods} periode terakhir.</p>
                </div>
            `;
        }
        const trends = Object.entries(data.commodity_trends).slice(0, 8); // Tampilkan top 8
        
        return `
            <div class="d-flex justify-content-between align-items-center mb-3">
                <small class="text-muted">${data.commodities_found || 0} komoditas ‚Ä¢ ${data.periods_analyzed || 0} periode</small>
                <span class="badge bg-light text-dark">${trends.length} ditampilkan</span>
            </div>
            <div class="row g-3 mb-3">
                ${trends.map(([name, info], index) => {
                    const trend = info.trend || 'stable';
                    const trend_strength = info.trend_strength || 'weak';
                    const appearances = info.appearances || 0;
                    const total_impact = info.total_impact || 0;
                    // PERBAIKAN BUG 'trendConfig'
                    const trendConfig = getTrendConfig(trend, trend_strength);
                    const dark = (['secondary','light'].includes(trendConfig.color) ? 'text-dark' : '');

                    return `
                        <div class="col-md-6">
                            <div class="card h-100 ${index === 0 ? 'border-primary border-2' : 'border-light'}">
                                ${index === 0 ? '<div class="position-absolute top-0 end-0 m-2"><i class="fas fa-crown text-warning"></i></div>' : ''}
                                
                                <div class="card-body p-3">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0 fw-bold">${formatCommodityName(name)}</h6>
                                    </div>
                                    <div class="mt-2">
                                        <span class="badge bg-${trendConfig.color} ${dark}">${trendConfig.icon} ${trendConfig.text}</span>
                                        <small class="text-muted ms-2">${appearances}x kemunculan</small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            <div class="row mt-3">
                <div class="col-md-4">
                    <div class="text-center p-2 bg-success bg-opacity-10 rounded">
                        <div class="fw-bold text-success">${Object.values(data.commodity_trends).filter(t => t.trend === 'increasing').length}</div>
                        <small class="text-muted">Trend Naik</small>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="text-center p-2 bg-info bg-opacity-10 rounded">
                        <div class="fw-bold text-info">${Object.values(data.commodity_trends).filter(t => t.trend === 'decreasing').length}</div>
                        <small class="text-muted">Trend Turun</small>
                                        </div>
                                    </div>
                <div class="col-md-4">
                    <div class="text-center p-2 bg-secondary bg-opacity-10 rounded">
                        <div class="fw-bold text-secondary">${Object.values(data.commodity_trends).filter(t => t.trend === 'stable').length}</div>
                        <small class="text-muted">Stabil</small>
                    </div>
                </div>
            </div>
        `;
    }

    // --- 4. FUNGSI RENDER (TOP 5 KOMODITAS) ---
    async function loadImpactRanking() {
        console.log('üìä Loading impact ranking...');
        const containerId = 'impactRanking';

        try {
            const { params, rangeText } = getFilterParams('ranking');
            
            if (params.length < 2) { 
                console.warn("Parameter filter ranking kosong, menunggu init...");
                return; 
            }

            const data = await safeApiCall('/api/commodity/impact-ranking');

            if (data.success && data.bar_chart_data && data.bar_chart_data.x && data.bar_chart_data.x.length > 0) {
                renderImpactRankingBarChart(data, rangeText);
            } else {
                document.getElementById(containerId).innerHTML = `
                    <div class="alert alert-light border-0">
                        <div class="text-center py-5">
                            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                            <h6 class="text-muted">Tidak Ada Data Komoditas</h6>
                            <p class="mb-0 small text-muted">${data.error || 'Belum ada data komoditas yang dapat dianalisis untuk rentang waktu ini.'}</p>
                        </div>
                    </div>
                `;
            }
            
        } catch (error) {
            showError(containerId, error.message, 'loadImpactRanking()');
        }
        
        // Update loading status
        dataLoadingStatus.impact = true;
    }

    function renderImpactRankingBarChart(data, rangeText) {
        const container = document.getElementById('impactRanking');
        
        // Data untuk Plotly (sudah diformat oleh backend)
        const plotlyData = [data.bar_chart_data];

        plotlyData[0].width = 0.6; 
        plotlyData[0].text = plotlyData[0].y.map(val => `${val} kemunculan`); 
        plotlyData[0].hoverinfo = 'text+x';
        const layout = {
    title: {
                text: `Top 5 Komoditas Paling Sering Muncul<br><span style="font-size: 0.8em; color: #6c757d;">(${rangeText})</span>`,
                font: {
                    size: 18,
                },
                x: 0.5, 
                xanchor: 'center'
            },
            yaxis: {
                title: 'Jumlah Kemunculan (Frekuensi)'
            },
            xaxis: {
                title: 'Komoditas'
            },
            hovermode: 'closest',
            showlegend: false
        };

        Plotly.newPlot(container, plotlyData, layout, {responsive: true});
    }

    // --- 5. FUNGSI UTAMA (SETUP DAN INISIALISASI) ---
    function getFilterParams(prefix) {
        const smEl = document.getElementById(`${prefix}StartMonth`);
        const syEl = document.getElementById(`${prefix}StartYear`);
        const emEl = document.getElementById(`${prefix}EndMonth`);
        const eyEl = document.getElementById(`${prefix}EndYear`);

        if (!smEl || !syEl || !emEl || !eyEl) {
            console.error(`Elemen filter untuk prefix "${prefix}" tidak ditemukan.`);
            return { params: [], rangeText: 'Error' };
        }

        const sm = smEl.value;
        const sy = syEl.value;
        const em = emEl.value;
        const ey = eyEl.value;
        
        let params = [];
        if (sm && sy && monthMap[sm]) {
            params.push(`start_key=${sy}-${monthMap[sm]}`);
        } else {
            console.warn(`Filter ${prefix} (Start) tidak lengkap/valid: ${sm} ${sy}`);
        }

        if (em && ey && monthMap[em]) {
            params.push(`end_key=${ey}-${monthMap[em]}`);
        } else {
            console.warn(`Filter ${prefix} (End) tidak lengkap/valid: ${em} ${ey}`);
        }
        
        // Pastikan kedua parameter ada
        if (params.length !== 2) {
            console.warn(`Filter ${prefix} tidak lengkap. Mengembalikan params kosong.`);
            return { params: [], rangeText: 'Memuat...' };
        }
        
        const rangeText = (sm && sy && em && ey) ? `${sm} ${sy} ‚Äì ${em} ${ey}` : 'Rentang Waktu Error';
        
        return { params, rangeText};
    }

    function validateDateRange(smElId, syElId, emElId, eyElId, containerId) {
        const smEl = document.getElementById(smElId);
        const syEl = document.getElementById(syElId);
        const emEl = document.getElementById(emElId);
        const eyEl = document.getElementById(eyElId);
        
        if (!smEl || !syEl || !emEl || !eyEl) return false; 
        
        const sm = smEl.value;
        const sy = syEl.value;
        const em = emEl.value;
        const ey = eyEl.value;

        let params = [];
        params.push(`periods=999`);
        if (sm && sy && em && ey && monthMap[sm] && monthMap[em]) {
            const startYm = parseInt(`${sy}${monthMap[sm]}`);
            const endYm = parseInt(`${ey}${monthMap[em]}`);
            
            if (startYm > endYm) {
                showError(containerId, 'Rentang Waktu Tidak Valid: Tanggal mulai harus lebih awal dari tanggal akhir.');
                [smEl, syEl, emEl, eyEl].forEach(el => { if (el) el.classList.add('is-invalid'); });
                setTimeout(() => { [smEl, syEl, emEl, eyEl].forEach(el => { if (el) el.classList.remove('is-invalid'); }); }, 2000);
                return false;
            }
        }
        
        if (params.length < 3) { // Harus ada periods, start_key, end_key
            console.warn(`Filter ${prefix} tidak lengkap. Mengembalikan params kosong.`);
            return { params: [], rangeText: 'Memuat...' };
        }
        
        const rangeText = (sm && sy && em && ey) ? `${sm} ${sy} ‚Äì ${em} ${ey}` : 'Rentang Waktu Error';
        return true;
    }

    function setupEventListeners() {
        
        // Fungsi async untuk mengisi default dan memuat data awal
        (async function initDefaults(){
            try {
                console.log("Memulai initDefaults, mengambil periode...");
                const json = await safeApiCall('/api/data/available-periods');
                
                if (json.success && json.periods && json.periods.length > 0) {
                    console.log("Periode diterima, mengisi dropdown...");
                    const last = json.periods[json.periods.length - 1];
                    const prev = json.periods[Math.max(0, json.periods.length - 3)]; // 3 bulan lalu
                    const monthMap = ['Januari','Februari','Maret','April','Mei','Juni','Juli','Agustus','September','Oktober','November','Desember'];
                    
                    // Konversi bulan dari angka ke nama
                    const startMonth = monthMap[(prev.month || (parseInt(prev.key.split('-')[1])||1))-1] || 'Januari';
                    const startYear = String(prev.year || parseInt(prev.key.split('-')[0]) || '');
                    const endMonth = monthMap[(last.month || (parseInt(last.key.split('-')[1])||1))-1] || 'Januari';
                    const endYear = String(last.year || parseInt(last.key.split('-')[0]) || '');

                    // Terapkan ke filter Trend
                    ['trendStartMonth', 'rankingStartMonth'].forEach(id => { 
                        if(document.getElementById(id)) document.getElementById(id).value = startMonth; 
                    });
                    ['trendStartYear', 'rankingStartYear'].forEach(id => { 
                        if(document.getElementById(id)) document.getElementById(id).value = startYear; 
                    });
                    ['trendEndMonth', 'rankingEndMonth'].forEach(id => { 
                        if(document.getElementById(id)) document.getElementById(id).value = endMonth; 
                    });
                    ['trendEndYear', 'rankingEndYear'].forEach(id => { 
                        if(document.getElementById(id)) document.getElementById(id).value = endYear; 
                    });
                    console.log(`Dropdown diisi: ${startMonth} ${startYear} s/d ${endMonth} ${endYear}`);
                    
                    // Muat data awal SETELAH dropdown diisi
                    loadCommodityTrends();
                    loadImpactRanking();
                    return;
                }
            } catch (e) {
                console.error("Gagal initDefaults:", e);
            }
            
            // Fallback jika API gagal
            console.warn("Gagal mengambil periode, memuat dengan parameter default (mungkin gagal).");
            loadCommodityTrends();
            loadImpactRanking();
        })();

        // Listener untuk filter Trend
        document.getElementById('applyTrendWindowBtn')?.addEventListener('click', function() {
            if (!validateDateRange('trendStartMonth', 'trendStartYear', 'trendEndMonth', 'trendEndYear', 'commodityTrends')) {
                return;
            }
            loadCommodityTrends(); // Akan membaca filter
        });

        // Listener untuk filter Ranking
        document.getElementById('applyRankingWindowBtn')?.addEventListener('click', function() {
            if (!validateDateRange('rankingStartMonth', 'rankingStartYear', 'rankingEndMonth', 'rankingEndYear', 'impactRanking')) {
                return;
            }
            loadImpactRanking(); // Akan membaca filter
        });
    }

    async function checkCommodityDataAvailability() {
        try {
            const response = await fetch('/api/commodity/data-status');
            const data = await response.json();
            
            if (!data.success || !data.has_data) {
                showSystemAlert(
                    'Tidak ada data komoditas ditemukan. Harap unggah data komoditas untuk mengaktifkan insights.',
                    'warning'
                );
            }
        } catch (error) {
            console.log('Could not check data availability:', error);
        }
    }

    // --- 6. INISIALISASI HALAMAN ---

    document.addEventListener('DOMContentLoaded', function() {
        console.log('üöÄ Halaman Insight Komoditas (v4) Dimuat');
        checkCommodityDataAvailability();
        
        setupEventListeners(); 
        
        loadCurrentWeekInsights();
        
        setInterval(() => {
            console.log('‚è∞ Auto-refreshing commodity insights...');
            loadCurrentWeekInsights();
            loadCommodityTrends();
            loadImpactRanking();
        }, 5 * 60 * 1000); // 5 menit
    });



    // PERBAIKI FUNGSI SEASONAL PATTERNS
    async function loadSeasonalPatterns(view = 'overview') {
        console.log(`üóìÔ∏è Loading enhanced seasonal patterns - view: ${view}`);
        
        const container = document.getElementById('seasonalPatterns');
        const statusBadge = document.getElementById('seasonalStatus');
        
        
        container.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border text-purple" role="status"></div>
                <p class="mt-2 text-muted">Menganalisis pola seasonal...</p>
            </div>
        `;
        
        try {
            const data = await safeApiCall('/api/commodity/seasonal');
            
            if (data.success && data.seasonal_patterns) {
                
                const html = renderEnhancedSeasonalPatterns(data, view);
                container.innerHTML = html;
                
                dataLoadingStatus.seasonal = true;
                
            } else {
                
                container.innerHTML = renderSeasonalPatternsError(data, view);
            }
            
        } catch (error) {
            console.error('‚ùå Error loading seasonal patterns:', error);
            
            container.innerHTML = renderSeasonalPatternsNetworkError(error, view);
        }
        
    }

    // PERBAIKI FUNGSI RENDER SEASONAL PATTERNS
    function renderEnhancedSeasonalPatterns(data, view) {
        const patterns = data.seasonal_patterns;
        const explanation = data.categorization_explanation;
        const insights = data.seasonal_insights;
        
        let html = `
            <div class="alert alert-info border-0 mb-4">
                <h6 class="alert-heading">
                    <i class="fas fa-info-circle me-2"></i>
                    Penjelasan Kategorisasi Seasonal
                </h6>
                <div class="row">
                    <div class="col-md-6">
                        <strong>üìÖ Basis Temporal:</strong>
                        <p class="mb-2 small">${explanation.temporal_basis.description}</p>
                        <strong>üéØ Tujuan:</strong>
                        <p class="mb-0 small">${explanation.temporal_basis.purpose}</p>
                    </div>
                    <div class="col-md-6">
                        <strong>üìä Kategori Impact:</strong>
                        <div class="small">
                            ${Object.entries(explanation.impact_categories).slice(0, 3).map(([level, info]) => `
                                <div class="d-flex justify-content-between mb-1">
                                    <span class="badge bg-${info.color} small">${level}</span>
                                    <span class="text-muted">${info.threshold}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            </div>
        `;
        
        if (view === 'overview') {
            html += renderSeasonalOverview(patterns, insights);
        } else if (view === 'category') {
            html += renderSeasonalByCategory(patterns, insights);
        } else if (view === 'heatmap') {
            html += renderSeasonalHeatmap(patterns, insights);
        }
        
        // Add insights summary
        html += `
            <div class="mt-4">
                <div class="alert alert-light border-0">
                    <h6>
                        <i class="fas fa-chart-line me-2"></i>
                        Ringkasan Pola Seasonal
                    </h6>
                    <div class="small" style="white-space: pre-wrap; line-height: 1.4;">
                        ${data.summary || 'Tidak ada ringkasan musiman tersedia'}
                    </div>
                </div>
            </div>
        `;
        
        return html;
    }

    // PERBAIKI FUNGSI RENDER SEASONAL OVERVIEW
    function renderSeasonalOverview(patterns, insights) {
        if (!patterns || Object.keys(patterns).length === 0) {
            return `
                <div class="alert alert-warning border-0">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Data Seasonal Tidak Tersedia</h6>
                    <p class="mb-0">Tidak ada data seasonal yang dapat dianalisis.</p>
                </div>
            `;
        }
        
        return `
            <div class="row g-3 mb-4">
                ${Object.entries(patterns).map(([month, pattern]) => {
                    const monthCategory = pattern.month_category || { 
                        primary: 'Tidak Diketahui', 
                        color: 'secondary', 
                        risk_level: 'low',
                        volatility_level: 'Tidak Diketahui'
                    };
                    
                    const riskBadge = monthCategory.risk_level === 'high' ? 'bg-danger' : 
                                    monthCategory.risk_level === 'medium' ? 'bg-warning' : 'bg-success';
                    
                    return `
                        <div class="col-md-4 col-lg-3">
                            <div class="card h-100 border-${monthCategory.color} ${monthCategory.risk_level === 'high' ? 'border-2' : ''}">
                                <div class="card-header bg-${monthCategory.color} text-white py-2">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0">${month}</h6>
                                        <span class="badge ${riskBadge} small">
                                            ${monthCategory.risk_level.toUpperCase()}
                                        </span>
                                    </div>
                                    <small class="opacity-75">${pattern.weeks_data || 0} minggu data</small>
                                </div>
                                <div class="card-body py-3 px-3">
                                    <div class="text-center mb-3">
                                        <h4 class="text-${monthCategory.color} mb-1">
                                            ${(pattern.avg_iph || 0).toFixed(2)}%
                                        </h4>
                                        <small class="text-muted">
                                            ${monthCategory.primary}<br>
                                            ${monthCategory.volatility_level}
                                        </small>
                                    </div>
                                    
                                    ${pattern.dominant_commodities && pattern.dominant_commodities.length > 0 ? `
                                        <div class="mb-2">
                                            <h6 class="small mb-1">Komoditas Dominan:</h6>
                                            <div class="d-flex justify-content-between align-items-center">
                                                <span class="small fw-medium">${pattern.dominant_commodities[0].name}</span>
                                                <span class="badge bg-${monthCategory.color} small">
                                                    ${(pattern.dominant_commodities[0].total_impact || 0).toFixed(3)}%
                                                </span>
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="text-center">
                                        <small class="text-muted">
                                            Diversitas: ${pattern.commodity_diversity || 0} komoditas<br>
                                            Kategori Dominan: ${pattern.dominant_category || 'Tidak Ada'}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            <div class="row g-3 mb-3">
                ${insights.peak_inflation_months && insights.peak_inflation_months.length > 0 ? `
                    <div class="col-md-4">
                        <div class="card bg-danger bg-opacity-10 border-danger">
                            <div class="card-body py-3">
                                <h6 class="card-title text-danger mb-2">
                                    üî¥ Puncak Tertinggi
                                </h6>
                                ${insights.peak_inflation_months.slice(0, 2).map(month => `
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">${month.month}</span>
                                        <span class="badge bg-danger small">${month.avg_iph.toFixed(2)}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${insights.peak_deflation_months && insights.peak_deflation_months.length > 0 ? `
                    <div class="col-md-4">
                        <div class="card bg-info bg-opacity-10 border-info">
                            <div class="card-body py-3">
                                <h6 class="card-title text-info mb-2">
                                    üîµ Puncak Terendah
                                </h6>
                                ${insights.peak_deflation_months.slice(0, 2).map(month => `
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="small">${month.month}</span>
                                        <span class="badge bg-info small">${month.avg_iph.toFixed(2)}%</span>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                ${insights.stable_months && insights.stable_months.length > 0 ? `
                    <div class="col-md-4">
                        <div class="card bg-success bg-opacity-10 border-success">
                            <div class="card-body py-3">
                                <h6 class="card-title text-success mb-2">
                                    ‚úÖ Bulan Stabil
                                </h6>
                                <div class="text-center">
                                    <h4 class="text-success">${insights.stable_months.length}</h4>
                                    <small class="text-muted">bulan dengan kondisi stabil</small>
                                </div>
                            </div>
                        </div>
                    </div>
                ` : ''}
            </div>
            
            ${insights.high_risk_months && insights.high_risk_months.length > 0 ? `
                <div class="alert alert-warning border-0 py-3">
                    <h6 class="alert-heading">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        Bulan Berisiko Tinggi
                    </h6>
                    <div class="row">
                        ${insights.high_risk_months.map(month => `
                            <div class="col-md-3 mb-2">
                                <div class="d-flex justify-content-between align-items-center p-2 bg-warning bg-opacity-25 rounded">
                                    <span class="small fw-medium">${month.month}</span>
                                    <span class="badge bg-warning small">${month.avg_iph.toFixed(2)}%</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <small class="text-muted">
                        Bulan-bulan ini memerlukan monitoring ekstra dan persiapan kebijakan khusus
                    </small>
                </div>
            ` : ''}
        `;
    }

    // PERBAIKI FUNGSI RENDER BY CATEGORY
    function renderSeasonalByCategory(patterns, insights) {
        if (!patterns || Object.keys(patterns).length === 0) {
            return `
                <div class="alert alert-warning border-0">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Data Kategori Tidak Tersedia</h6>
                    <p class="mb-0">Tidak ada data kategori yang dapat dianalisis untuk pola seasonal.</p>
                </div>
            `;
        }
        
        // Analyze patterns by category
        const categorySeasonalData = analyzeCategorySeasonalPatterns(patterns);
        
        if (!categorySeasonalData || Object.keys(categorySeasonalData).length === 0) {
            return `
                <div class="alert alert-warning border-0">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Analisis Kategori Gagal</h6>
                    <p class="mb-0">Tidak dapat menganalisis data berdasarkan kategori.</p>
                </div>
            `;
        }
        
        return `
            <div class="alert alert-primary border-0 mb-4">
                <h6 class="alert-heading">
                    <i class="fas fa-layer-group me-2"></i>
                    Analisis Seasonal Berdasarkan Kategori Komoditas
                </h6>
                <p class="mb-0 small">
                    Melihat pola seasonal dari perspektif kategori komoditas untuk mengidentifikasi 
                    sektor mana yang paling berpengaruh di bulan-bulan tertentu.
                </p>
            </div>
            
            <div class="row g-4 mb-4">
                ${Object.entries(categorySeasonalData).slice(0, 6).map(([category, data]) => `
                    <div class="col-lg-6">
                        <div class="card h-100 border-${data.dominance_level === 'high' ? 'primary border-2' : 'light'}">
                            <div class="card-header bg-${data.dominance_level === 'high' ? 'primary' : 'light'} 
                                        ${data.dominance_level === 'high' ? 'text-white' : 'text-dark'}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0">
                                        <span class="me-2 fs-4">${data.icon}</span>
                                        ${category}
                                    </h6>
                                    <span class="badge ${data.dominance_level === 'high' ? 'bg-light text-primary' : 'bg-primary'} small">
                                        ${data.dominance_level.toUpperCase()}
                                    </span>
                                </div>
                                <small class="opacity-75">${data.description}</small>
                            </div>
                            <div class="card-body">
                                <div class="row text-center mb-3">
                                    <div class="col-4">
                                        <div class="fw-bold text-primary">${data.total_months}</div>
                                        <small class="text-muted">Bulan Aktif</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-bold text-${data.avg_impact > 0 ? 'warning' : 'info'}">${data.avg_impact.toFixed(3)}%</div>
                                        <small class="text-muted">Avg Impact</small>
                                    </div>
                                    <div class="col-4">
                                        <div class="fw-bold text-secondary">${data.total_commodities}</div>
                                        <small class="text-muted">Komoditas</small>
                                    </div>
                                </div>
                                
                                <h6 class="small mb-2 text-muted">
                                    <i class="fas fa-calendar-alt me-1"></i>
                                    Bulan Puncak Pengaruh:
                                </h6>
                                <div class="mb-3">
                                    ${data.peak_months.slice(0, 3).map(period => `
                                        <div class="d-flex justify-content-between align-items-center mb-2">
                                            <div>
                                                <div class="fw-medium small">${period.month}</div>
                                                <small class="text-muted">${period.commodity_count} komoditas</small>
                                            </div>
                                            <span class="badge bg-${period.impact > 0 ? 'warning' : 'info'} small">
                                                ${period.impact.toFixed(2)}%
                                            </span>
                                        </div>
                                    `).join('')}
                                </div>
                                
                                <div class="text-center">
                                    <span class="badge bg-${data.seasonal_trend_color} px-3 py-2">
                                        ${data.seasonal_trend_icon}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // PERBAIKI HELPER FUNCTIONS
    function getTrendConfig(trend, strength) {
        const configs = {
            'increasing': {
                icon: 'üìà',
                text: 'Naik',
                color: strength === 'strong' ? 'danger' : strength === 'moderate' ? 'warning' : 'info'
            },
            'decreasing': {
                icon: 'üìâ', 
                text: 'Turun',
                color: strength === 'strong' ? 'success' : strength === 'moderate' ? 'info' : 'secondary'
            },
            'stable': {
                icon: '‚û°Ô∏è',
                text: 'Stabil', 
                color: 'secondary'
            },
            'insufficient_data': {
                icon: '‚û°Ô∏è',
                text: 'Stabil',
                color: 'secondary'
            }
        };
        
        return configs[trend] || configs['stable'];
    }

    function getImpactConfig(impact) {
        const absImpact = Math.abs(impact);
        if (absImpact > 2.0) {
            return { color: 'danger', level: 'very_high' };
        } else if (absImpact > 1.0) {
            return { color: 'warning', level: 'high' };
        } else if (absImpact > 0.5) {
            return { color: 'info', level: 'medium' };
        } else {
            return { color: 'light', level: 'low' };
        }
    }

    // Format helper untuk nama komoditas: underscore -> spasi, lower-case
    function formatCommodityName(rawName) {
        if (!rawName) return '';
        try {
            return String(rawName).replace(/_/g, ' ').toLowerCase();
        } catch (_) {
            return rawName;
        }
    }

    // PERBAIKI ANALYZE CATEGORY SEASONAL PATTERNS
    function analyzeCategorySeasonalPatterns(patterns) {
        const categoryData = {};
        
        // Predefined category info (should match backend)
        const categoryInfo = {
            'PROTEIN': { description: 'Sumber protein hewani dan nabati' },
            'SAYURAN_BUMBU': { description: 'Sayuran dan bumbu dapur' },
            'KARBOHIDRAT': { description: 'Sumber karbohidrat utama' },
            'LEMAK_MINYAK': { description: 'Minyak dan lemak' },
            'PEMANIS': { description: 'Pemanis dan gula' },
            'BUAH': { description: 'Buah-buahan' },
            'LAINNYA': { description: 'Komoditas lainnya' }
        };
        
        // Initialize categories
        Object.keys(categoryInfo).forEach(category => {
            categoryData[category] = {
                description: categoryInfo[category].description,
                monthly_impacts: {},
                total_months: 0,
                avg_impact: 0,
                peak_impact: 0,
                peak_month: '',
                total_commodities: new Set(),
                peak_months: [],
                dominance_level: 'low',
                seasonal_trend: 'stable',
                seasonal_trend_color: 'secondary',
                seasonal_trend_icon: '‚û°Ô∏è'
            };
        });
        
        // Process patterns data
        Object.entries(patterns).forEach(([month, pattern]) => {
            // Process category breakdown if available
            if (pattern.category_breakdown) {
                Object.entries(pattern.category_breakdown).forEach(([category, impact]) => {
                    if (categoryData[category]) {
                        categoryData[category].monthly_impacts[month] = impact;
                        categoryData[category].total_months++;
                        
                        if (Math.abs(impact) > Math.abs(categoryData[category].peak_impact)) {
                            categoryData[category].peak_impact = impact;
                            categoryData[category].peak_month = month;
                        }
                    }
                });
            }
            
            // Process dominant commodities
            if (pattern.dominant_commodities) {
                pattern.dominant_commodities.forEach(comm => {
                    const category = comm.category || 'LAINNYA';
                    if (categoryData[category]) {
                        categoryData[category].total_commodities.add(comm.name);
                    }
                });
            }
        });
        
        // Calculate derived metrics
        Object.entries(categoryData).forEach(([category, data]) => {
            const impacts = Object.values(data.monthly_impacts);
            if (impacts.length > 0) {
                data.avg_impact = impacts.reduce((a, b) => a + b, 0) / impacts.length;
                data.total_commodities = data.total_commodities.size;
                
                // Get peak months
                data.peak_months = Object.entries(data.monthly_impacts)
                    .sort((a, b) => Math.abs(b[1]) - Math.abs(a[1]))
                    .slice(0, 3)
                    .map(([month, impact]) => ({
                        month,
                        impact,
                        commodity_count: 1 // Simplified
                    }));
                
                // Determine dominance level
                const absAvg = Math.abs(data.avg_impact);
                if (absAvg > 1.0) {
                    data.dominance_level = 'high';
                } else if (absAvg > 0.5) {
                    data.dominance_level = 'medium';
                } else {
                    data.dominance_level = 'low';
                }
                
                // Seasonal trend
                if (data.avg_impact > 0.5) {
                    data.seasonal_trend = 'Inflationary';
                    data.seasonal_trend_color = 'warning';
                    data.seasonal_trend_icon = 'üìà';
                } else if (data.avg_impact < -0.5) {
                    data.seasonal_trend = 'Deflationary';
                    data.seasonal_trend_color = 'info';
                    data.seasonal_trend_icon = 'üìâ';
                } else {
                    data.seasonal_trend = 'Stable';
                    data.seasonal_trend_color = 'success';
                    data.seasonal_trend_icon = '‚û°Ô∏è';
                }
            }
        });
        
        // Filter out empty categories
        const filteredData = Object.fromEntries(
            Object.entries(categoryData).filter(([_, data]) => data.total_months > 0)
        );
        
        return filteredData;
    }

    // PERBAIKI RENDER SEASONAL HEATMAP
    function renderSeasonalHeatmap(patterns, insights) {
        if (!patterns || Object.keys(patterns).length === 0) {
            return `
                <div class="alert alert-warning border-0">
                    <h6><i class="fas fa-exclamation-triangle me-2"></i>Data Heatmap Tidak Tersedia</h6>
                    <p class="mb-0">Tidak ada data yang cukup untuk membuat heatmap seasonal.</p>
                </div>
            `;
        }
        
        // Prepare simplified heatmap data
        const heatmapData = prepareSimpleHeatmapData(patterns);
        
        return `
            <div class="alert alert-info border-0 mb-4">
                <h6 class="alert-heading">
                    <i class="fas fa-th me-2"></i>
                    Heatmap Seasonal - Intensitas Dampak Komoditas
                </h6>
                <p class="mb-0 small">
                    Visualisasi intensitas dampak komoditas sepanjang tahun. 
                    Warna menunjukkan tingkat dampak: üî¥ Tinggi, üü° Sedang, üîµ Rendah.
                </p>
            </div>
            
            <div class="card mb-4">
                <div class="card-header bg-white">
                    <h6 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Heatmap Bulan vs Kategori
                    </h6>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Kategori</th>
                                    ${heatmapData.months.map(month => `
                                        <th class="text-center" style="min-width: 80px;">
                                            <small>${month.substring(0, 3)}</small>
                                        </th>
                                    `).join('')}
                                    <th class="text-center">Avg</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${heatmapData.categories.map(category => `
                                    <tr>
                                        <td>
                                            <strong class="small">${category.name}</strong>
                                        </td>
                                        ${category.monthly_values.map(monthValue => `
                                            <td class="text-center" style="background-color: ${monthValue.color};">
                                                <span class="badge bg-dark bg-opacity-50 small">
                                                    ${monthValue.impact !== 0 ? monthValue.impact.toFixed(1) : '-'}
                                                </span>
                                            </td>
                                        `).join('')}
                                        <td class="text-center bg-light">
                                            <span class="badge bg-${category.avg_impact > 0 ? 'warning' : 'info'} small">
                                                ${category.avg_impact.toFixed(2)}%
                                            </span>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
    }

    // TAMBAHKAN HELPER FUNCTIONS YANG DIPERLUKAN
    function prepareSimpleHeatmapData(patterns) {
        const monthOrder = ['Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni',
                        'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
        
        // Analyze categories across months
        const categoryImpacts = {};
        const monthActivity = {};
        
        Object.entries(patterns).forEach(([month, pattern]) => {
            monthActivity[month] = 0;
            
            if (pattern.category_breakdown) {
                Object.entries(pattern.category_breakdown).forEach(([category, impact]) => {
                    if (!categoryImpacts[category]) {
                        categoryImpacts[category] = {};
                    }
                    categoryImpacts[category][month] = impact;
                    monthActivity[month]++;
                });
            }
        });
        
        // Prepare categories for heatmap
        const categories = Object.entries(categoryImpacts).map(([category, monthlyData]) => {
            const categoryInfo = {
                'PROTEIN': 'ü•©',
                'SAYURAN_BUMBU': 'üå∂Ô∏è',
                'KARBOHIDRAT': 'üåæ',
                'LEMAK_MINYAK': 'üõ¢Ô∏è',
                'PEMANIS': 'üçØ',
                'BUAH': 'üçå',
                'LAINNYA': 'üì¶'
            };
            
            const monthly_values = monthOrder.map(month => {
                const impact = monthlyData[month] || 0;
                const absImpact = Math.abs(impact);
                
                let color = 'rgba(248, 249, 250, 1)'; // Default light
                if (absImpact > 1.0) {
                    color = impact > 0 ? 'rgba(220, 53, 69, 0.8)' : 'rgba(13, 110, 253, 0.8)';
                } else if (absImpact > 0.5) {
                    color = impact > 0 ? 'rgba(255, 193, 7, 0.6)' : 'rgba(13, 202, 240, 0.6)';
                } else if (absImpact > 0.1) {
                    color = 'rgba(108, 117, 125, 0.3)';
                }
                
                return { month, impact, color };
            });
            
            const validImpacts = Object.values(monthlyData);
            const avg_impact = validImpacts.length > 0 ? 
                validImpacts.reduce((a, b) => a + b, 0) / validImpacts.length : 0;
            
            return {
                name: category,
                monthly_values,
                avg_impact
            };
        });
        
        return {
            months: monthOrder,
            categories: categories.slice(0, 8), // Limit to 8 categories
            patterns_summary: `${categories.length} kategori dianalisis across ${monthOrder.length} bulan.`
        };
    }

    // TAMBAHKAN MISSING ERROR HANDLERS
    function renderCurrentWeekError(data) {
        return `
            <div class="p-4">
                <div class="alert alert-warning border-0">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                        <div>
                            <h6 class="mb-1">Data Tidak Tersedia</h6>
                            <p class="mb-2">${data.message || 'Tidak ada data minggu ini tersedia'}</p>
                            ${data.suggestion ? `<small class="text-muted">${data.suggestion}</small>` : ''}
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm me-2" onclick="loadCurrentWeekInsights()">
                                    <i class="fas fa-redo me-1"></i>Coba Lagi
                                </button>
                                <button class="btn btn-outline-success btn-sm" onclick="showUploadCommodityModal()">
                                    <i class="fas fa-upload me-1"></i>Upload Data
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderCurrentWeekNetworkError(error) {
        return `
            <div class="p-4">
                <div class="alert alert-danger border-0">
                    <h6><i class="fas fa-wifi me-2"></i>Error Jaringan</h6>
                    <p class="mb-2">Gagal memuat data minggu ini: ${error.message}</p>
                    <button class="btn btn-outline-danger btn-sm" onclick="loadCurrentWeekInsights()">
                        <i class="fas fa-redo me-1"></i>Coba Lagi
                    </button>
                </div>
            </div>
        `;
    }

    function renderTrendsError(data, periods) {
        // Rapi tanpa tombol aksi
        const sm = document.getElementById('trendStartMonth')?.value;
        const sy = document.getElementById('trendStartYear')?.value;
        const em = document.getElementById('trendEndMonth')?.value;
        const ey = document.getElementById('trendEndYear')?.value;
        const rangeText = (sm && sy && em && ey) ? `${sm} ${sy} ‚Äì ${em} ${ey}` : `${periods} periode`;
        return `
            <div class="alert alert-warning border-0">
                <div class="d-flex align-items-start">
                    <div class="me-3"><i class="fas fa-exclamation-triangle fa-lg text-warning"></i></div>
                    <div>
                        <h6 class="mb-1">Data Trend Tidak Tersedia</h6>
                        <small class="text-muted d-block mb-1">Periode: ${rangeText}</small>
                        <div class="small">${data.message || 'Tidak ada data trend untuk rentang yang dipilih.'}</div>
                    </div>
                </div>
            </div>
        `;
    }

    function renderTrendsNetworkError(error, periods) {
        return `
            <div class="alert alert-danger border-0">
                <h6><i class="fas fa-wifi me-2"></i>Error Jaringan</h6>
                <p class="mb-2">Gagal memuat trend komoditas: ${error.message}</p>
                <button class="btn btn-outline-danger btn-sm" onclick="loadCommodityTrends(${periods})">
                    <i class="fas fa-redo me-1"></i>Try Again
                </button>
            </div>
        `;
    }

    function renderSeasonalPatternsError(data, view) {
        return `
            <div class="alert alert-warning border-0">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Data Seasonal Tidak Tersedia</h6>
                <p class="mb-2">${data.message || 'Tidak ada data musiman tersedia'}</p>
                <button class="btn btn-outline-primary btn-sm" onclick="loadSeasonalPatterns('${view}')">
                    <i class="fas fa-redo me-1"></i>Retry
                </button>
            </div>
        `;
    }

    function renderSeasonalPatternsNetworkError(error, view) {
        return `
            <div class="alert alert-danger border-0">
                <h6><i class="fas fa-wifi me-2"></i>Error Jaringan</h6>
                <p class="mb-2">Gagal memuat pola musiman: ${error.message}</p>
                <button class="btn btn-outline-danger btn-sm" onclick="loadSeasonalPatterns('${view}')">
                    <i class="fas fa-redo me-1"></i>Try Again
                </button>
            </div>
        `;
    }

    // TAMBAHKAN MONTHLY ANALYSIS FUNCTIONS
    async function loadMonthlyAnalysis(month = 'Juni', year = '2024') {
        console.log(`üìä Loading enhanced monthly analysis for: ${month} ${year}`);
        
        const container = document.getElementById('monthlyAnalysis');
        
        container.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border text-info" role="status"></div>
                <p class="mt-2 text-muted">Menganalisis data bulanan...</p>
            </div>
        `;
        
        try {
            let url = '/api/commodity/monthly-analysis';
            const params = [];
            if (month) params.push(`month=${encodeURIComponent(month)}`);
            if (year) params.push(`year=${encodeURIComponent(year)}`);
            if (params.length > 0) url += '?' + params.join('&');
            
            const data = await safeApiCall(url);
            
            if (data.success) {
                
                const html = renderEnhancedMonthlyAnalysis(data);
                container.innerHTML = html;
                
                dataLoadingStatus.monthly = true;
                
            } else {
                
                container.innerHTML = renderMonthlyAnalysisError(data, month);
            }
            
        } catch (error) {
            console.error('‚ùå Error loading monthly analysis:', error);
            
            container.innerHTML = renderMonthlyAnalysisNetworkError(error, month);
        }
        
    }

    function renderEnhancedMonthlyAnalysis(data) {
        const iph = data.iph_statistics;
        const commodities = data.top_impact_commodities;
        const categories = data.category_breakdown;
        const volatility = data.volatility_summary;
        
        return `
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h5 class="mb-1">${data.month} ${(document.getElementById('yearSelector') && document.getElementById('yearSelector').value) ? document.getElementById('yearSelector').value : ''}</h5>
                    <small class="text-muted">${data.analysis_period.weeks_analyzed} minggu ‚Ä¢ ${data.analysis_period.total_records} records</small>
                </div>
            </div>
            
            <div class="card bg-light border-0 mb-3">
                <div class="card-body py-3">
                    <h6 class="card-title mb-3">üìä Statistik IPH Bulanan</h6>
                    <div class="row text-center">
                        <div class="col-3">
                            <div class="fw-bold text-success">${iph.min_iph.toFixed(2)}%</div>
                            <small class="text-muted">Minimum</small>
                        </div>
                        <div class="col-3">
                            <div class="fw-bold text-primary">${iph.avg_iph.toFixed(2)}%</div>
                            <small class="text-muted">Rata-rata</small>
                        </div>
                        <div class="col-3">
                            <div class="fw-bold text-danger">${iph.max_iph.toFixed(2)}%</div>
                            <small class="text-muted">Maksimum</small>
                        </div>
                        <div class="col-3">
                            <div class="fw-bold text-warning">${iph.std_iph.toFixed(3)}%</div>
                            <small class="text-muted">Volatilitas</small>
                        </div>
                    </div>
                </div>
            </div>
            
            <h6 class="mb-3">
                <i class="fas fa-trophy me-2"></i>Top Komoditas Berpengaruh
            </h6>
            
            ${commodities && commodities.length > 0 ? `
                <div class="row g-2 mb-3">
                    ${commodities.slice(0, 6).map((c, index) => `
                        <div class="col-md-6">
                            <div class="card border-${index < 2 ? 'primary' : 'light'} ${index === 0 ? 'border-2' : ''}">
                                <div class="card-body py-2 px-3">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <div>
                                            <div class="d-flex align-items-center mb-1">
                                                ${index === 0 ? '<i class="fas fa-crown text-warning me-1"></i>' : ''}
                                                <span class="fw-medium small">${formatCommodityName(c.name)}</span>
                                            </div>
                                            <div class="d-flex align-items-center">
                                                <span class="badge bg-light text-dark small">${c.frequency}x</span>
                                            </div>
                                        </div>
                                        <div class="text-end">
                                            <span class="badge ${c.total_impact > 0 ? 'bg-warning' : 'bg-info'} small">
                                                ${c.total_impact > 0 ? '+' : ''}${c.total_impact.toFixed(3)}%
                                            </span>
                                            <div class="mt-1">
                                                <small class="text-muted">¬±${(c.volatility || 0).toFixed(3)}%</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            ` : '<div class="alert alert-light">Tidak ada data komoditas untuk bulan ini</div>'}
            
        `;
    }

    // TAMBAHKAN VOLATILITY ALERTS FUNCTIONS
    async function loadVolatilityAlerts(threshold = 0.05) {
        console.log(`‚ö†Ô∏è Loading enhanced volatility alerts with threshold: ${threshold}`);
        
        const container = document.getElementById('volatilityAlerts');
        const alertCountBadge = document.getElementById('alertCount');
        
        container.innerHTML = `
            <div class="text-center py-3">
                <div class="spinner-border text-warning" role="status"></div>
                <p class="mt-2 text-muted">Menganalisis volatilitas dengan threshold ${(threshold * 100).toFixed(0)}%...</p>
            </div>
        `;
        
        try {
            const data = await safeApiCall(`/api/commodity/alerts?threshold=${threshold}`);
            
            if (data.success) {
                const alerts = data.alerts || [];
                alertCountBadge.textContent = alerts.length;
                alertCountBadge.className = alerts.length > 0 ? 'badge bg-danger text-white ms-2' : 'badge bg-success text-white ms-2';
                
                if (alerts.length > 0) {
                    const html = renderEnhancedVolatilityAlerts(data, threshold);
                    container.innerHTML = html;
                } else {
                    container.innerHTML = renderNoVolatilityAlerts(threshold);
                }
                
                dataLoadingStatus.alerts = true;
                
            } else {
                alertCountBadge.textContent = '?';
                alertCountBadge.className = 'badge bg-secondary text-white ms-2';
                
                container.innerHTML = renderVolatilityAlertsError(data, threshold);
            }
            
        } catch (error) {
            console.error('‚ùå Error loading volatility alerts:', error);
            alertCountBadge.textContent = '!';
            alertCountBadge.className = 'badge bg-danger text-white ms-2';
            
            container.innerHTML = renderVolatilityAlertsNetworkError(error, threshold);
        }
        
    }

    function renderEnhancedVolatilityAlerts(data, threshold) {
        const alerts = data.alerts;
        const stats = data.statistics;
        
        return `
            <div class="row g-2 mb-3">
                <div class="col-md-3">
                    <div class="text-center p-2 bg-danger text-white rounded">
                        <div class="h5 mb-0">${stats.critical_alerts}</div>
                        <small>Kritis</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-2 bg-warning text-dark rounded">
                        <div class="h5 mb-0">${stats.high_alerts}</div>
                        <small>Tinggi</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-2 bg-info text-white rounded">
                        <div class="h5 mb-0">${stats.medium_alerts}</div>
                        <small>Sedang</small>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="text-center p-2 bg-secondary text-white rounded">
                        <div class="h5 mb-0">${stats.categories_affected}</div>
                        <small>Kategori</small>
                    </div>
                </div>
            </div>
            
            <div class="table-responsive">
                <table class="table table-sm table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th width="5%"><i class="fas fa-exclamation-triangle text-muted"></i></th>
                            <th width="25%">Komoditas</th>
                            <th width="15%">Periode</th>
                            <th width="15%">Volatilitas</th>
                            <th width="15%">IPH Impact</th>
                            <th width="15%">Kategori</th>
                            <th width="10%">Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${alerts.slice(0, 10).map((alert, index) => {
                            const severityConfig = {
                                'critical': { color: 'danger', icon: 'fa-exclamation-triangle', bgClass: 'table-danger' },
                                'high': { color: 'warning', icon: 'fa-exclamation-circle', bgClass: 'table-warning' },
                                'medium': { color: 'info', icon: 'fa-info-circle', bgClass: 'table-info' },
                                'low': { color: 'secondary', icon: 'fa-bell', bgClass: '' }
                            };
                            
                            const config = severityConfig[alert.severity] || severityConfig['low'];
                            
                            return `
                                <tr class="${config.bgClass}">
                                    <td class="text-center">
                                        <i class="fas ${config.icon} text-${config.color}"></i>
                                    </td>
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <div>
                                                <div class="fw-medium">${alert.commodity}</div>
                                                <small class="text-muted">${alert.standardized_name}</small>
                                            </div>
                                        </div>
                                    </td>
                                    <td>
                                        <div class="fw-medium">${alert.period}</div>
                                        <small class="text-muted">${alert.date}</small>
                                    </td>
                                    <td>
                                        <span class="badge bg-${config.color} fs-6">
                                            ${alert.volatility_percentage.toFixed(1)}%
                                        </span>
                                        <div class="mt-1">
                                            <small class="text-muted">${alert.threshold_exceeded.toFixed(1)}x threshold</small>
                                        </div>
                                    </td>
                                    <td>
                                        <span class="badge ${alert.iph_impact > 0 ? 'bg-warning' : alert.iph_impact < 0 ? 'bg-info' : 'bg-secondary'}">
                                            ${alert.iph_impact > 0 ? '+' : ''}${alert.iph_impact.toFixed(2)}%
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge bg-light text-dark small">${alert.category}</span>
                                    </td>
                                    <td>
                                        <span class="badge bg-${config.color} small">${alert.severity_text}</span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
            
            ${alerts.length > 10 ? `
                <div class="text-center mt-3">
                    <small class="text-muted">Menampilkan 10 dari ${alerts.length} total alerts</small>
                </div>
            ` : ''}
            
            <div class="alert alert-info border-0 py-2 mt-3">
                <small>
                    <i class="fas fa-chart-line me-1"></i>
                    <strong>Ringkasan:</strong> ${data.summary || 'Tidak ada ringkasan tersedia'}
                </small>
            </div>
        `;
    }

    function renderNoVolatilityAlerts(threshold) {
        return `
            <div class="alert alert-success border-0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-check-circle fa-2x me-3"></i>
                    <div>
                        <h6 class="mb-1">‚úÖ Kondisi Volatilitas Normal</h6>
                        <p class="mb-0">Tidak ada komoditas dengan volatilitas > ${(threshold * 100).toFixed(0)}%</p>
                        <small class="text-muted">Semua komoditas dalam kondisi volatilitas yang dapat diterima</small>
                    </div>
                </div>
            </div>
        `;
    }

    function renderVolatilityAlertsError(data, threshold) {
        return `
            <div class="alert alert-warning border-0">
                <h6><i class="fas fa-exclamation-triangle me-2"></i>Data Volatilitas Tidak Tersedia</h6>
                <p class="mb-0">${data.message || 'Tidak ada data volatilitas tersedia'}</p>
            </div>
        `;
    }

    function renderVolatilityAlertsNetworkError(error, threshold) {
        return `
            <div class="alert alert-danger border-0">
                <h6><i class="fas fa-wifi me-2"></i>Kesalahan Jaringan</h6>
                <p class="mb-0">Gagal memuat peringatan volatilitas: ${error.message}</p>
            </div>
        `;
    }

    function renderMonthlyAnalysisError(data, month) {
        return `
            <div class="alert alert-warning border-0">
                <div class="d-flex align-items-center">
                    <i class="fas fa-exclamation-triangle fa-2x me-3"></i>
                    <div>
                        <h6 class="mb-1">Data Tidak Tersedia</h6>
                        <p class="mb-0">${data.message || 'Tidak ada data bulanan tersedia'}</p>
                        ${data.available_months ? `
                            <div class="mt-2">
                                <small class="text-muted">Bulan tersedia:</small><br>
                                ${data.available_months.slice(0, 6).map(m => 
                                    `<span class="badge bg-light text-dark me-1">${m}</span>`
                                ).join('')}
                            </div>
                        ` : ''}
                    </div>
                </div>
            </div>
        `;
    }

    function renderMonthlyAnalysisNetworkError(error, month) {
        return `
            <div class="alert alert-danger border-0">
                <h6><i class="fas fa-wifi me-2"></i>Kesalahan Jaringan</h6>
                <p class="mb-0">Gagal memuat analisis bulanan: ${error.message}</p>
            </div>
        `;
    }

    // UTILITY FUNCTIONS
    function changeTrendPeriod(periods) {
        currentTrendPeriod = periods;
        
        // Update button states
        document.querySelectorAll('[onclick^="changeTrendPeriod"]').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        loadCommodityTrends(periods);
    }

    function changeAlertThreshold(threshold) {
        currentAlertThreshold = threshold;
        
        // Update button states
        document.querySelectorAll('[onclick^="changeAlertThreshold"]').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        loadVolatilityAlerts(threshold);
    }

    function changeSeasonalView(view) {
        currentSeasonalView = view;
        
        // Update button states
        document.querySelectorAll('[onclick^="changeSeasonalView"]').forEach(btn => {
            btn.classList.remove('active');
        });
        event.target.classList.add('active');
        
        loadSeasonalPatterns(view);
    }


    // Enhanced refresh function
    function refreshInsights() {
        console.log('üîÑ Refreshing all commodity insights...');
        
        // Reset status
        dataLoadingStatus = {
            currentWeek: false,
            monthly: false,
            trends: false,
            impact: false
        };
            
        // Load all insights
        loadCurrentWeekInsights();
        loadCommodityTrends();
        loadImpactRanking();
        
        showAlert('Refreshing commodity insights...', 'info');
    }



    function showAlert(message, type) {
        const alertHTML = `
            <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                style="top: 20px; right: 20px; z-index: 9999; max-width: 400px;" role="alert">
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'times-circle' : 'info-circle'} me-2"></i>
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', alertHTML);
        
        setTimeout(() => {
            const alerts = document.querySelectorAll('.alert');
            alerts.forEach(alert => {
                if (alert.textContent.includes(message.substring(0, 20))) {
                    alert.remove();
                }
            });
        }, 5000);
    }

    function showSystemAlert(message, type) {
        const alertPanel = document.getElementById('systemStatusAlert');
        alertPanel.innerHTML = `
            <div class="alert alert-${type} border-0 shadow-sm mb-4" role="alert">
                <div class="d-flex align-items-center">
                    <i class="fas fa-${type === 'warning' ? 'exclamation-triangle' : 'info-circle'} fa-lg me-3"></i>
                    <div class="flex-grow-1">
                        <strong>System Status:</strong> ${message}
                    </div>
                </div>
            </div>
        `;
        alertPanel.style.display = 'block';
    }

    </script>

    <style>
    .text-purple {
        color: #6f42c1 !important;
    }

    .bg-purple {
        background-color: #6f42c1 !important;
    }

    .border-purple {
        border-color: #6f42c1 !important;
    }

    .spinner-border.text-purple {
        border-color: #6f42c1;
        border-right-color: transparent;
    }

    .timeline-month {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .timeline-month:hover {
        transform: scale(1.1);
        z-index: 10;
    }
    </style>

-->