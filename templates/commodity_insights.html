{% extends "base.html" %}

{% block title %}Insight Komoditas - IPH Monitoring{% endblock %}

{% block content %}
<div class="pb-3 mb-4 border-bottom">
        <h1 class="h2 text-gradient mb-1">
            <i class="fas fa-wheat-awn me-2"></i>
            Insight Komoditas
        </h1>
        <p class="text-muted mb-0">Analisis dampak komoditas terhadap perubahan harga</p>
</div>

<div class="card mb-4 border-0 shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-calendar-week text-primary me-2"></i>Insight Minggu Ini
        </h5>
    </div>
    <div class="card-body">
        <div id="currentWeekInsights">
            <div class="text-center py-4">
                <p class="mt-2 text-muted">Memuat insight minggu ini...</p>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 border-0 shadow-sm">
    <div class="card-header bg-white border-bottom">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-success me-2"></i>
                    Analisis Tren Komoditas
                </h5>
            </div>
            
            <!-- Filter Section (Right Aligned) -->
            <div class="col-md-6">
                <div class="d-flex justify-content-md-end align-items-center gap-2 mt-3 mt-md-0">
                    <!-- Start Period -->
                    <div class="d-flex align-items-center gap-1">
                        <select class="form-select form-select-sm" id="trendStartMonth" style="width: 110px;">
                            <option>Januari</option>
                            <option>Februari</option>
                            <option>Maret</option>
                            <option>April</option>
                            <option>Mei</option>
                            <option>Juni</option>
                            <option>Juli</option>
                            <option>Agustus</option>
                            <option>September</option>
                            <option>Oktober</option>
                            <option>November</option>
                            <option>Desember</option>
                        </select>
                        <select class="form-select form-select-sm" id="trendStartYear" style="width: 80px;">
                            <option>2023</option>
                            <option>2024</option>
                            <option>2025</option>
                        </select>
                    </div>
                    
                    <!-- Separator -->
                    <span class="text-muted fw-bold">â†’</span>
                    
                    <!-- End Period -->
                    <div class="d-flex align-items-center gap-1">
                        <select class="form-select form-select-sm" id="trendEndMonth" style="width: 110px;">
                            <option>Januari</option>
                            <option>Februari</option>
                            <option>Maret</option>
                            <option>April</option>
                            <option>Mei</option>
                            <option>Juni</option>
                            <option>Juli</option>
                            <option>Agustus</option>
                            <option>September</option>
                            <option>Oktober</option>
                            <option>November</option>
                            <option>Desember</option>
                        </select>
                        <select class="form-select form-select-sm" id="trendEndYear" style="width: 80px;">
                            <option>2023</option>
                            <option>2024</option>
                            <option>2025</option>
                        </select>
                    </div>
                    
                    <!-- Apply Button -->
                    <button class="btn btn-sm btn-success" id="applyFiltersBtn">
                        <i class></i>Terapkan
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        <div id="sparklineListContainer">
        </div>
    </div>
</div>


<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body">
        <div class="row">
            <div class="col-lg-8 col-12 mx-auto">
                <div id="rankingChartFreq" style="height: 400px;"></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}


{% block scripts %}
<script>
// =========================================================================
// SCRIPT FINAL INSIGHT KOMODITAS (v9 - Fixed Duplicates & Axis Layouts)
// =========================================================================

const monthMap = {Januari:'01', Februari:'02', Maret:'03', April:'04', Mei:'05', Juni:'06', Juli:'07', Agustus:'08', September:'09', Oktober:'10', November:'11', Desember:'12'};

async function safeApiCall(url) {
    try {
        const response = await fetch(url);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
    } catch (error) {
        console.error("API Error:", error);
        return { success: false, error: error.message };
    }
}

function showLoading(id, msg) {
    const el = document.getElementById(id);
    if(el) el.innerHTML = `<div class="text-center py-5"><div class="spinner-border text-primary mb-2"></div><p class="text-muted small">${msg}</p></div>`;
}

function showError(id, msg) {
    const el = document.getElementById(id);
    if(el) el.innerHTML = `<div class="alert alert-light text-center text-danger border-0 py-4"><i class="fas fa-exclamation-circle fa-2x mb-2"></i><br>${msg}</div>`;
}

function formatCommodityName(name) {
    return name ? String(name).replace(/_/g, ' ').toLowerCase() : '';
}

// Helper untuk memecah teks panjang (Text Wrap)
function wrapText(text, maxLength = 15) {
    if (text.length <= maxLength) return text;
    const words = text.split(' ');
    let lines = [];
    let currentLine = words[0];

    for (let i = 1; i < words.length; i++) {
        if (currentLine.length + 1 + words[i].length <= maxLength) {
            currentLine += ' ' + words[i];
        } else {
            lines.push(currentLine);
            currentLine = words[i];
        }
    }
    lines.push(currentLine);
    return lines.join('<br>');
}

// Helper: Generate Continuous Timeline (Mingguan)
function generateTimeline(minDateStr, maxDateStr) {
    let current = new Date(minDateStr);
    const end = new Date(maxDateStr);
    const dates = [];
    const labels = [];

    // Loop per minggu (7 hari)
    while (current <= end) {
        const dateStr = current.toISOString().split('T')[0];
        dates.push(dateStr);
        
        // Format Label: "April M3" (Hanya Bulan dan Minggu)
        // Logika sederhana: Minggu ke-X dalam bulan
        const monthNames = ["Jan", "Feb", "Mar", "Apr", "Mei", "Jun", "Jul", "Ags", "Sep", "Okt", "Nov", "Des"];
        const month = monthNames[current.getMonth()];
        const day = current.getDate();
        const weekNum = Math.ceil(day / 7);
        
        labels.push(`${month} M${weekNum}`);
        
        current.setDate(current.getDate() + 7);
    }
    return { dates, labels };
}

// --- LOAD ALL INSIGHTS ---
async function loadAllInsights() {
    showLoading('sparklineListContainer', 'Menganalisis tren...');
    
    try {
        const { params, rangeText } = getFilterParams('trend');
        const data = await safeApiCall(`/api/commodity/full-insights?${params.join('&')}`);
        
        if (data.success) {
            if (data.trend_sparkline_data && data.trend_sparkline_data.length > 0) {
                renderTrendBarCharts(data.trend_sparkline_data);
            } else {
                showError('sparklineListContainer', 'Tidak ada data tren pada periode ini.');
            }
            
            if (data.frequency_chart_data && data.frequency_chart_data.x && data.frequency_chart_data.x.length > 0) {
                renderFrequencyChart(data.frequency_chart_data, rangeText);
            } else {
                showError('rankingChartFreq', 'Tidak ada data ranking pada periode ini.');
            }
        } else {
            const msg = data.error || 'Gagal memuat data.';
            showError('sparklineListContainer', msg);
            showError('rankingChartFreq', msg);
        }
    } catch (e) {
        showError('sparklineListContainer', e.message);
        showError('rankingChartFreq', e.message);
    }
}

// --- RENDER TREN (FIXED: Gaps & Custom Axis) ---
function renderTrendBarCharts(trendData) {
    const container = document.getElementById('sparklineListContainer');
    container.innerHTML = ''; 

    // 1. Cari Global Min/Max Date untuk membuat sumbu X yang konsisten
    let allDates = [];
    trendData.forEach(comm => {
        if (comm.chart && comm.chart.x) allDates = allDates.concat(comm.chart.x);
    });
    allDates.sort();
    
    if (allDates.length === 0) return;

    const globalMin = allDates[0];
    const globalMax = allDates[allDates.length - 1];

    // 2. Buat Timeline Kontinu (Mingguan) untuk Axis
    const timeline = generateTimeline(globalMin, globalMax);

    trendData.forEach((comm, index) => {
        const chartId = `trend-chart-${index}`;
        
        const rowHTML = `
            <div class="row align-items-center border-bottom py-3 mx-0">
                <div class="col-3 ps-0">
                    <div class="fw-bold text-dark text-capitalize small text-truncate" title="${formatCommodityName(comm.name)}">
                        ${formatCommodityName(comm.name)}
                        ${index === 0 ? '<i class="fas fa-crown text-warning ms-1"></i>' : ''}
                    </div>
                    <div class="text-muted" style="font-size: 0.7rem;">
                        Muncul <span class="fw-bold text-primary">${comm.frequency}x</span>
                    </div>
                </div>
                <div class="col-9 pe-0">
                    <div id="${chartId}" style="width: 100%; height: 100px;"></div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', rowHTML);

        // 3. Mapping Data ke Timeline (Agar bar berada di posisi yang tepat)
        // Plotly Bar Chart dengan x tipe category akan menampilkan gap jika kategori (tanggal) ada di layout.xaxis but tidak di data trace
        
        const trace = {
            x: comm.chart.x, // Tanggal asli data
            y: comm.chart.y,
            text: comm.chart.text, 
            type: 'bar',
            marker: {
                color: comm.chart.marker_color,
                line: { width: 0 }
            },
            hoverinfo: 'text',
            width: 86400000 * 4 // Lebar bar ~4 hari (dalam milidetik) agar terlihat renggang
        };

        const layout = {
            margin: { t: 10, b: 30, l: 30, r: 10 },
            xaxis: { 
                type: 'date', // Gunakan tipe date agar posisi akurat
                range: [new Date(globalMin).getTime() - 259200000, new Date(globalMax).getTime() + 259200000], // Buffer 3 hari
                tickmode: 'array',
                tickvals: timeline.dates, // Paksa tick muncul di setiap minggu yang kita generate
                ticktext: timeline.labels, // Gunakan label custom (Bulan Minggu)
                showgrid: true,
                gridcolor: '#f8f9fa',
                tickfont: { size: 9, color: '#666' },
                fixedrange: true
            },
            yaxis: { 
                visible: true, 
                showgrid: true, 
                gridcolor: '#f0f0f0',
                fixedrange: true,
                zeroline: true,
                zerolinecolor: '#ccc',
                tickfont: { size: 9 }
            },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            showlegend: false,
            hovermode: 'closest'
        };

        Plotly.newPlot(chartId, [trace], layout, {displayModeBar: false, staticPlot: false, responsive: true});
    });
}

// --- RENDER FREKUENSI (FIXED: Center, Axis Lines, Label Wrapping) ---
function renderFrequencyChart(freqData, rangeText) {
    const container = document.getElementById('rankingChartFreq');
    
    // Wrap label komoditas yang panjang agar tidak terpotong/miring
    const wrappedLabels = freqData.x.map(label => wrapText(label, 12));

    const trace = {
        x: wrappedLabels, // Gunakan label yang sudah di-wrap
        y: freqData.y,
        type: 'bar',
        marker: {
            color: '#667eea',
            opacity: 0.9,
            line: { width: 0 }
        },
        width: 0.4, // Bar lebih ramping
        text: freqData.y.map(v => String(v)),
        textposition: 'auto',
        hoverinfo: 'y'
    };

    const layout = {
        title: {
            text: `<span style="font-size: 12px; color: #999;">Periode: ${rangeText}</span>`,
            font: { size: 14 },
            x: 0.5,
            xanchor: 'center'
        },
        margin: { t: 40, b: 60, l: 50, r: 20 }, // Margin bawah diperbesar untuk label X
        yaxis: { 
            title: 'Frekuensi Muncul',
            titlefont: { size: 11, color: '#888' },
            visible: true,
            showline: true, // FIX: Tampilkan garis sumbu Y
            linecolor: '#ddd',
            showgrid: true,
            gridcolor: '#f5f5f5',
            fixedrange: true
        },
        xaxis: { 
            tickfont: { size: 11 },
            tickangle: 0, // FIX: Paksa horizontal (tidak miring)
            fixedrange: true,
            showline: true,
            linecolor: '#ddd'
        },
        paper_bgcolor: 'rgba(0,0,0,0)',
        plot_bgcolor: 'rgba(0,0,0,0)',
        showlegend: false,
        autosize: true
    };

    Plotly.newPlot(container, [trace], layout, {displayModeBar: false, responsive: true});
}

// --- FILTER & INIT ---
function getFilterParams(prefix) {
    const smEl = document.getElementById(`${prefix}StartMonth`);
    const syEl = document.getElementById(`${prefix}StartYear`);
    const emEl = document.getElementById(`${prefix}EndMonth`);
    const eyEl = document.getElementById(`${prefix}EndYear`);

    if (!smEl) return { params: ['periods=999'], rangeText: 'Default' };

    const sm = smEl.value, sy = syEl.value, em = emEl.value, ey = eyEl.value;
    let params = ['periods=999'];
    
    if (monthMap[sm] && monthMap[em]) {
        params.push(`start_key=${sy}-${monthMap[sm]}`);
        params.push(`end_key=${ey}-${monthMap[em]}`);
        return { params, rangeText: `${sm} ${sy} - ${em} ${ey}` };
    }
    return { params, rangeText: 'Semua Data' };
}

async function initDefaults() {
    try {
        const json = await safeApiCall('/api/data/available-periods');
        if (json.success && json.periods.length > 0) {
            const last = json.periods[json.periods.length - 1];
            const prev = json.periods[Math.max(0, json.periods.length - 3)];
            
            const getMonthName = (num) => Object.keys(monthMap).find(key => monthMap[key] === String(num).padStart(2,'0'));
            
            const startM = getMonthName(prev.month);
            const endM = getMonthName(last.month);
            
            if(document.getElementById('trendStartMonth')) {
                document.getElementById('trendStartMonth').value = startM || 'Januari';
                document.getElementById('trendStartYear').value = prev.year;
                document.getElementById('trendEndMonth').value = endM || 'Januari';
                document.getElementById('trendEndYear').value = last.year;
            }
        }
    } catch (e) {}
    loadAllInsights();
}

// --- INSIGHT MINGGU INI ---
async function loadCurrentWeekInsights() {
    const containerId = 'currentWeekInsights';
    showLoading(containerId, 'Memuat...');
    const data = await safeApiCall('/api/commodity/current-week');
    if (data.success && data.iph_analysis) {
         document.getElementById(containerId).innerHTML = renderPrettyInsight(data); 
    } else {
        showError(containerId, 'Data minggu ini belum tersedia.');
    }
}

function renderPrettyInsight(data) {
    const iph = data.iph_analysis;
    const comms = data.commodity_impacts;
    const period = data.period;
    
    let displayYear = period.tahun || new Date().getFullYear();
    if (!period.tahun && period.tanggal) {
        displayYear = new Date(period.tanggal).getFullYear();
    }

    const isInflation = iph.value > 0;
    const colorClass = isInflation ? 'danger' : (iph.value < 0 ? 'success' : 'secondary');
    const trendIcon = isInflation ? 'fa-arrow-trend-up' : (iph.value < 0 ? 'fa-arrow-trend-down' : 'fa-minus');
    const trendText = isInflation ? 'Inflasi' : (iph.value < 0 ? 'Deflasi' : 'Stabil');

    // Format komoditas untuk card atas
    const renderCommList = (list, typeColor, sign) => {
        if (!list || list.length === 0) return '';
        return list.slice(0, 3).map(c => `
            <div class="col-md-6 col-12 mb-2">
                <div class="d-flex justify-content-between align-items-center p-2 rounded bg-${typeColor} bg-opacity-10 border border-${typeColor} border-opacity-25">
                    <span class="small fw-medium text-dark text-capitalize">${formatCommodityName(c.name)}</span>
                    <span class="badge bg-${typeColor}">${sign}${Math.abs(c.impact).toFixed(2)}%</span>
                </div>
            </div>`).join('');
    };

    return `
        <div class="row g-0 align-items-center">
            <div class="col-md-4 text-center p-4 border-end border-light">
                <h6 class="text-muted text-uppercase small mb-1">${period.kota || 'KOTA BATU'}</h6>
                <h5 class="fw-bold mb-3">
                    <span class="badge bg-light text-dark border me-1">${period.minggu || ''}</span> 
                    ${period.bulan || ''} ${displayYear}
                </h5>
                <div class="display-4 fw-bold text-${colorClass} mb-0">${iph.value > 0 ? '+' : ''}${iph.value.toFixed(2)}%</div>
                <div class="badge bg-${colorClass} bg-opacity-10 text-${colorClass} px-3 py-2 mt-2 rounded-pill">
                    <i class="fas ${trendIcon} me-1"></i> ${trendText}
                </div>
            </div>
            <div class="col-md-8 p-4">
                <h6 class="fw-bold mb-3 text-secondary"><i class="fas fa-list-ul me-2"></i>Komoditas Berpengaruh</h6>
                <div class="row">
                    ${renderCommList(comms.significant_positive, 'danger', '+')}
                    ${renderCommList(comms.significant_negative, 'success', '-')}
                    ${(comms.significant_positive.length === 0 && comms.significant_negative.length === 0) ? 
                      '<div class="col-12 text-muted small text-center fst-italic mt-2">Tidak ada gejolak komoditas signifikan minggu ini.</div>' : ''}
                </div>
            </div>
        </div>
    `;
}

document.addEventListener('DOMContentLoaded', function() {
    loadCurrentWeekInsights();
    initDefaults();
    document.getElementById('applyFiltersBtn')?.addEventListener('click', () => loadAllInsights());
});
</script>
{% endblock %}