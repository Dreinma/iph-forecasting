{% extends "base.html" %}

{% block title %}Insight Komoditas - IPH Monitoring{% endblock %}

{% block content %}
<div class="pb-3 mb-4 border-bottom">
        <h1 class="h2 text-gradient mb-1">
            <i class="fas fa-wheat-awn me-2"></i>
            Insight Komoditas
        </h1>
        <p class="text-muted mb-0">Analisis dampak komoditas terhadap perubahan harga</p>
</div>

<div class="card mb-4 border-0 shadow-sm">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
            <i class="fas fa-calendar-week text-primary me-2"></i>Insight Minggu Ini
        </h5>
    </div>
    <div class="card-body">
        <div id="currentWeekInsights">
            <div class="text-center py-4">
                <p class="mt-2 text-muted">Memuat insight minggu ini...</p>
            </div>
        </div>
    </div>
</div>

<div class="card mb-4 border-0 shadow-sm">
    <div class="card-header bg-white border-bottom">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-line text-success me-2"></i>
                    Analisis Tren Komoditas
                </h5>
            </div>
            
            <!-- Filter Section (Right Aligned) -->
            <div class="col-md-6">
                <div class="d-flex justify-content-md-end align-items-center gap-2 mt-3 mt-md-0">
                    <!-- Start Period -->
                    <div class="d-flex align-items-center gap-1">
                        <select class="form-select form-select-sm" id="trendStartMonth" style="width: 110px;">
                            <option>Januari</option>
                            <option>Februari</option>
                            <option>Maret</option>
                            <option>April</option>
                            <option>Mei</option>
                            <option>Juni</option>
                            <option>Juli</option>
                            <option>Agustus</option>
                            <option>September</option>
                            <option>Oktober</option>
                            <option>November</option>
                            <option>Desember</option>
                        </select>
                        <select class="form-select form-select-sm" id="trendStartYear" style="width: 80px;">
                            <option>2023</option>
                            <option>2024</option>
                            <option>2025</option>
                        </select>
                    </div>
                    
                    <!-- Separator -->
                    <span class="text-muted fw-bold">‚Üí</span>
                    
                    <!-- End Period -->
                    <div class="d-flex align-items-center gap-1">
                        <select class="form-select form-select-sm" id="trendEndMonth" style="width: 110px;">
                            <option>Januari</option>
                            <option>Februari</option>
                            <option>Maret</option>
                            <option>April</option>
                            <option>Mei</option>
                            <option>Juni</option>
                            <option>Juli</option>
                            <option>Agustus</option>
                            <option>September</option>
                            <option>Oktober</option>
                            <option>November</option>
                            <option>Desember</option>
                        </select>
                        <select class="form-select form-select-sm" id="trendEndYear" style="width: 80px;">
                            <option>2023</option>
                            <option>2024</option>
                            <option>2025</option>
                        </select>
                    </div>
                    
                    <!-- Apply Button -->
                    <button class="btn btn-sm btn-success" id="applyFiltersBtn">
                        <i class></i>Terapkan
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-body">
        <div id="sparklineListContainer">
        </div>
    </div>
</div>


<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body">
        <div class="row g-4">
            <div class="col-lg-6 col-12">
                <h6 class="text-center">Top 5 Paling Sering Muncul (Frekuensi)</h6>
                <div id="rankingChartFreq" style="height: 350px;"></div>
            </div>
        </div>
    </div>
</div>

{% endblock %}


{% block scripts %}
<script>

// --- 1. FUNGSI API & HELPER ---

const monthMap = {Januari:'01', Februari:'02', Maret:'03', April:'04', Mei:'05', Juni:'06', Juli:'07', Agustus:'08', September:'09', Oktober:'10', November:'11', Desember:'12'};

async function safeApiCall(url) {
    try {
        console.log(`üåê Memanggil API: ${url}`);
        const response = await fetch(url, {
            headers: { 'Accept': 'application/json' }
        });
        
        if (!response.ok) throw new Error(`HTTP Error: ${response.status}`);
        const data = await response.json();
        console.log(`‚úÖ Sukses API: ${url}`, data); // Debugging point
        return data;
    } catch (error) {
        console.error(`‚ùå Error API: ${url}`, error);
        return { success: false, error: error.message };
    }
}

function formatCommodityName(rawName) {
    if (!rawName) return '';
    try {
        return String(rawName).replace(/_/g, ' ').toLowerCase();
    } catch (_) {
        return rawName;
    }
}

function showError(containerId, message, onRetryFunction = null) {
    const container = document.getElementById(containerId);
    if (container) {
        const retryButton = onRetryFunction
            ? `<button class="btn btn-outline-danger btn-sm mt-2" onclick="${onRetryFunction}"><i class="fas fa-redo me-1"></i>Coba Lagi</button>`
            : '';
        container.innerHTML = `
            <div class="alert alert-danger border-0">
                <div class="d-flex align-items-start">
                    <div class="me-3"><i class="fas fa-exclamation-triangle fa-lg"></i></div>
                    <div>
                        <h6 class="mb-1">Error</h6>
                        <small>${message}</small>
                        ${retryButton}
                    </div>
                </div>
            </div>`;
    }
}

// --- 2. FUNGSI RENDER (INSIGHT MINGGU INI) ---

async function loadCurrentWeekInsights() {
    console.log('üìÖ Memuat Insight Minggu Ini...');
    const containerId = 'currentWeekInsights';
    
    try {
        const data = await safeApiCall('/api/commodity/current-week');
        if (data.success && data.iph_analysis) {
            document.getElementById(containerId).innerHTML = renderPrettyInsight(data);
        } else {
            showError(containerId, data.message || 'Data minggu ini tidak tersedia.', 'loadCurrentWeekInsights()');
        }
    } catch (error) {
        showError(containerId, error.message, 'loadCurrentWeekInsights()');
    }
}

function renderPrettyInsight(data) {
    const iph = data.iph_analysis;
    const comms = data.commodity_impacts;
    const period = data.period;
    
    let displayYear = period.tahun; 
    
    if (!displayYear && period.tanggal) {
        const d = new Date(period.tanggal);
        if (!isNaN(d.getFullYear())) {
            displayYear = d.getFullYear();
        }
    }
    
    if (!displayYear && period.bulan && typeof period.bulan === 'string') {
        const match = period.bulan.match(/'(\d{2})/);
        if (match) {
            displayYear = '20' + match[1];
        }
    }
    
    if (!displayYear) {
        displayYear = new Date().getFullYear();
    }
    
    const isInflation = iph.value > 0;
    const colorClass = isInflation ? 'danger' : (iph.value < 0 ? 'success' : 'secondary');
    const trendIcon = isInflation ? 'fa-arrow-trend-up' : (iph.value < 0 ? 'fa-arrow-trend-down' : 'fa-minus');

    return `
        <div class="row g-0 align-items-center">
            <div class="col-md-4 text-center p-4 border-end border-light">
                <h6 class="text-muted text-uppercase small mb-1">${period.kota || 'KOTA BATU'}</h6>
                <h5 class="fw-bold mb-3"><span class="badge bg-light text-dark border">${period.minggu}</span> ${period.bulan} ${displayYear} </h5>
                
                <div class="display-4 fw-bold text-${colorClass} mb-0">
                    ${iph.value > 0 ? '+' : ''}${iph.value.toFixed(2)}%
                </div>
            </div>

            <div class="col-md-8 p-4">
                <h6 class="fw-bold mb-3"><i class="fas fa-list-ul me-2 text-muted"></i>Komoditas Berpengaruh</h6>
                
                <div class="row g-2">
                    ${comms.significant_positive.slice(0, 3).map(c => `
                        <div class="col-6">
                            <div class="d-flex justify-content-between align-items-center p-2 rounded bg-danger bg-opacity-10 border border-danger border-opacity-25">
                                <span class="small fw-medium text-dark">${formatCommodityName(c.name)}</span>
                                <span class="badge bg-danger">+${c.impact.toFixed(2)}%</span>
                            </div>
                        </div>
                    `).join('')}

                    ${comms.significant_negative.slice(0, 3).map(c => `
                        <div class="col-6">
                            <div class="d-flex justify-content-between align-items-center p-2 rounded bg-success bg-opacity-10 border border-success border-opacity-25">
                                <span class="small fw-medium text-dark">${formatCommodityName(c.name)}</span>
                                <span class="badge bg-success">${c.impact.toFixed(2)}%</span>
                            </div>
                        </div>
                    `).join('')}

                    ${(comms.significant_positive.length === 0 && comms.significant_negative.length === 0) ? 
                        '<div class="col-12 text-muted small text-center fst-italic">Tidak ada gejolak komoditas signifikan.</div>' : ''}
                </div>
            </div>
        </div>
    `;
}


// --- 3. FUNGSI RENDER GABUNGAN (TREN & TOP 5) ---

async function loadAllInsights() {
    console.log('üîÑ Memuat Semua Insight Komoditas...');
    
    try {
        const { params, rangeText } = getFilterParams('trend'); // Ambil filter dari card Tren
        
        if (params.length < 3) { // Membutuhkan periods, start_key, end_key
            console.warn("Parameter filter kosong, menunggu init...");
            return; 
        }

        const data = await safeApiCall(`/api/commodity/full-insights?${params.join('&')}`);
        
        if (data.success) {
            // Render Card 1: Tren Sparkline
            if (data.trend_sparkline_data && data.trend_sparkline_data.length > 0) {
                renderTrendBarCharts(data.trend_sparkline_data);
            } else {
                showError('sparklineListContainer', 'Tidak ada data tren untuk periode ini.', 'loadAllInsights()');
            }
            
            // Render Top 5 Frekuensi
            if (data.frequency_chart_data && data.frequency_chart_data.x && data.frequency_chart_data.x.length > 0) {
                renderFrequencyChart(data.frequency_chart_data, rangeText);
            } else {
                showError('rankingChartFreq', 'Tidak ada data frekuensi untuk periode ini.', 'loadAllInsights()');
            }
            
        } else {
            const errorMsg = data.error || 'Gagal memuat data insight';
            showError('sparklineListContainer', errorMsg, 'loadAllInsights()');
            showError('rankingChartFreq', errorMsg, 'loadAllInsights()');
        }
    } catch (error) {
        showError('sparklineListContainer', error.message, 'loadAllInsights()');
        showError('rankingChartFreq', error.message, 'loadAllInsights()');
    }
}

function renderTrendBarCharts(trendData) {
const container = document.getElementById('sparklineListContainer');
    container.innerHTML = ''; // Hapus loading

    trendData.forEach((comm, index) => {
        const chartId = `trend-chart-${index}`;
        
const rowHTML = `
            <div class="row align-items-center border-bottom py-3 mx-0 hover-bg-light">
                <div class="col-4 col-md-3">
                    <div class="d-flex align-items-center">
                        <div class="me-2 fw-bold text-dark text-capitalize">${formatCommodityName(comm.name)}</div>
                        ${index === 0 ? '<i class="fas fa-crown text-warning"></i>' : ''}
                    </div>
                    <div class="small text-muted mt-1">
                        Muncul <span class="fw-bold text-primary">${comm.frequency}x</span>
                    </div>
                </div>
                <div class="col-8 col-md-9">
                    <div id="${chartId}" style="width: 100%; height: 80px;"></div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', rowHTML);

        // Data Plotly Bar Chart
        const trace = {
            x: comm.chart.x,
            y: comm.chart.y,
            text: comm.chart.text, // Custom tooltip (Bulan/Minggu)
            type: 'bar',
            marker: {
                color: comm.chart.marker_color, // Warna dinamis (+/-)
                opacity: 0.8
            },
            hoverinfo: 'text' // Hanya tampilkan teks custom
        };

        const layout = {
            margin: { t: 5, b: 20, l: 30, r: 10 }, // Beri sedikit ruang kiri untuk skala
            xaxis: { 
                visible: true, 
                fixedrange: true,
                tickfont: { size: 10 },
                showticklabels: true
            },
            yaxis: { 
                visible: true, 
                showgrid: true, 
                zeroline: true,
                zerolinecolor: '#999',
                gridcolor: '#eee',
                fixedrange: true
            },
            paper_bgcolor: 'rgba(0,0,0,0)',
            plot_bgcolor: 'rgba(0,0,0,0)',
            hovermode: 'closest',
            showlegend: false,
            bargap: 0.3
        };

        Plotly.newPlot(chartId, [trace], layout, {
            responsive: true, 
            displayModeBar: false,
            staticPlot: false // Interaktif untuk hover
        });
    });
}
 
function renderFrequencyChart(freqData, rangeText) {
    const container = document.getElementById('rankingChartFreq');    
    const trace = {
        x: freqData.x,
        y: freqData.y,
        type: 'bar',
        marker: {
            color: '#4361ee', // Warna biru modern
            opacity: 0.9,
            line: { width: 0 }
        },
        text: freqData.y.map(v => String(v)), // Tampilkan angka di atas bar
        textposition: 'auto',
        hoverinfo: 'x+y'
    };

    const layout = {
        title: {
            text: `<span style="font-size: 0.8em; color: #6c757d;">(${rangeText})</span>`,
            font: { size: 16 }, x: 0.5, xanchor: 'center'
        },
        yaxis: { title: 'Jumlah Kemunculan' },
        xaxis: { title: 'Komoditas' },
        margin: { t: 60, b: 50, l: 50, r: 20 },
        hovermode: 'closest',
        showlegend: false
    };

    Plotly.newPlot(container, [trace], layout, {responsive: true, displayModeBar: false});
}

// --- 4. FUNGSI UTAMA (SETUP DAN INISIALISASI) ---

function getFilterParams(prefix) {
    // monthMap sudah global
    const smEl = document.getElementById(`${prefix}StartMonth`);
    const syEl = document.getElementById(`${prefix}StartYear`);
    const emEl = document.getElementById(`${prefix}EndMonth`);
    const eyEl = document.getElementById(`${prefix}EndYear`);

    // Default values jika elemen belum load atau error
    if (!smEl) return { params: ['periods=999'], rangeText: 'Default' };

    const sm = smEl.value;
    const sy = syEl.value;
    const em = emEl.value;
    const ey = eyEl.value;
    
    let params = ['periods=999'];
    
    if (monthMap[sm] && monthMap[em]) {
        params.push(`start_key=${sy}-${monthMap[sm]}`);
        params.push(`end_key=${ey}-${monthMap[em]}`);
        return { 
            params, 
            rangeText: `${sm} ${sy} - ${em} ${ey}` 
        };
    }
    
    return { params, rangeText: 'Semua Data' };
}

function validateDateRange(smElId, syElId, emElId, eyElId, containerId) {
    // monthMap sudah global
    const smEl = document.getElementById(smElId);
    const syEl = document.getElementById(syElId);
    const emEl = document.getElementById(emElId);
    const eyEl = document.getElementById(eyElId);
    
    if (!smEl || !syEl || !emEl || !eyEl) return false; 
    
    const sm = smEl.value;
    const sy = syEl.value;
    const em = emEl.value;
    const ey = eyEl.value;
    
    if (sm && sy && em && ey && monthMap[sm] && monthMap[em]) { 
        const startYm = parseInt(`${sy}${monthMap[sm]}`);
        const endYm = parseInt(`${ey}${monthMap[em]}`);
        
        if (startYm > endYm) {
            showError(containerId, 'Rentang Waktu Tidak Valid: Tanggal mulai harus lebih awal dari tanggal akhir.');
            [smEl, syEl, emEl, eyEl].forEach(el => { if (el) el.classList.add('is-invalid'); });
            setTimeout(() => { [smEl, syEl, emEl, eyEl].forEach(el => { if (el) el.classList.remove('is-invalid'); }); }, 2000);
            return false;
        }
    }
    return true;
}

async function initDefaults() {
    try {
        const json = await safeApiCall('/api/data/available-periods');
        if (json.success && json.periods.length > 0) {
            const last = json.periods[json.periods.length - 1];
            const prev = json.periods[Math.max(0, json.periods.length - 3)];
            
            const getMonthName = (num) => Object.keys(monthMap).find(key => monthMap[key] === String(num).padStart(2,'0'));

            const startM = getMonthName(prev.month);
            const endM = getMonthName(last.month);
            
            // Set nilai dropdown
            ['trendStartMonth'].forEach(id => document.getElementById(id).value = startM || 'Januari');
            ['trendStartYear'].forEach(id => document.getElementById(id).value = prev.year);
            ['trendEndMonth'].forEach(id => document.getElementById(id).value = endM || 'Januari');
            ['trendEndYear'].forEach(id => document.getElementById(id).value = last.year);
        }
    } catch (e) { console.error(e); }
    
    loadAllInsights();
}

async function checkCommodityDataAvailability() {
    try {
        const data = await safeApiCall('/api/commodity/data-status');
        if (!data.success || !data.has_data) {
            console.warn('Tidak ada data komoditas ditemukan.');
        }
    } catch (error) {
        console.log('Could not check data availability:', error);
    }
}

// --- 6. INISIALISASI HALAMAN ---

document.addEventListener('DOMContentLoaded', function() {
    console.log('üöÄ Halaman Insight Komoditas Dimuat');
    
    checkCommodityDataAvailability();

    // 1. Load Insight Minggu Ini (Independen)
    loadCurrentWeekInsights();

    // 2. Init Dropdown -> Lalu Load Charts
    initDefaults();
    
    // 3. Event Listener Tombol Terapkan
    document.getElementById('applyFiltersBtn')?.addEventListener('click', () => {        console.log('‚è∞ Auto-refreshing commodity insights...');
        loadAllInsights();
    });
});

</script>

    <style>
    .text-purple {
        color: #6f42c1 !important;
    }

    .bg-purple {
        background-color: #6f42c1 !important;
    }

    .border-purple {
        border-color: #6f42c1 !important;
    }

    .spinner-border.text-purple {
        border-color: #6f42c1;
        border-right-color: transparent;
    }

    .timeline-month {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .timeline-month:hover {
        transform: scale(1.1);
        z-index: 10;
    }

    /* Tren Komoditas Card Enhancements */
    .card-header .form-select-sm {
        border-color: #dee2e6;
        transition: all 0.2s ease;
    }

    .card-header .form-select-sm:focus {
        border-color: #198754;
        box-shadow: 0 0 0 0.2rem rgba(25, 135, 84, 0.25);
    }

    #applyFiltersBtn {
        min-width: 100px;
        transition: all 0.2s ease;
    }

    #applyFiltersBtn:hover {
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(25, 135, 84, 0.3);
    }

    /* Sparkline Container Animation */
    .card.border-warning {
        animation: pulse-border 2s ease-in-out infinite;
    }

    @keyframes pulse-border {
        0%, 100% { border-color: #ffc107; }
        50% { border-color: #ffca2c; }
    }

    /* Rank Badge */
    .bg-success.bg-opacity-10 {
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .card-header .col-md-6 {
            text-align: center;
        }
        
        .d-flex.gap-2 {
            flex-wrap: wrap;
            justify-content: center !important;
        }
        
        .form-select-sm {
            width: auto !important;
        }
    }

    </style>

{% endblock %}